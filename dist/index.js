/*! For license information please see index.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("ua-parser-js"));else if("function"==typeof define&&define.amd)define(["ua-parser-js"],t);else{var n="object"==typeof exports?t(require("ua-parser-js")):t(e["ua-parser-js"]);for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(self,(e=>(()=>{"use strict";var t={555:(e,t,n)=>{t.TG=void 0;n(620),n(155);t.TG=function(e){var t=Date.parse(e);return isNaN(t)&&(t=function(e){var t,n=/^(\d{4}-\d\d-\d\d([tT][\d:.]*)?)([zZ]|([+-])(\d\d):?(\d\d))?$/.exec(e)||[];if(n[1]){if((t=n[1].split(/\D/).map((function(e){return parseInt(e,10)||0})))[1]-=1,!(t=new Date(Date.UTC.apply(Date,t))).getDate())return NaN;if(n[5]){var o=60*parseInt(n[5],10);n[6]&&(o+=parseInt(n[6],10)),"+"===n[4]&&(o*=-1),o&&t.setUTCMinutes(t.getUTCMinutes()+o)}return t.getTime()}return NaN}(e)),new Date(t)}},155:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimeInMinutes=t.getTimeInMilliseconds=t.getTimeInSeconds=t.padDateTimeUnit=void 0,t.padDateTimeUnit=function(e){var t=Math.abs(Math.floor("string"==typeof e?Number(e):e));return(t<10?"0":"")+t},t.getTimeInSeconds=function(e){var t=e.hours,n=void 0===t?0:t,o=e.minutes,r=void 0===o?0:o,s=e.seconds;return 60*n*60+60*r+(void 0===s?0:s)},t.getTimeInMilliseconds=function(e){var n=e.hours,o=void 0===n?0:n,r=e.minutes,s=void 0===r?0:r,i=e.seconds,a=void 0===i?0:i,c=e.milliseconds,u=void 0===c?0:c;return 1e3*(0,t.getTimeInSeconds)({hours:o,minutes:s,seconds:a})+u},t.getTimeInMinutes=function(e){var n=e.hours,o=void 0===n?0:n,r=e.minutes,s=void 0===r?0:r,i=e.seconds,a=void 0===i?0:i;return(0,t.getTimeInSeconds)({hours:o,minutes:s,seconds:a})/60}},620:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimezoneISOOffset=void 0;var o=n(155);t.getTimezoneISOOffset=function(e){void 0===e&&(e=new Date);var t=e.getTimezoneOffset();return"".concat(t>0?"-":"+").concat((0,o.padDateTimeUnit)(t/60),":").concat((0,o.padDateTimeUnit)(t%60))}},10:(e,t)=>{t.C=void 0,t.C=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},802:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LogLevels=void 0,(n=t.LogLevels||(t.LogLevels={})).ERROR="error",n.INFO="info",n.WARN="warn"},383:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventTargetPolyfill=void 0;var n=function(){function e(){this.listeners={}}return e.prototype.addEventListener=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){if(e in this.listeners)for(var n=this.listeners[e],o=0,r=n.length;o<r;o++)if(n[o]===t)return void n.splice(o,1)},e.prototype.dispatchEvent=function(e){if(!(e.type in this.listeners))return!0;for(var t=this.listeners[e.type].slice(),n=0,o=t.length;n<o;n++)t[n].call(this,e);return!e.defaultPrevented},e}();t.EventTargetPolyfill=n},172:(e,t,n)=>{t.nF=void 0;n(547),n(383),n(272);var o=n(402);Object.defineProperty(t,"nF",{enumerable:!0,get:function(){return o.WebSocketClientEvent}})},720:function(e,t,n){var o=this&&this.__assign||function(){return o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)},r=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.getPushUpdateWebSocket=t.setupSocketConnection=void 0;var s=n(892),i=n(734),a=n(521),c=n(272),u=null,d={forceSecureProtocol:!1,heartbeatAfterAuthorize:!1,maxRetries:20,maxReconnectionDelay:1e3};t.setupSocketConnection=function(e,t){if(void 0===t&&(t={}),"object"!=typeof t)throw new TypeError("Options parameter must be an object not a ".concat(typeof t));var n=o(o({},d),t),l=n.forceSecureProtocol,h=n.heartbeatAfterAuthorize,E=n.tenantId,f=n.userId,v=n.brandId,_=r(n,["forceSecureProtocol","heartbeatAfterAuthorize","tenantId","userId","brandId"]),T=function(e,t,n){void 0===n&&(n={});var o=(0,s.createQueryParametersAsString)((0,a.removeEmptyValuesFromObject)(n)),r=t||"https:"===window.location.protocol?"wss:":"ws:";return 0===o.length?"".concat(r,"//").concat(e):new URL("".concat(r,"//").concat(e)).search.length>0?"".concat(r,"//").concat(e,"&").concat(o):"".concat(r,"//").concat(e,"?").concat(o)}(e,l,{tenantId:E,userId:f,brandId:v});return u=new c.WebSocketClient(T,void 0,_),(0,i.initializeHeartbeat)(h,u,t),u},t.getPushUpdateWebSocket=function(){return u}},547:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.HeartBeatState=void 0,(n=t.HeartBeatState||(t.HeartBeatState={})).DIED="died",n.DYING="dying",n.LIVING="living"},906:function(e,t){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},o=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(o=s.next()).done;)i.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i},r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var o,r=0,s=t.length;r<s;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.ReconnectingWebSocket=void 0;var s={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},i=function(){function e(e,t,n){void 0===n&&(n={});var o=this;this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._listeners={error:[],message:[],open:[],close:[]},this._shouldReconnect=!0,this._connectLock=!1,this._closeCalled=!1,this._messageQueue=[],this._retryCount=-1,this._binaryType="blob",this._handleOpen=function(e){o._debug("open event");var t=o._options.minUptime,n=void 0===t?s.minUptime:t;clearTimeout(o._connectTimeout),o._uptimeTimeout=window.setTimeout((function(){return o._acceptOpen()}),n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach((function(e){var t;return null===(t=o._ws)||void 0===t?void 0:t.send(e)})),o._messageQueue=[],o.onopen&&o.onopen(e),o._listeners.open.forEach((function(t){return o._callEventListener(e,t)}))},this._handleMessage=function(e){o._debug("message event"),o.onmessage&&o.onmessage(e),o._listeners.message.forEach((function(t){return o._callEventListener(e,t)}))},this._handleError=function(e){o._debug("error event",e),o._disconnect(),o.onerror&&o.onerror(e),o._debug("exec error listeners"),o._listeners.error.forEach((function(t){return o._callEventListener(e,t)})),o._connect()},this._handleClose=function(e){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(e),o._listeners.close.forEach((function(t){return o._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._maxRetries="number"==typeof n.maxRetries?n.maxRetries:s.maxRetries,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?WebSocket.CLOSED:WebSocket.CONNECTING},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!1,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==WebSocket.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==WebSocket.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===WebSocket.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?s.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,o,r=this._listeners[e.type];if(r)try{for(var s=n(r),i=s.next();!i.done;i=s.next()){var a=i.value;this._callEventListener(e,a)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(o=s.return)&&o.call(s)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype.setMaxRetires=function(e){this._maxRetries=e},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,r(["RWS>"],o(e),!1))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?s.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?s.minReconnectionDelay:o,i=e.maxReconnectionDelay,a=void 0===i?s.maxReconnectionDelay:i,c=0;return this._retryCount>0&&(c=r*Math.pow(n,this._retryCount-1))>a&&(c=a),this._debug("next delay",c),c},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(void 0!==t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options.connectionTimeout,n=void 0===t?s.connectionTimeout:t;this._retryCount>=this._maxRetries?this._debug("max retries reached",this._retryCount,">=",this._maxRetries):(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled?e._connectLock=!1:(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new WebSocket(t,e._protocols):new WebSocket(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=window.setTimeout((function(){return e._handleTimeout()}),n))})).catch((function(t){e._connectLock=!1,e._handleError(new ErrorEvent(t.message))})))}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ErrorEvent("TIMEOUT"))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new CloseEvent("CLOSE",{code:e,reason:t}))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();t.ReconnectingWebSocket=i},272:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=t.HEART_BEAT_CHECK_TIMEOUT=t.HEART_BEAT_INTERVAL=void 0;var s=n(802),i=n(906),a=n(383),c=n(547),u=n(402);t.HEART_BEAT_INTERVAL=15e3,t.HEART_BEAT_CHECK_TIMEOUT=3*t.HEART_BEAT_INTERVAL;var d=function(e){function n(n,o,r){var a=e.call(this)||this;return a.heartBeatTimeout=null,a.heartBeatCheckTimeout=null,a.enableDebugMode=function(){a.debugMode||a.log(s.LogLevels.INFO,"websocket-push-updates--loggerEnabled"),a.debugMode=!0},a.disableDebugMode=function(){a.debugMode=!1},a.log=function(e,t,n){a.debugMode&&a.logger&&a.logger[e](t,n)},a.sendHeartBeat=function(){a.log(s.LogLevels.INFO,"websocket-push-updates--sendHeartBeat"),a.send(JSON.stringify({action:"heartbeat"}))},a.handleHeartBeatResponse=function(){a.heartBeatState===c.HeartBeatState.DYING&&(a.heartBeatState=c.HeartBeatState.LIVING,a.dispatchHeartBeatState()),a.setHeartBeatCheckTimeout()},a.setHeartBeatCheckTimeout=function(){null!==a.heartBeatCheckTimeout&&clearTimeout(a.heartBeatCheckTimeout),a.heartBeatCheckTimeout=setTimeout((function(){a.heartBeatState=c.HeartBeatState.DYING,a.dispatchHeartBeatState()}),t.HEART_BEAT_CHECK_TIMEOUT)},a.dispatchHeartBeatState=function(){a.log(s.LogLevels.INFO,"websocket-push-updates--dispatchHeartBeatState",[{heartbeatState:a.heartBeatState}]),null!==a.heartBeatState&&a.dispatchEvent(new CustomEvent(a.heartBeatState))},a.isHeartBeatActive=function(){return null!==a.heartBeatState},a.heartBeatState=null,a.debugMode=!1,a.socket=new i.ReconnectingWebSocket(n,o,r),a.socket.onopen=function(){a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.OPEN))},(null==r?void 0:r.logger)&&(a.logger=r.logger),a.socket.onclose=function(e){a.socket.retryCount===(null==r?void 0:r.maxRetries)?a.heartBeatState=c.HeartBeatState.DIED:a.heartBeatState=c.HeartBeatState.DYING,a.dispatchHeartBeatState(),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.CLOSE,{detail:e}))},a.socket.onmessage=function(e){a.handleHeartBeatResponse(),"pong"!==JSON.parse(e.data)&&(a.log(s.LogLevels.INFO,"websocket-push-updates--onmessage",[e]),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.MESSAGE,{detail:e})))},a.socket.onerror=function(e){a.log(s.LogLevels.ERROR,"websocket-push-updates--onError",[e]),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.ERROR,{detail:e}))},a}return r(n,e),n.prototype.send=function(e){this.socket.send(e)},n.prototype.startHeartBeat=function(){var e=this;this.log(s.LogLevels.INFO,"websocket-push-updates--startHeartBeat",[{interval:t.HEART_BEAT_INTERVAL}]);var n=function(){e.log(s.LogLevels.INFO,"websocket-push-updates--heartBeatCallback"),e.sendHeartBeat(),e.heartBeatTimeout=setTimeout(n,t.HEART_BEAT_INTERVAL)};this.setHeartBeatCheckTimeout(),n(),this.heartBeatState=c.HeartBeatState.LIVING},n.prototype.stopHeartBeat=function(){this.log(s.LogLevels.INFO,"websocket-push-updates--stopHeartBeat"),null!==this.heartBeatTimeout&&clearTimeout(this.heartBeatTimeout),null!==this.heartBeatCheckTimeout&&clearTimeout(this.heartBeatCheckTimeout),this.heartBeatState=null},n}(a.EventTargetPolyfill);t.WebSocketClient=d},402:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClientEvent=void 0,(n=t.WebSocketClientEvent||(t.WebSocketClientEvent={})).CLOSE="close",n.ERROR="error",n.MESSAGE="message",n.OPEN="open",n.AUTHORIZATION_FAILED="authorizationFailed"},734:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.initializeHeartbeat=void 0;var o=n(402);t.initializeHeartbeat=function(e,t,n){if(e){var r=function(e){var s;try{var i=JSON.parse(e.detail.data);"authorized"===(null==i?void 0:i.authorizationStatus)&&(t.startHeartBeat(),t.removeEventListener(o.WebSocketClientEvent.MESSAGE,r))}catch(e){null===(s=null==n?void 0:n.logger)||void 0===s||s.warn("JSON cannot be parsed during the heartbeat initialization process.")}};t.addEventListener(o.WebSocketClientEvent.MESSAGE,r)}else t.startHeartBeat()}},521:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeEmptyValuesFromObject=void 0,t.removeEmptyValuesFromObject=function(e){return Object.entries(e).filter((function(e){return e[0],null!=e[1]})).reduce((function(e,t){var n=t[0],o=t[1];return e[n]=o,e}),{})}},892:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createQueryParametersAsString=void 0,t.createQueryParametersAsString=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},668:(e,t)=>{var n;(n=t.V||(t.V={})).CHAT_WINDOW_EVENT="chatWindowEvent",n.REGISTER="register"},482:(e,t)=>{var n,o;(o=t.ow||(t.ow={})).SENDER_TYPING_STARTED="SenderTypingStarted",o.SENDER_TYPING_ENDED="SenderTypingEnded",o.LOAD_MORE_MESSAGES="LoadMoreMessages",o.RECOVER_LIVECHAT="RecoverLivechat",o.RECOVER_THREAD="RecoverThread",o.SEND_MESSAGE="SendMessage",o.SEND_OUTBOUND="SendOutbound",o.SEND_OFFLINE_MESSAGE="SendOfflineMessage",o.SEND_PAGE_VIEWS="SendPageViews",o.SEND_CONSUMER_CUSTOM_FIELDS="SetConsumerCustomFields",o.SET_CONSUMER_CONTACT_CUSTOM_FIELD="SetConsumerContactCustomFields",o.MESSAGE_SEEN="MessageSeenByConsumer",o.SEND_TRANSCRIPT="SendTranscript",o.FETCH_THREAD_LIST="FetchThreadList",o.END_CONTACT="EndContact",o.EXECUTE_TRIGGER="ExecuteTrigger",o.AUTHORIZE_CONSUMER="AuthorizeConsumer",o.AUTHORIZE_CUSTOMER="AuthorizeCustomer",o.RECONNECT_CONSUMER="ReconnectConsumer",o.UPDATE_THREAD="UpdateThread",o.ARCHIVE_THREAD="ArchiveThread",o.LOAD_THREAD_METADATA="LoadThreadMetadata",o.REFRESH_TOKEN="RefreshToken",o.STORE_VISITOR="StoreVisitor",o.STORE_VISITOR_EVENTS="StoreVisitorEvents",o.CREATE_GROUP_CHAT_INVITE="CreateInvitationToGroupChat",o.SEND_EMAIL_INVITE_TO_GROUP_CHAT="SendEmailInvitationToGroupChat",o.JOIN_GROUP_CHAT="JoinGroupChat",o.LEAVE_GROUP_CHAT="LeaveGroupChat",o.GENERATE_AUTHORIZATION_TOKEN="GenerateAuthorizationToken",o.ADD_VISITOR_TAGS="AddVisitorTags",o.REMOVE_VISITOR_TAGS="RemoveVisitorTags",o.SEND_MESSAGE_PREVIEW="SendMessagePreview",(n=t.vc||(t.vc={})).LIVECHAT_RECOVERED="LivechatRecovered",n.MORE_MESSAGES_LOADED="MoreMessagesLoaded",n.OFFLINE_MESSAGE_SENT="OfflineMessageSent",n.THREAD_LIST_FETCHED="ThreadListFetched",n.THREAD_RECOVERED="ThreadRecovered",n.TRANSCRIPT_SENT="TranscriptSent",n.CONSUMER_AUTHORIZED="ConsumerAuthorized",n.THREAD_METADATA_LOADED="ThreadMetadataLoaded",n.SET_POSITION_IN_QUEUE="SetPositionInQueue",n.GROUP_CHAT_INVITE_CREATED="InvitationToGroupChatCreated",n.GROUP_CHAT_INVITE_SENT="EmailInvitationToGroupChatSent",n.GROUP_CHAT_JOINED="GroupChatJoined",n.TOKEN_REFRESHED="TokenRefreshed",n.AUTHORIZATION_TOKEN_GENERATED="AuthorizationTokenGenerated",n.THREAD_ARCHIVED="ThreadArchived"},369:(e,t)=>{var n;(n=t.F||(t.F={})).ONLINE="online",n.OFFLINE="offline"},442:(e,t)=>{var n;(n=t.bq||(t.bq={})).DESKTOP="desktop",n.MOBILE="mobile",n.OTHER="other",n.TABLET="tablet",(t.Xr||(t.Xr={})).BROWSER="browser"},168:(e,t,n)=>{var o=n(275);t.P=o.CaseStatus},796:(e,t)=>{t.Um="X-Caller-Service-ID"},953:(e,t)=>{!function(e){e.INBOUND="inbound",e.OUTBOUND="outbound"}(t.T||(t.T={}))},434:(e,t)=>{!function(e){e.TEXT="TEXT",e.FILE="FILE",e.FORM="FORM",e.PLUGIN="PLUGIN",e.POSTBACK="POSTBACK",e.QUICK_REPLIES="QUICK_REPLIES",e.RICH_LINK="RICH_LINK",e.LIST_PICKER="LIST_PICKER",e.ADAPTIVE_CARD="ADAPTIVE_CARD",e.TIME_PICKER="TIME_PICKER"}(t.G||(t.G={}))},275:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.CaseStatus||(t.CaseStatus={})).NEW="new",n.OPEN="open",n.PENDING="pending",n.ESCALATED="escalated",n.RESOLVED="resolved",n.CLOSED="closed",n.TRASHED="trashed"},0:(e,t)=>{!function(e){e.AUTHORIZE_CONSUMER="AuthorizeConsumer",e.CASE_CREATED="CaseCreated",e.CASE_INBOX_ASSIGNEE_CHANGED="CaseInboxAssigneeChanged",e.CASE_STATUS_CHANGED="CaseStatusChanged",e.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",e.CONTACT_CREATED="CaseCreated",e.ASSIGNED_AGENT_CHANGED="CaseInboxAssigneeChanged",e.CONTACT_STATUS_CHANGED="CaseStatusChanged",e.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",e.CONTACT_PREFERRED_USER_CHANGED="ContactPreferredUserChanged",e.CONTACT_PROFICIENCY_CHANGED="ContactProficiencyChanged",e.CONTACT_PRIORITY_CHANGED="ContactPriorityChanged",e.CONTACT_SYNC="ContactSync",e.CHANNEL_CREATED="ChannelCreated",e.CHANNEL_DELETED="ChannelDeleted",e.CHANNEL_UPDATED="ChannelUpdated",e.MESSAGE_ADDED_INTO_CASE="MessageAddedIntoCase",e.MESSAGE_CREATED="MessageCreated",e.MESSAGE_DELIVERED_TO_END_USER="MessageDeliveredToEndUser",e.MESSAGE_DELIVERED_TO_USER="MessageDeliveredToUser",e.MESSAGE_DELIVERY_STATUS_CHANGED="MessageDeliveryStatusChanged",e.MESSAGE_NOTE_CREATED="MessageNoteCreated",e.MESSAGE_NOTE_UPDATED="MessageNoteUpdated",e.MESSAGE_NOTE_DELETED="MessageNoteDeleted",e.MESSAGE_READ_CHANGED="MessageReadChanged",e.MESSAGE_SEEN_BY_END_USER="MessageSeenByEndUser",e.MESSAGE_SEEN_BY_USER="MessageSeenByUser",e.MESSAGE_SEEN_CHANGED="MessageSeenChanged",e.MESSAGE_SENT="MessageSent",e.MESSAGE_UPDATED="MessageUpdated",e.PAGE_VIEW_CREATED="PageViewCreated",e.ROUTING_QUEUE_CREATED="RoutingQueueCreated",e.ROUTING_QUEUE_DELETED="RoutingQueueDeleted",e.ROUTING_QUEUE_UPDATED="RoutingQueueUpdated",e.SUBQUEUE_ASSIGNED_TO_ROUTING_QUEUE="SubqueueAssignedToRoutingQueue",e.SUBQUEUE_UNASSIGNED_TO_ROUTING_QUEUE="SubqueueUnassignedFromRoutingQueue",e.USER_ASSIGNED_TO_ROUTING_QUEUE="UserAssignedToRoutingQueue",e.USER_STATUS_CHANGED="UserStatusChanged",e.USER_UNASSIGNED_FROM_ROUTING_QUEUE="UserUnassignedFromRoutingQueue",e.AGENT_CONTACT_STARTED="AgentContactStarted",e.AGENT_CONTACT_ENDED="AgentContactEnded",e.SENDER_TYPING_STARTED="SenderTypingStarted",e.SENDER_TYPING_ENDED="SenderTypingEnded",e.FIRE_PROACTIVE="FireProactiveAction",e.CONTACT_INBOX_PRE_ASSIGNEE_CHANGED="ConsumerContactInboxPreAssigneeChanged",e.CONTACT_RECIPIENTS_CHANGED="ContactRecipientsChanged",e.MESSAGE_PREVIEW_CREATED="MessagePreviewCreated",e.EVENT_IN_S3="EventInS3"}(t.m||(t.m={}))},198:t=>{t.exports=e}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var s=n[e]={exports:{}};return t[e].call(s.exports,s,s.exports,o),s.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};o.r(r),o.d(r,{AbortError:()=>pn,AbortablePromise:()=>mn,AuthorizationError:()=>E,CHAT_SDK_VERSION:()=>f,CacheStorage:()=>Io,CacheStorageError:()=>Oo,ChannelAvailability:()=>No.F,ChatEvent:()=>At,ChatSdk:()=>co,ContactStatus:()=>cn.P,Customer:()=>ze,EnvironmentName:()=>gt,LivechatThread:()=>Un,MessageType:()=>jt.G,SdkVersionNotSupported:()=>ht,SendMessageFailedError:()=>kt,Thread:()=>kn,ThreadRecoverFailedError:()=>Gn,UploadAttachmentError:()=>un,WebSocketClientError:()=>Jt,WebSocketClientEvent:()=>s.nF,createCreateInvitationToGroupChatPayloadData:()=>vo,createJoinGroupChatPayloadData:()=>po,createLeaveGroupChatPayloadData:()=>go,createReconnectPayloadData:()=>qe,createSendEmailInvitationToGroupChatPayloadData:()=>Ao,default:()=>Do,generateId:()=>v,getAuthor:()=>yn,getBrowserFingerprint:()=>dt,getBrowserLanguage:()=>at,getBrowserLocation:()=>ct,getDeviceType:()=>ut,isAgentTypingEndedEvent:()=>ho,isAgentTypingStartedEvent:()=>lo,isAssignedAgentChangedEvent:()=>uo,isAuthSuccessEvent:()=>nt,isContactCreatedEvent:()=>hn,isContactRecipientsChangedEvent:()=>fn,isContactStatusChangedEvent:()=>ln,isContactToRoutingQueueAssignmentChangedEvent:()=>En,isCustomerReconnectSuccessPayloadData:()=>Ro,isLoadMetadataSuccessPayload:()=>In,isMessage:()=>An,isMessageCreatedEvent:()=>Sn,isMessageReadChangedEvent:()=>wn,isMessageSentEvent:()=>On,isMoreMessagesLoadedEvent:()=>_n,isRecoverSuccessEvent:()=>Nn,isSetPositionInQueueEvent:()=>Eo,isThreadArchivedSuccessPayload:()=>Rn,isThreadListFetchedPostbackData:()=>Hn,isTokenRefreshedSuccessResponse:()=>ot,sendChatEvent:()=>Ze,sendCreateInvitationToGroupChatEvent:()=>_o,sendEmailInvitationToGroupChatEvent:()=>So,sendJoinGroupChatEvent:()=>mo,sendLeaveGroupChatEvent:()=>Co,splitName:()=>ke});var s=o(172),i=o(668),a=o(482);const c=function(e){return null===e},u={};function d(e){u.ACCESS_TOKEN=e.token,u.ACCESS_TOKEN_EXPIRES_IN=e.expiresIn}function l(){var e,t;const n=null!==(e=u.ACCESS_TOKEN)&&void 0!==e?e:null,o=null!==(t=u.ACCESS_TOKEN_EXPIRES_IN)&&void 0!==t?t:null;return c(n)||c(o)?null:{token:n,expiresIn:Number(o)}}class h extends Error{constructor(e,t){if(super(),this.name="ChatSDKError",this.data=t,e instanceof h)return this.message=e.message,this.stack=e.stack,void(this.cause=e.cause);this.message=`[ChatSDKError]: ${this._getErrorMessage(e)}`,e instanceof Error&&(this.stack=e.stack)}_getErrorMessage(e){return e instanceof Error?e.message:"string"==typeof e?e:JSON.stringify(e)}}class E extends h{constructor(e,t){super(e,t),void 0!==t&&(this.message=`${e} because of (${t.errorMessage})`)}}const f=null!=="2.0.0-rc.9"?"2.0.0-rc.9":"0";function v(){return crypto.randomUUID?crypto.randomUUID():function(){const e=new Uint8Array(16);return crypto.getRandomValues(e).reduce(((e,t,n)=>([4,6,8,10].includes(n)&&(e+="-"),e+(6===n?15&t|64:8===n?63&t|128:t).toString(16).padStart(2,"0"))),"")}()}function _(e){return{visitor:{id:e}}}var T=Object.prototype;const p=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||T)},m=(g=Object.keys,C=Object,function(e){return g(C(e))});var g,C,y=Object.prototype.hasOwnProperty;const A="object"==typeof global&&global&&global.Object===Object&&global;var S="object"==typeof self&&self&&self.Object===Object&&self;const O=A||S||Function("return this")(),w=O.Symbol;var b=Object.prototype,I=b.hasOwnProperty,N=b.toString,R=w?w.toStringTag:void 0;var D=Object.prototype.toString;var P=w?w.toStringTag:void 0;const M=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":P&&P in Object(e)?function(e){var t=I.call(e,R),n=e[R];try{e[R]=void 0;var o=!0}catch(e){}var r=N.call(e);return o&&(t?e[R]=n:delete e[R]),r}(e):function(e){return D.call(e)}(e)},G=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},k=function(e){if(!G(e))return!1;var t=M(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},j=O["__core-js_shared__"];var U,H=(U=/[^.]+$/.exec(j&&j.keys&&j.keys.IE_PROTO||""))?"Symbol(src)_1."+U:"";var L=Function.prototype.toString;const x=function(e){if(null!=e){try{return L.call(e)}catch(e){}try{return e+""}catch(e){}}return""};var F=/^\[object .+?Constructor\]$/,B=Function.prototype,V=Object.prototype,W=B.toString,z=V.hasOwnProperty,$=RegExp("^"+W.call(z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");const Q=function(e){return!(!G(e)||function(e){return!!H&&H in e}(e))&&(k(e)?$:F).test(x(e))},K=function(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Q(n)?n:void 0},Y=K(O,"DataView"),J=K(O,"Map"),X=K(O,"Promise"),Z=K(O,"Set"),q=K(O,"WeakMap");var ee="[object Map]",te="[object Promise]",ne="[object Set]",oe="[object WeakMap]",re="[object DataView]",se=x(Y),ie=x(J),ae=x(X),ce=x(Z),ue=x(q),de=M;(Y&&de(new Y(new ArrayBuffer(1)))!=re||J&&de(new J)!=ee||X&&de(X.resolve())!=te||Z&&de(new Z)!=ne||q&&de(new q)!=oe)&&(de=function(e){var t=M(e),n="[object Object]"==t?e.constructor:void 0,o=n?x(n):"";if(o)switch(o){case se:return re;case ie:return ee;case ae:return te;case ce:return ne;case ue:return oe}return t});const le=de,he=function(e){return null!=e&&"object"==typeof e},Ee=function(e){return he(e)&&"[object Arguments]"==M(e)};var fe=Object.prototype,ve=fe.hasOwnProperty,_e=fe.propertyIsEnumerable;const Te=Ee(function(){return arguments}())?Ee:function(e){return he(e)&&ve.call(e,"callee")&&!_e.call(e,"callee")},pe=Array.isArray,me=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var ge="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ce=ge&&"object"==typeof module&&module&&!module.nodeType&&module,ye=Ce&&Ce.exports===ge?O.Buffer:void 0;const Ae=(ye?ye.isBuffer:void 0)||function(){return!1};var Se={};Se["[object Float32Array]"]=Se["[object Float64Array]"]=Se["[object Int8Array]"]=Se["[object Int16Array]"]=Se["[object Int32Array]"]=Se["[object Uint8Array]"]=Se["[object Uint8ClampedArray]"]=Se["[object Uint16Array]"]=Se["[object Uint32Array]"]=!0,Se["[object Arguments]"]=Se["[object Array]"]=Se["[object ArrayBuffer]"]=Se["[object Boolean]"]=Se["[object DataView]"]=Se["[object Date]"]=Se["[object Error]"]=Se["[object Function]"]=Se["[object Map]"]=Se["[object Number]"]=Se["[object Object]"]=Se["[object RegExp]"]=Se["[object Set]"]=Se["[object String]"]=Se["[object WeakMap]"]=!1;var Oe="object"==typeof exports&&exports&&!exports.nodeType&&exports,we=Oe&&"object"==typeof module&&module&&!module.nodeType&&module,be=we&&we.exports===Oe&&A.process,Ie=function(){try{return we&&we.require&&we.require("util").types||be&&be.binding&&be.binding("util")}catch(e){}}(),Ne=Ie&&Ie.isTypedArray;const Re=Ne?function(e){return function(t){return e(t)}}(Ne):function(e){return he(e)&&me(e.length)&&!!Se[M(e)]};var De=Object.prototype.hasOwnProperty;const Pe=function(e){if(null==e)return!0;if(function(e){return null!=e&&me(e.length)&&!k(e)}(e)&&(pe(e)||"string"==typeof e||"function"==typeof e.splice||Ae(e)||Re(e)||Te(e)))return!e.length;var t=le(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(p(e))return!function(e){if(!p(e))return m(e);var t=[];for(var n in Object(e))y.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e).length;for(var n in e)if(De.call(e,n))return!1;return!0},Me=new Map,Ge=async(e,t)=>{if(c(t))throw new h("WebSocketClient is not initialized");return Pe(e.eventId)&&(e.eventId=v()),new Promise((n=>{Me.set(e.eventId,n),null==t||t.send(e)}))};function ke(e){const[t,...n]=e.split(" ");return[t,n.join(" ")]}function je(e,t={}){for(const n of Object.keys(t))e.set(n,t[n])}function Ue(e,t=[]){for(const{ident:n,value:o}of t)e.set(n,o)}function He(e){return Object.fromEntries(e)}function Le(e){return Array.from(e).map((([e,t])=>({ident:e,value:t})))}let xe,Fe,Be,Ve;function We(e){const{idOnExternalPlatform:t,firstName:n="",lastName:o="",image:r,customFields:s}=e;xe=t,(n||o)&&(Fe=`${null!=n?n:""} ${null!=o?o:""}`.trim()),r&&(Be=r),pe(s)&&(Ve=s)}class ze{constructor(e,t,n,o){this._customFields=new Map,this._exists=!1,this._websocketClient=o,ze.setId(e),ze.setName(t),ze.setImage(n),pe(Ve)&&(this.setCustomFieldsFromArray(Ve),Ve=void 0)}static setId(e){xe=e}static getId(){return null!=xe?xe:null}static getName(){return Fe}static setName(e){Fe=e}static getIdOrCreateNewOne(){let e=this.getId();return e||(e=v(),this.setId(e)),e}static getImage(){return Be}static setImage(e){Be=e}static destroy(){xe=void 0,Fe=void 0,Be=void 0,Ve=void 0}getId(){return ze.getIdOrCreateNewOne()}getName(){return ze.getName()}setName(e){ze.setName(e)}setImage(e){ze.setImage(e)}setExists(e){this._exists=e}setCustomField(e,t){return this.setCustomFields({[e]:t})}setCustomFields(e){if(je(this._customFields,e),this._exists)return this.sendCustomFields()}getCustomFields(){return He(this._customFields)}setCustomFieldsFromArray(e){Ue(this._customFields,e)}getCustomFieldsArray(){return Le(this._customFields)}async sendCustomFields(){var e;return Ze((e=Le(this._customFields),{eventType:a.ow.SEND_CONSUMER_CUSTOM_FIELDS,data:{customFields:e}}),this._websocketClient)}}function $e(e,t){const n=null!=e?e:ze.getName(),o=null!=t?t:ze.getImage();let r={};if("string"==typeof n&&n.length>0){const[e,t]=ke(n);r={firstName:e,lastName:t}}return o&&(r.image=o),Object.assign({idOnExternalPlatform:ze.getIdOrCreateNewOne()},r)}const Qe=function(e){return null==e};function Ke(){const e=u.BRAND_ID,t=u.CHANNEL_ID;if(Qe(e)||isNaN(e)||Qe(t))throw new h(`Cannot get BrandId and ChannelId from SDKVariableStorage\n      brandId (${e}) |\n      channelId (${t})`);return{brandId:e,channelId:t}}const Ye=function(e){return void 0===e};function Je(e){const t=u.DESTINATION,n=u.VISIT_ID,o=u.VISITOR_ID,{eventType:r,data:s,consumerIdentity:i=$e(),destination:a=(t?{id:t}:{}),visitor:c=(o?{id:o}:{}),visit:d=(n?{id:n}:{})}=e,{brandId:l,channelId:E}=Ke();if(Ye(r))throw new h(`Cannot create an event payload because of missing eventType (${r})`);return{eventType:r,brand:{id:Number(l)},channel:{id:E},consumerIdentity:i,data:s,destination:a,visitor:c,visit:d}}function Xe(e,t=v(),n=i.V.CHAT_WINDOW_EVENT){return{action:n,eventId:t,payload:e}}async function Ze(e,t){const n=Xe(Je(e));return Ge(n,t)}function qe(e,t){return Object.assign(Object.assign(Object.assign({},_(t)),$e()),{eventType:a.ow.RECONNECT_CONSUMER,data:{accessToken:{token:e.token}}})}let et=null;function tt(e,t){null!==et&&clearTimeout(et),et=setTimeout(t,1e3*function(e){const t=Math.round(.9*e);return t<20?20:t}(e.expiresIn))}const nt=e=>{var t;const n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.status;return(null==e?void 0:e.type)===a.vc.CONSUMER_AUTHORIZED&&"success"===n};function ot(e){var t,n;return(null==e?void 0:e.type)===a.vc.TOKEN_REFRESHED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.accessToken)||void 0===n?void 0:n.token)}var rt=o(198),st=o.n(rt),it=o(442);const at=()=>navigator.language,ct=()=>Intl.DateTimeFormat().resolvedOptions().timeZone;function ut(e){switch(e){case"mobile":return it.bq.MOBILE;case"tablet":return it.bq.TABLET;default:return it.bq.DESKTOP}}const dt=(e={})=>{var t,n,o,r;const s=new(st())(navigator.userAgent),{country:i="",location:a=ct(),language:c=at(),ip:u=null}=e;return{browser:null!==(t=s.getBrowser().name)&&void 0!==t?t:null,browserVersion:null!==(n=s.getBrowser().version)&&void 0!==n?n:null,country:i,ip:u,language:c,location:a,os:null!==(o=s.getOS().name)&&void 0!==o?o:null,osVersion:null!==(r=s.getOS().version)&&void 0!==r?r:null,deviceType:ut(s.getDevice().type),applicationType:it.Xr.BROWSER}},lt="SdkVersionNotSupported";class ht extends Error{constructor(){super(...arguments),this.name=lt,this.message="Please update to the latest ChatSDK version"}}function Et(e){var t;return(null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.errorCode)===lt}function ft(e){if(Et(e))throw new ht;return e}var vt,_t=o(796);const Tt={Accept:"application/json","Content-Type":"application/json",[_t.Um]:null!==(vt=u.APP_NAME)&&void 0!==vt?vt:"","x-sdk-platform":"web","x-sdk-version":f};async function pt(e){let t;try{t=await e.json()}catch(n){t=e.statusText}return t}async function mt(e,t,n=at()){const o=`${n}`.split("-").join("_"),r=u.ENDPOINT_CHAT,s=await fetch(`${r}/chat/1.0/brand/${e}/channel/${t}?locale=${o}`,{method:"GET",headers:Object.assign({},Tt)});if(!s.ok){if(Et(await pt(s)))throw new ht;throw new h(`Failed to fetch channel info. Status (${s.status})`,{response:s})}return s.json()}var gt;!function(e){e.AU1="AU1",e.CA1="CA1",e.EU1="EU1",e.JP1="JP1",e.NA1="NA1",e.UK1="UK1",e.custom="custom"}(gt||(gt={}));const Ct=e=>{u.ENDPOINT_GATEWAY=e.gateway,u.ENDPOINT_CHAT=e.chat,u.ENDPOINT_AUTHORIZE=e.authorize};var yt=o(0);const At=Object.assign(Object.assign(Object.assign({},yt.m),a.vc),{AGENT_TYPING_STARTED:"AgentTypingStarted",AGENT_TYPING_ENDED:"AgentTypingEnded",ASSIGNED_AGENT_CHANGED:"AssignedAgentChanged",CONTACT_CREATED:"ContactCreated",CONTACT_STATUS_CHANGED:"ContactStatusChanged",CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED:"ContactToRoutingQueueAssignmentChanged"});class St extends CustomEvent{}class Ot{constructor(){this.middlewares=[]}register(e){this.middlewares.push(e)}process(e){if(Qe(e))return null;let t=e;for(const e of this.middlewares){if(null===t)return null;t=e(t)}return t}}const wt=EventTarget;function bt(e){return!Qe(null==e?void 0:e.user)}var It=o(555),Nt=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};const Rt={id:"",data:null,type:void 0,createdAt:new Date};function Dt(e){var t;if(!(e=>"eventId"in e)(e))return Rt;if((e=>"error"in e)(e))return{createdAt:(0,It.TG)(null!==(t=e.createdAt)&&void 0!==t?t:(new Date).toString()),data:null,error:e.error,id:e.eventId};const n=(e=>"eventType"in e)(e)?e.eventType:void 0;if((e=>"data"in e)(e))return{createdAt:(0,It.TG)(e.createdAt),context:e.context,data:e.data,id:e.eventId,type:n};if((e=>{const t=null==e?void 0:e.postback;return!1===Pe(t)})(e)){const{postback:{data:t,eventType:n},eventId:o}=e,r=Nt(e,["postback","eventId"]);return{type:n,data:Object.assign(Object.assign({},r),t),createdAt:(0,It.TG)(e.createdAt),id:o}}const{eventId:o}=e,r=Nt(e,["eventId"]);return Object.assign(Object.assign({data:void 0},r),{id:o,type:n,createdAt:(0,It.TG)(e.createdAt)})}const Pt={[At.SENDER_TYPING_STARTED]:function(e){return bt(e.data)?Object.assign(Object.assign({},e),{type:At.AGENT_TYPING_STARTED}):e},[At.SENDER_TYPING_ENDED]:function(e){return bt(e.data)?Object.assign(Object.assign({},e),{type:At.AGENT_TYPING_ENDED}):e},[At.CASE_INBOX_ASSIGNEE_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:At.ASSIGNED_AGENT_CHANGED})},[At.CASE_CREATED]:function(e){return Object.assign(Object.assign({},e),{type:At.CONTACT_CREATED})},[At.CASE_STATUS_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:At.CONTACT_STATUS_CHANGED})},[At.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:At.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED})},[At.LIVECHAT_RECOVERED]:function(e){const t=e.data.contactHistory.map(Dt);return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})},[At.THREAD_RECOVERED]:function(e){const t=e.data.contactHistory.map(Dt);return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})}};function Mt(e){return e.type&&void 0!==Pt[e.type]?Pt[e.type](e):e}function Gt(e){const t=!1===Ye(null==e?void 0:e.id);return!1==(!1===Ye(e.error))&&t}class kt extends h{}var jt=o(434);const Ut="sdkThirdPartyToken",Ht=e=>{u.CACHE_STORAGE&&u.CACHE_STORAGE.setItem(Ut,e,1e3*e.expires_in)},Lt="sdkTransactionToken",xt="Authorize hostname is not set",Ft="Cannot refresh ThirdParty token";async function Bt(e,t,n){return async function(e,t){const n=Object.assign({headers:Object.assign({},Tt)},t),o=await fetch(e,n);if(!o.ok)throw o;return o.json()}(e,Object.assign({method:"POST",body:JSON.stringify(null!=t?t:{})},n))}function Vt(){var e,t;if(!u.ENDPOINT_AUTHORIZE)throw new h(xt);const n=new URL(u.ENDPOINT_AUTHORIZE);return n.pathname="/oauth/token",n.searchParams.append("brandId",String(u.BRAND_ID)),n.searchParams.append("channelId",null!==(e=u.CHANNEL_ID)&&void 0!==e?e:""),n.searchParams.append("visitorId",null!==(t=u.VISITOR_ID)&&void 0!==t?t:""),n.toString()}function Wt(){var e;return null!==(e=u.THIRD_PARTY_TOKEN)&&void 0!==e?e:null}async function zt(){const e=Wt();if(c(e))throw new h(Ft);const t=Vt();try{const{thirdParty:n}=await Bt(t,{thirdParty:{grant_type:"refresh_token",refresh_token:e.refresh_token}},{credentials:"include"});if(!n)throw new h(Ft);return $t(n)}catch(e){if(e instanceof h)throw e;throw new h(Ft,e)}}function $t(e){!function(e){u.THIRD_PARTY_TOKEN=e}(e),Ht(e),tt({expiresIn:e.expires_in},zt)}const Qt=()=>{var e;return null!==(e=u.SECURED_SESSION)&&void 0!==e&&e};var Kt=o(10),Yt=o(720);class Jt extends Error{constructor(e,t=""){super(`[WebSocketClientError]: ${e}${t?` (${t})`:""}`),this.name="WebSocketClientError"}}const Xt=EventTarget;var Zt,qt,en,tn,nn,on,rn=function(e,t,n,o,r){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?r.call(e,n):r?r.value=n:t.set(e,n),n},sn=function(e,t,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(e):o?o.value:t.get(e)};class an{constructor(e,t,n,o,r,s){this.brandId=e,this.channelId=t,this.customerId=n,this.options=o,this.onError=r,this.visitorId=s,Zt.add(this),qt.set(this,null),en.set(this,void 0),tn.set(this,!1),on.set(this,(e=>{sn(this,en,"f").dispatchEvent(e)})),rn(this,en,new Xt,"f")}async connect(e){var t,n;sn(this,Zt,"m",nn).call(this,e),null===(n=null===(t=sn(this,qt,"f"))||void 0===t?void 0:t.socket)||void 0===n||n.reconnect()}disconnect(){var e;null===(e=sn(this,qt,"f"))||void 0===e||e.socket.close()}reconnect(e){var t;sn(this,Zt,"m",nn).call(this,e),null===(t=sn(this,qt,"f"))||void 0===t||t.socket.reconnect()}send(e){var t;const n=JSON.stringify(e);null===(t=sn(this,qt,"f"))||void 0===t||t.send(n)}on(e,t){sn(this,en,"f").addEventListener(e,t)}off(e,t){sn(this,en,"f").removeEventListener(e,t)}_errorHandler(e){const t=e.detail;let n;if(t instanceof ErrorEvent&&(n=new Jt("Connection error",t.message)),t instanceof CloseEvent&&(n=new Jt("Connection closed",t.reason)),void 0===n&&(n=new Jt("Unknown error",t.type)),"function"!=typeof this.onError)throw n;this.onError(n)}}qt=new WeakMap,en=new WeakMap,tn=new WeakMap,on=new WeakMap,Zt=new WeakSet,nn=function(e){var t,n,o,r,i,a,c,d,l,h,E,v,_;const T=(null===(t=this.options)||void 0===t?void 0:t.port)?`:${null===(n=this.options)||void 0===n?void 0:n.port}`:"",p=(null===(o=this.options)||void 0===o?void 0:o.host)?`${null===(r=this.options)||void 0===r?void 0:r.host}${T}`:"",m=null!==(a=null===(i=this.options)||void 0===i?void 0:i.prefix)&&void 0!==a?a:"",g=null===(d=null===(c=this.options)||void 0===c?void 0:c.forceSecureProtocol)||void 0===d||d,C=function(e,t,n){const o=u.APP_VERSION,r=Object.assign({v:o,sdkPlatform:"web",sdkVersion:f},n);return`${e}/${t}?${(0,Kt.C)(r)}`}(p,m,Object.assign({brandId:this.brandId,channelId:this.channelId,consumerId:this.customerId,visitorId:this.visitorId},e?{transactionToken:e}:{})),y=!e;rn(this,qt,(0,Yt.setupSocketConnection)(C,{startClosed:!0,forceSecureProtocol:g,heartbeatAfterAuthorize:y,maxRetries:0}),"f");const A=this._errorHandler.bind(this);null===(l=sn(this,qt,"f"))||void 0===l||l.addEventListener(s.nF.CLOSE,A),null===(h=sn(this,qt,"f"))||void 0===h||h.addEventListener(s.nF.ERROR,A),null===(E=sn(this,qt,"f"))||void 0===E||E.addEventListener(s.nF.OPEN,(e=>{var t;null===(t=sn(this,qt,"f"))||void 0===t||t.socket.setMaxRetires(20),rn(this,tn,!0,"f"),sn(this,on,"f").call(this,e)})),null===(v=sn(this,qt,"f"))||void 0===v||v.addEventListener(s.nF.CLOSE,(e=>{sn(this,tn,"f")||sn(this,en,"f").dispatchEvent(new CustomEvent(s.nF.AUTHORIZATION_FAILED)),sn(this,on,"f").call(this,e)})),null===(_=sn(this,qt,"f"))||void 0===_||_.addEventListener(s.nF.MESSAGE,sn(this,on,"f"))};var cn=o(168);class un extends h{}const dn=async(e,t,n)=>{const o=await(async e=>{const t=await function(e){return new Promise(((t,n)=>{const o=new FileReader;o.onloadend=()=>{t(o)},o.onerror=e=>{var t,o;return n(null===(o=null===(t=e.target)||void 0===t?void 0:t.error)||void 0===o?void 0:o.message)},o.readAsDataURL(e)}))}(e);if(null!==t.error)throw new h(`Cannot create payload for attachment upload because of error (${t.error.message})`);if("string"!=typeof t.result)throw new h(`Cannot create payload for attachment upload because of missing:\n      reader result (${t.result})`);return{url:t.result,name:e.name,mimeType:e.type}})(e),r=await async function(e,t,n){const{url:o,name:r,mimeType:s}=n,i={content:o.split(";base64,")[1],fileName:r,mimeType:s},a=await fetch(`${u.ENDPOINT_CHAT}/chat/1.0/brand/${e}/channel/${t}/attachment`,{method:"POST",body:JSON.stringify(i),headers:Object.assign({},Tt)});if(!a.ok){if(Et(await pt(a)))throw new ht;throw new h(`Failed to upload Attachments. Status (${a.status})`)}return a.json()}(t,n,o);if(!1===Ye(null==(s=r)?void 0:s.fileUrl))return{url:r.fileUrl,friendlyName:o.name};var s;if(function(e){return!1===Ye(null==e?void 0:e.allowedFileSize)}(r))throw new un("Upload attachment failed",r);throw new h(`Unknown file upload response (${r})`)};function ln(e){var t,n;return e.type===At.CONTACT_STATUS_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function hn(e){var t,n;return e.type===At.CONTACT_CREATED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function En(e){var t,n;return e.type===At.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function fn(e){return e.type===yt.m.CONTACT_RECIPIENTS_CHANGED}const vn=(e,t,n,o=dt())=>({messageContent:e,browserFingerprint:o,idOnExternalPlatform:t,thread:{idOnExternalPlatform:n},consumer:{customFields:[]},consumerContact:{customFields:[]},attachments:[]});function _n(e){var t;return e.type===a.vc.MORE_MESSAGES_LOADED&&void 0!==(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.messages)}const Tn=e=>({eventType:a.ow.LOAD_MORE_MESSAGES,data:e});class pn extends Error{constructor(e="Aborted"){super(e),this.name="AbortError"}}class mn extends Promise{constructor(e){const t=new AbortController,n=t.signal;super(((t,o)=>{n.addEventListener("abort",(()=>{o(new pn(this.abortReason))})),null==e||e(t,o,n)})),this.abort=e=>{this._abortReason=null!=e?e:"Aborted",t.abort()}}get abortReason(){return this._abortReason}}mn.from=e=>e instanceof mn?e:new mn(((t,n)=>{e.then(t).catch(n)}));class gn extends h{}var Cn=o(953);const yn=e=>{var t,n,o,r,s,i;return e.direction===Cn.T.INBOUND?null!==(n=null===(t=e.authorEndUserIdentity)||void 0===t?void 0:t.fullName)&&void 0!==n?n:"":`${null!==(r=null===(o=e.authorUser)||void 0===o?void 0:o.firstName)&&void 0!==r?r:""} ${null!==(i=null===(s=e.authorUser)||void 0===s?void 0:s.surname)&&void 0!==i?i:""}`.trim()};function An(e){const t=!1===Ye(e.id),n=!1===Ye(e.direction),o=!1===Ye(e.messageContent);return t&&n&&o}function Sn(e){return e.type===yt.m.MESSAGE_CREATED}function On(e){return e.type===yt.m.MESSAGE_SENT}function wn(e){return e.type===yt.m.MESSAGE_READ_CHANGED}class bn extends h{}const In=e=>e.type===a.vc.THREAD_METADATA_LOADED&&void 0!==e.data.lastMessage,Nn=e=>{const t=e.data;return!1!=(!1===Ye(t))&&(!1!=(!1===Ye(null==t?void 0:t.messages))&&(!1!=(e.type===a.vc.THREAD_RECOVERED||e.type===a.vc.LIVECHAT_RECOVERED)&&(!1!==Ye(e.error)&&!1!=(!1===Ye(null==t?void 0:t.thread)))))};function Rn(e){return e.type===a.vc.THREAD_ARCHIVED}class Dn extends h{}function Pn(e){const t={eventType:a.ow.RECOVER_THREAD,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}class Mn extends h{}class Gn extends h{}class kn{constructor(e,t,n,o,r={},s=!1){this._exists=!1,this._typingTimeoutID=void 0,this._isAuthorizationEnabled=!1,this._customFields=new Map,this._typingPreviewText="",this.idOnExternalPlatform=e,this._websocketClient=t,this._messageEmitter=n,this._customer=o,this._isAuthorizationEnabled=s,je(this._customFields,r),this._registerEventHandlers()}recover(){return new mn((async(e,t)=>{const n=await Ze(Pn(this.idOnExternalPlatform),this._websocketClient);if(Nn(n)){const t=n.data,{contact:o,consumerContact:r}=t,s=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(t,["contact","consumerContact"]);e(Object.assign(Object.assign({},s),{contact:null!=o?o:r}))}else t(new Gn("Thread recover fail",n))}))}async sendMessage(e){!function(e){if(e.messageContent.type===jt.G.TEXT&&!(e.attachments.length>0)&&!1!==Pe(e.messageContent.payload.text))throw new kt("Message content cannot be empty for text message")}(e);return(async(e,t)=>{const n=(o=e,{eventType:a.ow.SEND_MESSAGE,data:o});var o;const r=await Ze(n,t);if(Gt(r))return r;throw new kt("Send message failed",r)})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!1),this._websocketClient)}async sendTextMessage(e,t={}){const{messageId:n=v(),browserFingerprint:o=dt()}=t,r=function(e){return{payload:{text:e},type:jt.G.TEXT}}(e),s=vn(r,n,this.idOnExternalPlatform,o);return this.sendMessage(s)}async sendPostbackMessage(e,t,n={}){const{messageId:o=v(),browserFingerprint:r=dt()}=n,s=function(e,t){return{payload:{text:t,postback:e},postback:e,type:jt.G.TEXT}}(e,t),i=vn(s,o,this.idOnExternalPlatform,r);return this.sendMessage(i)}async sendOutboundMessage(e){return(async(e,t)=>{const n=(o=e,{eventType:a.ow.SEND_OUTBOUND,data:o});var o;const r=await Ze(n,t);if(Gt(r))return r;throw new kt("Send Outbound message failed",r)})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!0),this._websocketClient)}async loadMoreMessages(){var e;const{scrollToken:t,oldestMessageDatetime:n}=null!==(e=u.THREAD_DATA)&&void 0!==e?e:{};if(Pe(t))return null;const o={scrollToken:String(t),oldestMessageDatetime:n,thread:{idOnExternalPlatform:this.idOnExternalPlatform}},r=await Ze(Tn(o),this._websocketClient);if(_n(r))return r;throw new Dn("Load more messages failed",r)}async lastMessageSeen(){var e;return Ze((e=this.idOnExternalPlatform,{eventType:a.ow.MESSAGE_SEEN,data:{thread:{idOnExternalPlatform:e}}}),this._websocketClient)}async sendAttachments(e,t={}){if(Ye(e)||0===e.length)throw new h("FileList must be provided to sendAttachment method");const n=await(async(e,t,n={})=>{const{brandId:o,channelId:r}=Ke();try{const s=await Promise.all(Array.from(e).map((async e=>dn(e,o,r)))),{messageId:i=v(),browserFingerprint:a=dt()}=n;return{messageContent:{type:jt.G.TEXT,payload:{text:""}},attachments:s,browserFingerprint:a,thread:{idOnExternalPlatform:t},idOnExternalPlatform:i,consumer:{customFields:[]},consumerContact:{customFields:[]}}}catch(e){if(e instanceof un)throw e;if(e instanceof Error)throw new h(`Send attachment failed because of (${e.message})`);throw new h("Unknown error during file upload")}})(e,this.idOnExternalPlatform,t);return this.sendMessage(n)}keystroke(e=1e3,t){var n;this._typingTimeoutID||Ze((n=this.idOnExternalPlatform,{eventType:a.ow.SENDER_TYPING_STARTED,data:{thread:{idOnExternalPlatform:n}}}),this._websocketClient),clearTimeout(this._typingTimeoutID),this._typingTimeoutID=setTimeout((()=>{this._stopTypingCallback(t)}),e)}stopTyping(){this._stopTypingCallback()}_stopTypingCallback(e){var t;clearTimeout(this._typingTimeoutID),this._typingTimeoutID=void 0,Ze((t=this.idOnExternalPlatform,{eventType:a.ow.SENDER_TYPING_ENDED,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient),"function"==typeof e&&e()}keystrokeForPreview(e,t=1250){this._typingPreviewText=e,this._typingForPreviewTimeoutID||(this._typingForPreviewTimeoutID=setTimeout((()=>{this.stopTypingForPreview()}),t))}stopTypingForPreview(e=!0){clearTimeout(this._typingForPreviewTimeoutID),this._typingForPreviewTimeoutID=void 0;const t=this._typingPreviewText;this._typingPreviewText="",!1!==e&&this.sendMessagePreview(t)}async getMetadata(){const e=await Ze((t=this.idOnExternalPlatform,{eventType:a.ow.LOAD_THREAD_METADATA,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(In(e))return e;throw new bn("Get metadata failed",e)}onThreadEvent(e,t){const n=((e,t)=>n=>{const o=(e=>{var t,n,o,r,s,i,a;const c=e;return null!==(i=null!==(r=null!==(n=null===(t=null==c?void 0:c.thread)||void 0===t?void 0:t.idOnExternalPlatform)&&void 0!==n?n:null===(o=null==c?void 0:c.case)||void 0===o?void 0:o.threadIdOnExternalPlatform)&&void 0!==r?r:null===(s=null==c?void 0:c.message)||void 0===s?void 0:s.threadIdOnExternalPlatform)&&void 0!==i?i:null===(a=null==c?void 0:c.messagePreview)||void 0===a?void 0:a.threadIdOnExternalPlatform})(n.detail.data);o===e&&t(n)})(this.idOnExternalPlatform,t);return this._messageEmitter.addEventListener(e,n),()=>{this._messageEmitter.removeEventListener(e,n)}}async sendCustomFields(e){var t,n;return Ze((t=Le(this._customFields).filter((t=>!e||e.includes(t.ident))),n=this.idOnExternalPlatform,{eventType:a.ow.SET_CONSUMER_CONTACT_CUSTOM_FIELD,data:{customFields:t,thread:{idOnExternalPlatform:n}}}),this._websocketClient)}async setCustomFields(e){je(this._customFields,e),!1!==this._exists&&await this.sendCustomFields(Object.keys(e))}setCustomField(e,t){return this.setCustomFields({[e]:t})}async archive(){const e=await Ze((t=this.idOnExternalPlatform,{eventType:a.ow.ARCHIVE_THREAD,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(Rn(e))return!0;throw new gn("Archive Thread failed",e)}async setName(e){const t=(n=this.idOnExternalPlatform,o=e,{eventType:a.ow.UPDATE_THREAD,data:{thread:{idOnExternalPlatform:n,threadName:o}}});var n,o;const r=await Ze(t,this._websocketClient);if(function(e){return Ye(e.error)}(r))return!0;throw new Mn("Set Thread name failed",r)}async sendMessagePreview(e){const t=((e,t)=>({eventType:a.ow.SEND_MESSAGE_PREVIEW,data:{thread:{idOnExternalPlatform:e},messageContent:{payload:{text:t},type:jt.G.TEXT}}}))(this.idOnExternalPlatform,e);await Ze(t,this._websocketClient)}async sendTranscript(e,t){const n=((e,t)=>({eventType:a.ow.SEND_TRANSCRIPT,data:{consumerContact:{id:e},consumerRecipients:[{idOnExternalPlatform:t}]}}))(e,t);return Ze(n,this._websocketClient)}_setThreadAndCustomerExists(){var e;this._exists=!0,null===(e=this._customer)||void 0===e||e.setExists(!0)}_clearCustomFieldsOnContactStatusChangedToClosed(e){const t=e.detail;ln(t)&&t.data.case.status===cn.P.CLOSED&&this._customFields.clear()}_mergeCustomFieldsAndAccessTokenWithMessageData(e,t){var n,o,r,s,i,a;let c;const u=Wt(),d=l();this._isAuthorizationEnabled&&(u||d)&&(c={token:null!==(n=null==u?void 0:u.access_token)&&void 0!==n?n:null==d?void 0:d.token}),Ue(this._customFields,e.consumerContact.customFields);const h={customFields:Le(this._customFields)};let E;return t||(null===(o=this._customer)||void 0===o||o.setCustomFieldsFromArray(null!==(s=null===(r=e.consumer)||void 0===r?void 0:r.customFields)&&void 0!==s?s:[]),E={customFields:null!==(a=null===(i=this._customer)||void 0===i?void 0:i.getCustomFieldsArray())&&void 0!==a?a:[]}),Object.assign(Object.assign({},e),{accessToken:c,consumer:E,consumerContact:h})}_registerEventHandlers(){this.onThreadEvent(At.CASE_CREATED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(At.CONTACT_CREATED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(At.THREAD_RECOVERED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(At.CONTACT_STATUS_CHANGED,(e=>this._clearCustomFieldsOnContactStatusChangedToClosed(e)))}}function jn(e){const t={eventType:a.ow.RECOVER_LIVECHAT,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}class Un extends kn{constructor(e,t,n,o,r={},s=!1){super(e,t,n,o,r,s),this._isInitialized=!1,this._canSendMessage=!0,this._registerLivechatEventHandlers()}recover(){return new mn((async(e,t)=>{const n=await Ze(jn(this.idOnExternalPlatform),this._websocketClient);if(Nn(n)){const t=n.data,{contact:o,consumerContact:r}=t,s=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(t,["contact","consumerContact"]);e(Object.assign(Object.assign({},s),{contact:null!=o?o:r}))}else t(new Gn("Thread recover fail",n))}))}async sendMessage(e){if(!1===this._canSendMessage)throw new h("Cannot send more messages to Contact");return super.sendMessage(e)}async startChat(e="Begin conversation"){if(this._isInitialized)throw new h("Chat is already initialized");try{const t=await this.sendTextMessage(e);return this._isInitialized=!0,t}catch(e){if(e instanceof Error)throw new h(`Sending initial message failed because of (${e.message})`);return}}async endChat(){var e;const t=null!==(e=u.THREAD_DATA)&&void 0!==e?e:{},n=null==t?void 0:t.contactId;if(Ye(n))throw new h("Cannot end Chat because of missing ContactId in the storage");await Ze(function(e,t){return{eventType:a.ow.END_CONTACT,data:{thread:{idOnExternalPlatform:e},contact:{id:t}}}}(this.idOnExternalPlatform,n),this._websocketClient)}async loadMoreMessages(){var e;const{scrollToken:t,oldestMessageDatetime:n,contactId:o}=null!==(e=u.THREAD_DATA)&&void 0!==e?e:{};if(Pe(t)||Pe(o))return null;const r={scrollToken:String(t),oldestMessageDatetime:n,thread:{idOnExternalPlatform:this.idOnExternalPlatform},contact:{id:o}},s=await Ze(Tn(r),this._websocketClient);if(_n(s))return s;throw new Dn("Load more messages failed",s)}_registerLivechatEventHandlers(){this.onThreadEvent(At.LIVECHAT_RECOVERED,(e=>{Nn(e.detail)&&this._setThreadAndCustomerExists()}))}}const Hn=e=>!c(e)&&"threads"in e;function Ln(e){var t;const n=null!==(t=u.THREAD_DATA)&&void 0!==t?t:{};u.THREAD_DATA=Object.assign(Object.assign({},n),{contactId:e})}function xn(e){var t,n,o;return hn(e)&&Ln(e.data.case.id),Nn(e)&&Ln(null!==(n=null===(t=e.data.consumerContact)||void 0===t?void 0:t.caseId)&&void 0!==n?n:null===(o=e.data.contact)||void 0===o?void 0:o.id),e}const Fn=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0};function Bn(e){var t,n;const o=null===(t=Fn(e.messages))||void 0===t?void 0:t.createdAt,r=null!==(n=u.THREAD_DATA)&&void 0!==n?n:{};u.THREAD_DATA=Object.assign(Object.assign({},r),{scrollToken:e.scrollToken,oldestMessageDatetime:Ye(o)?"":o})}function Vn(e){if(Nn(e)){const{messages:t,messagesScrollToken:n}=e.data;Bn({messages:t,scrollToken:n})}if(_n(e)){const{scrollToken:t,messages:n}=e.data;Bn({scrollToken:t,messages:n})}return e}function Wn(e){if(null==e)throw Error(`Expected non-nullish value, got ${e}`)}function zn(e){if("function"!=typeof e)throw Error(`Expected a callable function, got ${e}`)}var $n,Qn,Kn,Yn,Jn,Xn,Zn,qn,eo,to,no,oo,ro,so,io=function(e,t,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(e):o?o.value:t.get(e)},ao=function(e,t,n,o,r){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?r.call(e,n):r?r.value=n:t.set(e,n),n};class co{constructor(e){var t,n,o,r,s;if($n.add(this),this.channelId="",Qn.set(this,null),Kn.set(this,void 0),Yn.set(this,null),Jn.set(this,new Map),Xn.set(this,new Map),Zn.set(this,new Ot),qn.set(this,void 0),eo.set(this,function(){let e,t;return{promise:new Promise(((n,o)=>{e=n,t=o})),resolve:e,reject:t}}()),oo.set(this,(async()=>{const e=l();if(c(e))return;const t=await Ze((n=e.token,{eventType:a.ow.REFRESH_TOKEN,data:{accessToken:{token:n}}}),io(this,Yn,"f"));var n;if(ot(t))return d(t.data.accessToken),void tt(t.data.accessToken,io(this,oo,"f"));throw new E("An error occurred while refreshing the access token",t.error)})),void 0===e)throw new h("No options was provided for initialization of ChatSdk");u.AUTHORIZATION_CODE=e.authorizationCode,u.BRAND_ID=e.brandId,u.CHANNEL_ID=e.channelId,u.APP_NAME=null!==(t=e.appName)&&void 0!==t?t:"chat-web-sdk",u.APP_VERSION=`${null!==(n=e.appVersion)&&void 0!==n?n:0}`,u.DESTINATION=e.destinationId,u.VISIT_ID=e.visitId,u.VISITOR_ID=e.visitorId,u.LANGUAGE=null!==(o=e.language)&&void 0!==o?o:at(),u.SECURED_SESSION=null!==(r=e.securedSession)&&void 0!==r&&r,void 0!==e.customerId&&ze.setId(e.customerId),e.cacheStorage&&(zn(e.cacheStorage.getItem),zn(e.cacheStorage.setItem),zn(e.cacheStorage.removeItem),u.CACHE_STORAGE=e.cacheStorage);const{brandId:i,channelId:f}=Ke();this.onError=e.onError,this.onRawEvent=e.onRawEvent,io(this,Zn,"f").register(Mt),io(this,Zn,"f").register(ft),io(this,Zn,"f").register(Vn),io(this,Zn,"f").register(xn),ao(this,qn,new wt,"f");try{if(isNaN(i))throw new Error("Missing BrandID");if(void 0===f)throw new Error("Missing ChannelId");if(void 0===e.customerId&&!Qt())throw new Error("Missing CustomerId");this.channelId=f,this.isLivechat=e.isLivechat,ao(this,Kn,e.isAuthorizationEnabled,"f");const t=null!==(s=e.visitorId)&&void 0!==s?s:"";io(this,$n,"m",ro).call(this,e),io(this,$n,"m",no).call(this,t).then((()=>{var t;ao(this,Qn,new ze(ze.getIdOrCreateNewOne(),null!==(t=ze.getName())&&void 0!==t?t:e.customerName,e.customerImage,io(this,Yn,"f")),"f"),io(this,eo,"f").resolve()}))}catch(e){io(this,$n,"m",to).call(this,e)}}async ready(){return io(this,eo,"f").promise}async getChannelInfo(){return mt(u.BRAND_ID,u.CHANNEL_ID,u.LANGUAGE)}async getChannelAvailability(){return async function(e,t){const n=u.ENDPOINT_CHAT,o=await fetch(`${n}/chat/1.0/brand/${e}/channel/${t}/availability`,{method:"GET",headers:Object.assign({},Tt)});if(!o.ok){if(Et(await pt(o)))throw new ht;throw new h(`Failed to fetch channel availability. Status (${o.status})`,{response:o})}return o.json()}(u.BRAND_ID,u.CHANNEL_ID)}async authorize(e,t){var n,o,r,s,c;await this.ready();const T=l();if(null!==T)try{const e=await async function(e,t,n,o){const r=qe(n,o),s=await Ze(r,e);if(void 0!==s.error)throw new E("Authorization reconnect failed",s.error);return tt(n,t),{reconnected:!0}}(io(this,Yn,"f"),io(this,oo,"f"),T,t);return e}catch(e){}const p=async function(e,t){if(!Ye(e)&&!Ye(t))return{isAuthorizationEnabled:e,isLivechat:t};const n=await mt(u.BRAND_ID,u.CHANNEL_ID);return{isAuthorizationEnabled:n.isAuthorizationEnabled,isLivechat:n.isLiveChat}}(io(this,Kn,"f"),this.isLivechat),m=function(e,t=v()){return Object.assign({eventType:a.ow.AUTHORIZE_CUSTOMER,data:{authorization:{authorizationCode:e},disableChannelInfo:!0,sdkVersion:f,sdkPlatform:"web"}},_(t))}(null!==(n=null!=e?e:u.AUTHORIZATION_CODE)&&void 0!==n?n:null,t),g=Xe(Je(m),v(),i.V.REGISTER),C=Ge(g,io(this,Yn,"f")),[y,A]=await Promise.all([C,p]);if(!nt(y))throw null===(o=io(this,Yn,"f"))||void 0===o||o.disconnect(),new E("Authorization failed",y.error);const{consumerIdentity:S,customer:O,contact:w}=y.data,b=null==S?void 0:S.idOnExternalPlatform;if(Qe(I=b)||""===I)throw null===(r=io(this,Yn,"f"))||void 0===r||r.disconnect(),new h("Invalid customer identity");var I;return We(Object.assign({},S)),(null==O?void 0:O.customFields)&&(null===(s=io(this,Qn,"f"))||void 0===s||s.setCustomFieldsFromArray(O.customFields)),(null==w?void 0:w.customFields)&&Ue(io(this,Jn,"f"),w.customFields),ao(this,Kn,A.isAuthorizationEnabled,"f"),this.isLivechat=A.isLivechat,void 0!==(null===(c=y.data.accessToken)||void 0===c?void 0:c.token)&&(d(y.data.accessToken),tt(y.data.accessToken,io(this,oo,"f"))),y.data}async generateAuthorizationToken(e,t){const n=await Ze(function(e,t){return{eventType:a.ow.GENERATE_AUTHORIZATION_TOKEN,data:{thread:{idOnExternalPlatform:e},url:t}}}(e,t),io(this,Yn,"f"));if(!("authorizationToken"in n.data))throw new h("Invalid response from generate authorization token (generateAuthorizationToken)");const{authorizationToken:o}=n.data;return o}onChatEvent(e,t){return io(this,qn,"f").addEventListener(e,t),()=>{io(this,qn,"f").removeEventListener(e,t)}}getCustomer(){return io(this,Qn,"f")}getThread(e){if(c(io(this,Yn,"f")))throw new h("Cannot get thread because websocket is disconnected");if(Qe(e))throw new h("Cannot get thread because id is undefined");const t=io(this,Xn,"f").get(e);if(!Ye(t))return t;if(!0===this.isLivechat){const t=new Un(e,io(this,Yn,"f"),io(this,qn,"f"),io(this,Qn,"f"),this._getContactCustomFieldsFromQueue(),io(this,Kn,"f"));return io(this,Xn,"f").set(e,t),t}const n=new kn(e,io(this,Yn,"f"),io(this,qn,"f"),io(this,Qn,"f"),this._getContactCustomFieldsFromQueue(),io(this,Kn,"f"));return io(this,Xn,"f").set(e,n),n}async getThreadList(){if(c(io(this,Yn,"f")))throw new h("Cannot get thread list because websocket is disconnected");const e={eventType:a.ow.FETCH_THREAD_LIST,data:{}},t=await Ze(e,io(this,Yn,"f"));if(!Hn(t.data))throw new h("Invalid response from fetch thread list (getThreadList)");return t.data.threads}getWebsocketClient(){return io(this,Yn,"f")}async sendOfflineMessage(e){return(async(e,t)=>{const n=(e=>{const[t,...n]=e.name.split(" ").reverse(),o=n.reverse().join(" "),r={idOnExternalPlatform:e.email,firstName:o,lastName:t},s={messageContent:{type:jt.G.TEXT,payload:{text:e.message}},authorCustomerIdentity:r};return{eventType:a.ow.SEND_OFFLINE_MESSAGE,data:s}})(e),o=await Ze(n,t);if(Gt(o))return o;throw new kt("Send offline message failed",o)})(e,io(this,Yn,"f"))}recoverThreadData(e=void 0){return new mn((async(t,n)=>{const o=Pn(e),r=await Ze(o,io(this,Yn,"f"));Nn(r)?(this.getThread(r.data.thread.idOnExternalPlatform),io(this,qn,"f").dispatchEvent(new St(At.THREAD_RECOVERED,{detail:r})),t(r)):n(new h("Invalid response from recover livechat thread"))}))}recoverLivechatThreadData(e=void 0){return new mn((async(t,n)=>{const o=jn(e),r=await Ze(o,io(this,Yn,"f"));Nn(r)?(this.getThread(r.data.thread.idOnExternalPlatform),io(this,qn,"f").dispatchEvent(new St(At.LIVECHAT_RECOVERED,{detail:r})),t(r)):n(new h("Invalid response from recover livechat thread"))}))}async resetSession(e=v(),t="",n="",o="",r=v()){var s;null===(s=io(this,Yn,"f"))||void 0===s||s.disconnect(),ao(this,Yn,null,"f"),io(this,Xn,"f").clear(),io(this,Jn,"f").clear(),u.ACCESS_TOKEN=void 0,u.ACCESS_TOKEN_EXPIRES_IN=void 0,u.THIRD_PARTY_TOKEN=void 0,u.CACHE_STORAGE&&u.CACHE_STORAGE.removeItem(Lt),u.CACHE_STORAGE&&u.CACHE_STORAGE.removeItem(Ut),ze.destroy(),ze.setId(e),u.VISIT_ID=r,u.VISITOR_ID=o;try{await io(this,$n,"m",no).call(this,o),ao(this,Qn,new ze(e,t,n,io(this,Yn,"f")),"f")}catch(e){io(this,$n,"m",to).call(this,e)}}_getContactCustomFieldsFromQueue(){if(io(this,Jn,"f").size>0){const e=He(io(this,Jn,"f"));return io(this,Jn,"f").clear(),e}return{}}}function uo(e){var t,n;return e.type===At.ASSIGNED_AGENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function lo(e){var t,n;return e.type===At.AGENT_TYPING_STARTED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}function ho(e){var t,n;return e.type===At.AGENT_TYPING_ENDED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}Qn=new WeakMap,Kn=new WeakMap,Yn=new WeakMap,Jn=new WeakMap,Xn=new WeakMap,Zn=new WeakMap,qn=new WeakMap,eo=new WeakMap,oo=new WeakMap,$n=new WeakSet,to=function(e){const t=new h(e);if("function"!=typeof this.onError)throw t;this.onError(t)},no=async function(e){var t,n;if(!0===Qt())try{const t=io(this,Kn,"f")?u.AUTHORIZATION_CODE:void 0,{accessToken:o,cached:r,customerIdentity:s,thirdParty:i,contact:a}=await(async e=>{const t=u.CACHE_STORAGE?u.CACHE_STORAGE.getItem(Lt):null;if(t)return{accessToken:t,cached:!0};const n=Vt();try{const t=await Bt(n,function(e){const t={};return e&&(t.thirdParty={authorization_code:e,grant_type:"authorization_code"}),t}(e),{credentials:"include"});return o=t.accessToken,r=t.expiresIn,u.CACHE_STORAGE&&u.CACHE_STORAGE.setItem(Lt,o,1e3*r),t}catch(e){if(e instanceof h)throw e;throw new h("Failed to fetch transaction token",e)}var o,r})(t);if(s&&We(s),i&&$t(i),!0===r){const e=u.CACHE_STORAGE?u.CACHE_STORAGE.getItem(Ut):null;e&&$t(e),console.warn("UNSUPPORTED: Cached token detected")}(null==a?void 0:a.customFields)&&Ue(io(this,Jn,"f"),a.customFields),io(this,$n,"m",so).call(this,e),await(null===(n=io(this,Yn,"f"))||void 0===n?void 0:n.connect(o))}catch(e){io(this,$n,"m",to).call(this,e)}else try{io(this,$n,"m",so).call(this,e),await(null===(t=io(this,Yn,"f"))||void 0===t?void 0:t.connect())}catch(e){io(this,$n,"m",to).call(this,e)}},ro=function(e){if(e.environment===gt.custom){if(Pe(e.customEnvironment)||Qe(e.customEnvironment))throw new h('customEnvironment must be provided when environment is set to "custom"');return void Ct(e.customEnvironment)}const t=function(e){if(!(e in gt))throw new h(`Unknown environment: ${e}`);if(e===gt.custom)throw new h("The custom environment cannot be constructed using the built-in configuration");return{chat:`https://channels-de-${e}.niceincontact.com`.toLowerCase(),name:e,gateway:`wss://chat-gateway-de-${e}.niceincontact.com`.toLowerCase(),authorize:`https://digital-oauth-de-${e}.niceincontact.com`.toLowerCase()}}(e.environment);Ct(t)},so=function(e){const{brandId:t,channelId:n}=Ke(),o=ze.getId(),r=u.ENDPOINT_GATEWAY;Wn(o),Wn(r);const i=new URL(r),a=i.protocol,c=i.hostname,d=i.port,l=i.pathname.substring(1);ao(this,Yn,new an(t,n,o,{host:c,port:d,prefix:l,forceSecureProtocol:"wss:"===a},this.onError,e),"f"),io(this,Yn,"f").on(s.nF.MESSAGE,(async e=>{try{"function"==typeof this.onRawEvent&&this.onRawEvent(e);const t=await(async e=>{if(Qe(e))return null;if(e.type!==yt.m.EVENT_IN_S3)return e;const t=e.data.s3Object.url,n=await fetch(t);if(n.ok)return Dt(await n.json());throw new h("Failed to fetch S3 event data")})((e=>{const t=null==e?void 0:e.detail;if(!t)return;let n;try{n=JSON.parse(t.data)}catch(e){return}return Dt(n)})(e)),n=io(this,Zn,"f").process(t);if(!Qe(n)){const{type:e}=n;(e=>{const{id:t}=e;if(Me.has(t)){const n=Me.get(t);"function"==typeof n&&n(e),Me.delete(t)}})(n),io(this,qn,"f").dispatchEvent(new St(null!=e?e:"",{detail:n}))}}catch(e){io(this,$n,"m",to).call(this,e)}}))};const Eo=e=>{const t=e;return Number.isInteger(null==t?void 0:t.data.positionInQueue)&&!1===Pe(null==t?void 0:t.id)&&(null==t?void 0:t.type)===a.vc.SET_POSITION_IN_QUEUE};class fo extends h{}function vo(e){return{eventType:a.ow.CREATE_GROUP_CHAT_INVITE,data:{contact:{id:e}}}}async function _o(e,t){const n=await Ze(e,t);if(function(e){return e.type===At.GROUP_CHAT_INVITE_CREATED}(n))return n;throw new fo("Create invitation failed",n)}class To extends h{}function po(e){return{eventType:a.ow.JOIN_GROUP_CHAT,data:{invitation:{code:e}}}}async function mo(e,t){const n=await Ze(e,t);if(function(e){return e.type===At.GROUP_CHAT_JOINED}(n))return n;throw new To("Join Group chat failed",n)}function go(e){return{eventType:a.ow.LEAVE_GROUP_CHAT,data:{contact:{id:e}}}}async function Co(e,t){return Ze(e,t)}class yo extends h{}function Ao(e,t,n){return{eventType:a.ow.SEND_EMAIL_INVITE_TO_GROUP_CHAT,data:{contact:{id:e},invitation:{code:t},recipients:[{idOnExternalPlatform:n}]}}}async function So(e,t){const n=await Ze(e,t);if(function(e){return e.type===At.GROUP_CHAT_INVITE_SENT}(n))return n;throw new yo("Send Email Invitation failed",n)}class Oo extends Error{constructor(e){super(e),this.name="CacheStorageError"}}var wo,bo=function(e,t,n,o){if("a"===n&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?o:"a"===n?o.call(e):o?o.value:t.get(e)};class Io{constructor(e){if(wo.set(this,void 0),!(e&&e.getItem&&e.setItem&&e.removeItem))throw new Oo("CacheStorage: Storage is required");!function(e,t,n,o,r){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===o?r.call(e,n):r?r.value=n:t.set(e,n)}(this,wo,e,"f")}getItem(e){const t=bo(this,wo,"f").getItem(e);if(!t)return null;const{data:n,expiresAt:o=0}=JSON.parse(t);return o<(new Date).getTime()||Ye(n)?(bo(this,wo,"f").removeItem(e),null):n}removeItem(e){bo(this,wo,"f").removeItem(e)}setItem(e,t,n){const o={data:t,expiresAt:(new Date).getTime()+n};bo(this,wo,"f").setItem(e,JSON.stringify(o))}}wo=new WeakMap;var No=o(369);function Ro(e){return"object"==typeof e&&null!==e&&"reconnected"in e&&!0===e.reconnected}const Do=co;return r})()));