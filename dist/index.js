/*! For license information please see index.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("uuid"),require("ua-parser-js"));else if("function"==typeof define&&define.amd)define(["uuid","ua-parser-js"],t);else{var n="object"==typeof exports?t(require("uuid"),require("ua-parser-js")):t(e.uuid,e["ua-parser-js"]);for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(self,((e,t)=>(()=>{"use strict";var n={910:(e,t,n)=>{t.Nf=void 0;n(151),n(749);t.Nf=function(e){var t=Date.parse(e);return isNaN(t)&&(t=function(e){var t,n=/^(\d{4}-\d\d-\d\d([tT][\d:.]*)?)([zZ]|([+-])(\d\d):?(\d\d))?$/.exec(e)||[];if(n[1]){if((t=n[1].split(/\D/).map((function(e){return parseInt(e,10)||0})))[1]-=1,!(t=new Date(Date.UTC.apply(Date,t))).getDate())return NaN;if(n[5]){var r=60*parseInt(n[5],10);n[6]&&(r+=parseInt(n[6],10)),"+"===n[4]&&(r*=-1),r&&t.setUTCMinutes(t.getUTCMinutes()+r)}return t.getTime()}return NaN}(e)),new Date(t)}},749:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimeInMilliseconds=t.getTimeInSeconds=t.padDateTimeUnit=void 0,t.padDateTimeUnit=function(e){var t=Math.abs(Math.floor("string"==typeof e?Number(e):e));return(t<10?"0":"")+t},t.getTimeInSeconds=function(e){var t=e.hours,n=void 0===t?0:t,r=e.minutes,o=void 0===r?0:r,i=e.seconds;return 60*n*60+60*o+(void 0===i?0:i)},t.getTimeInMilliseconds=function(e){var n=e.hours,r=void 0===n?0:n,o=e.minutes,i=void 0===o?0:o,a=e.seconds,s=void 0===a?0:a,c=e.milliseconds,u=void 0===c?0:c;return 1e3*(0,t.getTimeInSeconds)({hours:r,minutes:i,seconds:s})+u}},151:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimezoneISOOffset=void 0;var r=n(749);t.getTimezoneISOOffset=function(e){void 0===e&&(e=new Date);var t=e.getTimezoneOffset();return"".concat(t>0?"-":"+").concat((0,r.padDateTimeUnit)(t/60),":").concat((0,r.padDateTimeUnit)(t%60))}},893:(e,t)=>{t.P=void 0,t.P=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},996:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventTargetPolyfill=void 0;var n=function(){function e(){this.listeners={}}return e.prototype.addEventListener=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){if(e in this.listeners)for(var n=this.listeners[e],r=0,o=n.length;r<o;r++)if(n[r]===t)return void n.splice(r,1)},e.prototype.dispatchEvent=function(e){if(!(e.type in this.listeners))return!0;for(var t=this.listeners[e.type].slice(),n=0,r=t.length;n<r;n++)t[n].call(this,e);return!e.defaultPrevented},e}();t.EventTargetPolyfill=n},455:(e,t,n)=>{t.xT=void 0;n(546),n(996),n(846);var r=n(982);Object.defineProperty(t,"xT",{enumerable:!0,get:function(){return r.WebSocketClientEvent}})},415:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.getPushUpdateWebSocket=t.setupSocketConnection=void 0;var i=n(846),a=n(982),s=null,c={forceSecureProtocol:!1,heartbeatAfterAuthorize:!1,maxRetries:20,maxReconnectionDelay:1e3};t.setupSocketConnection=function(e,t){if(void 0===t&&(t={}),"object"!=typeof t)throw new TypeError("Options parameter must be an object not a "+typeof t);var n=r(r({},c),t),u=n.forceSecureProtocol,l=n.heartbeatAfterAuthorize,d=o(n,["forceSecureProtocol","heartbeatAfterAuthorize"]),h=function(e,t){return t?"wss://"+e:("https:"===window.location.protocol?"wss:":"ws:")+"//"+e}(e,u);return s=new i.WebSocketClient(h,void 0,d),l?s.addEventListener(a.WebSocketClientEvent.MESSAGE,(function(e){"authorized"===JSON.parse(e.detail.data)&&(null==s||s.startHeartBeat())})):s.startHeartBeat(),s},t.getPushUpdateWebSocket=function(){return s}},546:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.HeartBeatState=void 0,(n=t.HeartBeatState||(t.HeartBeatState={})).DIED="died",n.DYING="dying",n.LIVING="living"},846:function(e,t,n){var r,o=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=t.HEART_BEAT_CHECK_TIMEOUT=t.HEART_BEAT_INTERVAL=void 0;var a=i(n(864)),s=n(996),c=n(546),u=n(982);t.HEART_BEAT_INTERVAL=3e3,t.HEART_BEAT_CHECK_TIMEOUT=3*t.HEART_BEAT_INTERVAL;var l=function(e){function n(n,r,o){var i=e.call(this)||this;return i.heartBeatTimeout=null,i.heartBeatCheckTimeout=null,i.sendHeartBeat=function(){i.send(JSON.stringify({action:"heartbeat"}))},i.handleHeartBeatResponse=function(){i.heartBeatState===c.HeartBeatState.DYING&&(i.heartBeatState=c.HeartBeatState.LIVING,i.dispatchHeartBeatState()),i.setHeartBeatCheckTimeout()},i.setHeartBeatCheckTimeout=function(){null!==i.heartBeatCheckTimeout&&clearTimeout(i.heartBeatCheckTimeout),i.heartBeatCheckTimeout=setTimeout((function(){i.heartBeatState=c.HeartBeatState.DYING,i.dispatchHeartBeatState()}),t.HEART_BEAT_CHECK_TIMEOUT)},i.dispatchHeartBeatState=function(){null!==i.heartBeatState&&i.dispatchEvent(new CustomEvent(i.heartBeatState))},i.isHeartBeatActive=function(){return null!==i.heartBeatState},i.heartBeatState=null,i.socket=new a.default(n,r,o),i.socket.onopen=function(){i.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.OPEN))},i.socket.onclose=function(e){i.socket.retryCount===(null==o?void 0:o.maxRetries)?i.heartBeatState=c.HeartBeatState.DIED:i.heartBeatState=c.HeartBeatState.DYING,i.dispatchHeartBeatState(),i.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.CLOSE,{detail:e}))},i.socket.onmessage=function(e){i.handleHeartBeatResponse(),"pong"!==JSON.parse(e.data)&&i.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.MESSAGE,{detail:e}))},i.socket.onerror=function(e){i.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.ERROR,{detail:e}))},i}return o(n,e),n.prototype.send=function(e){this.socket.send(e)},n.prototype.startHeartBeat=function(){var e=this,n=function(){e.sendHeartBeat(),e.heartBeatTimeout=setTimeout(n,t.HEART_BEAT_INTERVAL)};this.setHeartBeatCheckTimeout(),n(),this.heartBeatState=c.HeartBeatState.LIVING},n.prototype.stopHeartBeat=function(){null!==this.heartBeatTimeout&&clearTimeout(this.heartBeatTimeout),null!==this.heartBeatCheckTimeout&&clearTimeout(this.heartBeatCheckTimeout),this.heartBeatState=null},n}(s.EventTargetPolyfill);t.WebSocketClient=l},982:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClientEvent=void 0,(n=t.WebSocketClientEvent||(t.WebSocketClientEvent={})).CLOSE="close",n.ERROR="error",n.MESSAGE="message",n.OPEN="open"},864:(e,t,n)=>{n.r(t),n.d(t,{default:()=>h});var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},r(e,t)};function o(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function i(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(i(arguments[t]));return e}var s=function(e,t){this.target=t,this.type=e},c=function(e){function t(t,n){var r=e.call(this,"error",n)||this;return r.message=t.message,r.error=t,r}return o(t,e),t}(s),u=function(e){function t(t,n,r){void 0===t&&(t=1e3),void 0===n&&(n="");var o=e.call(this,"close",r)||this;return o.wasClean=!0,o.code=t,o.reason=n,o}return o(t,e),t}(s),l=function(){if("undefined"!=typeof WebSocket)return WebSocket},d={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const h=function(){function e(e,t,n){var r=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){r._debug("open event");var t=r._options.minUptime,n=void 0===t?d.minUptime:t;clearTimeout(r._connectTimeout),r._uptimeTimeout=setTimeout((function(){return r._acceptOpen()}),n),r._ws.binaryType=r._binaryType,r._messageQueue.forEach((function(e){var t;return null===(t=r._ws)||void 0===t?void 0:t.send(e)})),r._messageQueue=[],r.onopen&&r.onopen(e),r._listeners.open.forEach((function(t){return r._callEventListener(e,t)}))},this._handleMessage=function(e){r._debug("message event"),r.onmessage&&r.onmessage(e),r._listeners.message.forEach((function(t){return r._callEventListener(e,t)}))},this._handleError=function(e){r._debug("error event",e.message),r._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),r.onerror&&r.onerror(e),r._debug("exec error listeners"),r._listeners.error.forEach((function(t){return r._callEventListener(e,t)})),r._connect()},this._handleClose=function(e){r._debug("close event"),r._clearTimeouts(),r._shouldReconnect&&r._connect(),r.onclose&&r.onclose(e),r._listeners.close.forEach((function(t){return r._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?d.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,r=this._listeners[e.type];if(r)try{for(var o=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(r),i=o.next();!i.done;i=o.next()){var a=i.value;this._callEventListener(e,a)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,a(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?d.reconnectionDelayGrowFactor:t,r=e.minReconnectionDelay,o=void 0===r?d.minReconnectionDelay:r,i=e.maxReconnectionDelay,a=void 0===i?d.maxReconnectionDelay:i,s=0;return this._retryCount>0&&(s=o*Math.pow(n,this._retryCount-1))>a&&(s=a),this._debug("next delay",s),s},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,r=void 0===n?d.maxRetries:n,o=t.connectionTimeout,i=void 0===o?d.connectionTimeout:o,a=t.WebSocket,s=void 0===a?l():a;if(this._retryCount>=r)this._debug("max retries reached",this._retryCount,">=",r);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(u=s)||!u||2!==u.CLOSING)throw Error("No valid WebSocket class provided");var u;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled?e._connectLock=!1:(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new s(t,e._protocols):new s(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),i))})).catch((function(t){e._connectLock=!1,e._handleError(new c(Error(t.message),e))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new c(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new u(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}()},441:(e,t)=>{var n;(n=t.p||(t.p={})).CHAT_WINDOW_EVENT="chatWindowEvent",n.REGISTER="register"},154:(e,t)=>{var n,r;(r=t.YU||(t.YU={})).SENDER_TYPING_STARTED="SenderTypingStarted",r.SENDER_TYPING_ENDED="SenderTypingEnded",r.LOAD_MORE_MESSAGES="LoadMoreMessages",r.RECOVER_LIVECHAT="RecoverLivechat",r.RECOVER_THREAD="RecoverThread",r.SEND_MESSAGE="SendMessage",r.SEND_OUTBOUND="SendOutbound",r.SEND_OFFLINE_MESSAGE="SendOfflineMessage",r.SEND_PAGE_VIEWS="SendPageViews",r.SEND_CONSUMER_CUSTOM_FIELDS="SetConsumerCustomFields",r.SET_CONSUMER_CONTACT_CUSTOM_FIELD="SetConsumerContactCustomFields",r.MESSAGE_SEEN="MessageSeenByConsumer",r.SEND_TRANSCRIPT="SendTranscript",r.FETCH_THREAD_LIST="FetchThreadList",r.END_CONTACT="EndContact",r.EXECUTE_TRIGGER="ExecuteTrigger",r.AUTHORIZE_CONSUMER="AuthorizeConsumer",r.AUTHORIZE_CUSTOMER="AuthorizeCustomer",r.RECONNECT_CONSUMER="ReconnectConsumer",r.UPDATE_THREAD="UpdateThread",r.ARCHIVE_THREAD="ArchiveThread",r.LOAD_THREAD_METADATA="LoadThreadMetadata",r.REFRESH_TOKEN="RefreshToken",r.STORE_VISITOR="StoreVisitor",r.STORE_VISITOR_EVENTS="StoreVisitorEvents",r.CREATE_GROUP_CHAT_INVITE="CreateInvitationToGroupChat",r.SEND_EMAIL_INVITE_TO_GROUP_CHAT="SendEmailInvitationToGroupChat",r.JOIN_GROUP_CHAT="JoinGroupChat",r.LEAVE_GROUP_CHAT="LeaveGroupChat",r.GENERATE_AUTHORIZATION_TOKEN="GenerateAuthorizationToken",r.ADD_VISITOR_TAGS="AddVisitorTags",r.REMOVE_VISITOR_TAGS="RemoveVisitorTags",r.SEND_MESSAGE_PREVIEW="SendMessagePreview",(n=t.Ne||(t.Ne={})).LIVECHAT_RECOVERED="LivechatRecovered",n.MORE_MESSAGES_LOADED="MoreMessagesLoaded",n.OFFLINE_MESSAGE_SENT="OfflineMessageSent",n.THREAD_LIST_FETCHED="ThreadListFetched",n.THREAD_RECOVERED="ThreadRecovered",n.TRANSCRIPT_SENT="TranscriptSent",n.CONSUMER_AUTHORIZED="ConsumerAuthorized",n.THREAD_METADATA_LOADED="ThreadMetadataLoaded",n.SET_POSITION_IN_QUEUE="SetPositionInQueue",n.GROUP_CHAT_INVITE_CREATED="InvitationToGroupChatCreated",n.GROUP_CHAT_INVITE_SENT="EmailInvitationToGroupChatSent",n.GROUP_CHAT_JOINED="GroupChatJoined",n.TOKEN_REFRESHED="TokenRefreshed",n.AUTHORIZATION_TOKEN_GENERATED="AuthorizationTokenGenerated",n.THREAD_ARCHIVED="ThreadArchived"},58:(e,t)=>{var n;(n=t.Yi||(t.Yi={})).DESKTOP="desktop",n.MOBILE="mobile",n.OTHER="other",n.TABLET="tablet",(t.vQ||(t.vQ={})).BROWSER="browser"},510:(e,t)=>{var n;(n=t.T||(t.T={})).INBOUND="inbound",n.OUTBOUND="outbound"},115:(e,t)=>{var n;(n=t.C||(t.C={})).TEXT="TEXT",n.FILE="FILE",n.FORM="FORM",n.PLUGIN="PLUGIN",n.POSTBACK="POSTBACK",n.QUICK_REPLIES="QUICK_REPLIES",n.RICH_LINK="RICH_LINK",n.LIST_PICKER="LIST_PICKER",n.ADAPTIVE_CARD="ADAPTIVE_CARD"},256:(e,t)=>{var n;(n=t.y||(t.y={})).NEW="new",n.OPEN="open",n.PENDING="pending",n.ESCALATED="escalated",n.RESOLVED="resolved",n.CLOSED="closed",n.TRASHED="trashed"},403:(e,t)=>{var n;(n=t.m||(t.m={})).AUTHORIZE_CONSUMER="AuthorizeConsumer",n.CASE_CREATED="CaseCreated",n.CASE_INBOX_ASSIGNEE_CHANGED="CaseInboxAssigneeChanged",n.CASE_STATUS_CHANGED="CaseStatusChanged",n.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",n.CONTACT_CREATED="CaseCreated",n.ASSIGNED_AGENT_CHANGED="CaseInboxAssigneeChanged",n.CONTACT_STATUS_CHANGED="CaseStatusChanged",n.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",n.CONTACT_PREFERRED_USER_CHANGED="ContactPreferredUserChanged",n.CONTACT_SYNC="ContactSync",n.CHANNEL_CREATED="ChannelCreated",n.CHANNEL_DELETED="ChannelDeleted",n.CHANNEL_UPDATED="ChannelUpdated",n.MESSAGE_ADDED_INTO_CASE="MessageAddedIntoCase",n.MESSAGE_CREATED="MessageCreated",n.MESSAGE_DELIVERED_TO_END_USER="MessageDeliveredToEndUser",n.MESSAGE_DELIVERED_TO_USER="MessageDeliveredToUser",n.MESSAGE_NOTE_CREATED="MessageNoteCreated",n.MESSAGE_NOTE_UPDATED="MessageNoteUpdated",n.MESSAGE_NOTE_DELETED="MessageNoteDeleted",n.MESSAGE_READ_CHANGED="MessageReadChanged",n.MESSAGE_SEEN_BY_END_USER="MessageSeenByEndUser",n.MESSAGE_SEEN_BY_USER="MessageSeenByUser",n.MESSAGE_UPDATED="MessageUpdated",n.PAGE_VIEW_CREATED="PageViewCreated",n.ROUTING_QUEUE_CREATED="RoutingQueueCreated",n.ROUTING_QUEUE_DELETED="RoutingQueueDeleted",n.ROUTING_QUEUE_UPDATED="RoutingQueueUpdated",n.SUBQUEUE_ASSIGNED_TO_ROUTING_QUEUE="SubqueueAssignedToRoutingQueue",n.SUBQUEUE_UNASSIGNED_TO_ROUTING_QUEUE="SubqueueUnassignedFromRoutingQueue",n.USER_ASSIGNED_TO_ROUTING_QUEUE="UserAssignedToRoutingQueue",n.USER_STATUS_CHANGED="UserStatusChanged",n.USER_UNASSIGNED_FROM_ROUTING_QUEUE="UserUnassignedFromRoutingQueue",n.AGENT_CONTACT_STARTED="AgentContactStarted",n.AGENT_CONTACT_ENDED="AgentContactEnded",n.SENDER_TYPING_STARTED="SenderTypingStarted",n.SENDER_TYPING_ENDED="SenderTypingEnded",n.FIRE_PROACTIVE="FireProactiveAction",n.CONTACT_INBOX_PRE_ASSIGNEE_CHANGED="ConsumerContactInboxPreAssigneeChanged",n.CONTACT_RECIPIENTS_CHANGED="ContactRecipientsChanged",n.MESSAGE_PREVIEW_CREATED="MessagePreviewCreated"},585:e=>{e.exports=t},459:t=>{t.exports=e}},r={};function o(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={exports:{}};return n[e].call(i.exports,i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{o.r(i),o.d(i,{ChatEvent:()=>$e,ChatSdk:()=>tr,Customer:()=>Ye,EnvironmentName:()=>We,LivechatThread:()=>Kn,MessageType:()=>nt.C,Thread:()=>Vn,WebSocketClientError:()=>ct,WebSocketClientEvent:()=>ut,createCreateInvitationToGroupChatPayloadData:()=>cr,createJoinGroupChatPayloadData:()=>lr,createLeaveGroupChatPayloadData:()=>hr,createSendEmailInvitationToGroupChatPayloadData:()=>_r,default:()=>vr,generateId:()=>l.v4,getAuthor:()=>or,isAssignedAgentChangedEvent:()=>nr,isAuthSuccessEvent:()=>E,isContactCreatedEvent:()=>Wn,isContactStatusChangedEvent:()=>Yn,isContactToRoutingQueueAssignmentChangedEvent:()=>Qn,isLoadMetadataSuccessPayload:()=>Hn,isMessage:()=>ir,isMessageCreatedEvent:()=>ar,isMoreMessagesLoadedEvent:()=>kn,isRecoverSuccessEvent:()=>Ln,isSetPositionInQueuePayload:()=>sr,isThreadArchivedSuccessPayload:()=>xn,isThreadListFetchedPostbackData:()=>Jn,isTokenRefreshedSuccessResponse:()=>_,sendChatEvent:()=>Ve,sendCreateInvitationToGroupChatEvent:()=>ur,sendEmailInvitationToGroupChatEvent:()=>fr,sendJoinGroupChatEvent:()=>dr,sendLeaveGroupChatEvent:()=>Er,splitName:()=>Ge});var e,t=o(455),n=o(441),r=o(154);!function(e){e.ACCESS_TOKEN="ACCESS_TOKEN",e.ACCESS_TOKEN_EXPIRES_IN="ACCESS_TOKEN_EXPIRES_IN",e.AUTHORIZATION_CODE="AUTHORIZATION_CODE",e.BRAND_ID="BRAND_ID",e.CHANNEL_ID="CHANNEL_ID",e.CUSTOMER_ID="CUSTOMER_ID",e.CUSTOMER_NAME="CUSTOMER_NAME",e.ENDPOINT_CHAT="ENDPOINT_CHAT",e.ENDPOINT_GATEWAY="ENDPOINT_GATEWAY",e.THREAD_DATA="THREAD_DATA"}(e||(e={}));const a=new class{constructor(){this._vars={}}set(e,t){this._vars[e]=t}get(e,t){var n;return null!==(n=this._vars[e])&&void 0!==n?n:t}list(){return Object.keys(this._vars)}clear(){this._vars={}}},s=function(e){return null===e};function c(t){a.set(e.ACCESS_TOKEN,t.token),a.set(e.ACCESS_TOKEN_EXPIRES_IN,String(t.expiresIn))}function u(){const t=a.get(e.ACCESS_TOKEN,null),n=a.get(e.ACCESS_TOKEN_EXPIRES_IN,null);return s(t)||s(n)?null:{token:t,expiresIn:Number(n)}}var l=o(459);let d=null;function h(e,t){null!==d&&clearTimeout(d),d=setTimeout(t,1e3*function(e){const t=Math.round(.9*e);return t<20?20:t}(e.expiresIn))}const E=e=>{const{data:{status:t}={},type:n}=e;return n===r.Ne.CONSUMER_AUTHORIZED&&"success"===t};function _(e){var t,n;return(null==e?void 0:e.type)===r.Ne.TOKEN_REFRESHED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.accessToken)||void 0===n?void 0:n.token)}class f extends Error{constructor(e){super(`[ChatSDKError]: ${e instanceof Error?e.message:`Unknown error (${e})`}`),this.name="ChatSDKError"}}var v=Object.prototype;const p=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||v)},T=(y=Object.keys,C=Object,function(e){return y(C(e))});var y,C,m=Object.prototype.hasOwnProperty;const g=function(e){if(!p(e))return T(e);var t=[];for(var n in Object(e))m.call(e,n)&&"constructor"!=n&&t.push(n);return t},O="object"==typeof global&&global&&global.Object===Object&&global;var A="object"==typeof self&&self&&self.Object===Object&&self;const S=O||A||Function("return this")(),b=S.Symbol;var N=Object.prototype,w=N.hasOwnProperty,I=N.toString,D=b?b.toStringTag:void 0;var R=Object.prototype.toString;var U=b?b.toStringTag:void 0;const P=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":U&&U in Object(e)?function(e){var t=w.call(e,D),n=e[D];try{e[D]=void 0;var r=!0}catch(e){}var o=I.call(e);return r&&(t?e[D]=n:delete e[D]),o}(e):function(e){return R.call(e)}(e)},j=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},M=function(e){if(!j(e))return!1;var t=P(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},G=S["__core-js_shared__"];var k,H=(k=/[^.]+$/.exec(G&&G.keys&&G.keys.IE_PROTO||""))?"Symbol(src)_1."+k:"";var L=Function.prototype.toString;const x=function(e){if(null!=e){try{return L.call(e)}catch(e){}try{return e+""}catch(e){}}return""};var B=/^\[object .+?Constructor\]$/,F=Function.prototype,V=Object.prototype,z=F.toString,Y=V.hasOwnProperty,W=RegExp("^"+z.call(Y).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");const Q=function(e){return!(!j(e)||function(e){return!!H&&H in e}(e))&&(M(e)?W:B).test(x(e))},$=function(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Q(n)?n:void 0},K=$(S,"DataView"),J=$(S,"Map"),Z=$(S,"Promise"),X=$(S,"Set"),q=$(S,"WeakMap");var ee="[object Map]",te="[object Promise]",ne="[object Set]",re="[object WeakMap]",oe="[object DataView]",ie=x(K),ae=x(J),se=x(Z),ce=x(X),ue=x(q),le=P;(K&&le(new K(new ArrayBuffer(1)))!=oe||J&&le(new J)!=ee||Z&&le(Z.resolve())!=te||X&&le(new X)!=ne||q&&le(new q)!=re)&&(le=function(e){var t=P(e),n="[object Object]"==t?e.constructor:void 0,r=n?x(n):"";if(r)switch(r){case ie:return oe;case ae:return ee;case se:return te;case ce:return ne;case ue:return re}return t});const de=le,he=function(e){return null!=e&&"object"==typeof e},Ee=function(e){return he(e)&&"[object Arguments]"==P(e)};var _e=Object.prototype,fe=_e.hasOwnProperty,ve=_e.propertyIsEnumerable;const pe=Ee(function(){return arguments}())?Ee:function(e){return he(e)&&fe.call(e,"callee")&&!ve.call(e,"callee")},Te=Array.isArray,ye=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991},Ce=function(e){return null!=e&&ye(e.length)&&!M(e)};var me="object"==typeof exports&&exports&&!exports.nodeType&&exports,ge=me&&"object"==typeof module&&module&&!module.nodeType&&module,Oe=ge&&ge.exports===me?S.Buffer:void 0;const Ae=(Oe?Oe.isBuffer:void 0)||function(){return!1};var Se={};Se["[object Float32Array]"]=Se["[object Float64Array]"]=Se["[object Int8Array]"]=Se["[object Int16Array]"]=Se["[object Int32Array]"]=Se["[object Uint8Array]"]=Se["[object Uint8ClampedArray]"]=Se["[object Uint16Array]"]=Se["[object Uint32Array]"]=!0,Se["[object Arguments]"]=Se["[object Array]"]=Se["[object ArrayBuffer]"]=Se["[object Boolean]"]=Se["[object DataView]"]=Se["[object Date]"]=Se["[object Error]"]=Se["[object Function]"]=Se["[object Map]"]=Se["[object Number]"]=Se["[object Object]"]=Se["[object RegExp]"]=Se["[object Set]"]=Se["[object String]"]=Se["[object WeakMap]"]=!1;var be="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ne=be&&"object"==typeof module&&module&&!module.nodeType&&module,we=Ne&&Ne.exports===be&&O.process,Ie=function(){try{return Ne&&Ne.require&&Ne.require("util").types||we&&we.binding&&we.binding("util")}catch(e){}}(),De=Ie&&Ie.isTypedArray;const Re=De?function(e){return function(t){return e(t)}}(De):function(e){return he(e)&&ye(e.length)&&!!Se[P(e)]};var Ue=Object.prototype.hasOwnProperty;const Pe=function(e){if(null==e)return!0;if(Ce(e)&&(Te(e)||"string"==typeof e||"function"==typeof e.splice||Ae(e)||Re(e)||pe(e)))return!e.length;var t=de(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(p(e))return!g(e).length;for(var n in e)if(Ue.call(e,n))return!1;return!0},je=new Map,Me=async(e,t)=>{if(s(t))throw new f("WebSocketClient is not initialized");return Pe(e.eventId)&&(e.eventId=(0,l.v4)()),new Promise((n=>{je.set(e.eventId,n),null==t||t.send(e)}))};function Ge(e){const[t,...n]=e.split(" ");return[t,n.join(" ")]}function ke(e){const t=null!=e?e:Ye.getName();let n={};if("string"==typeof t&&t.length>0){const[e,r]=Ge(t);n={firstName:e,lastName:r}}return Object.assign({idOnExternalPlatform:Ye.getIdOrCreateNewOne()},n)}const He=function(e){return null==e};function Le(){const t=parseInt(a.get(e.BRAND_ID)),n=a.get(e.CHANNEL_ID);if(He(t)||isNaN(t)||He(n))throw new Error(`Cannot get BrandId and ChannelId from SDKVariableStorage \n      brandId (${t}) |\n      channelId (${n})`);return{brandId:t,channelId:n}}const xe=function(e){return void 0===e};function Be(e){const{eventType:t,data:n,consumerIdentity:r=ke(),destination:o={},visitor:i={}}=e,{brandId:a,channelId:s}=Le();if(xe(t))throw new f(`Cannot create an event payload because of missing eventType (${t})`);return{eventType:t,brand:{id:Number(a)},channel:{id:s},consumerIdentity:r,data:n,destination:o,visitor:i}}function Fe(e,t=(0,l.v4)(),r=n.p.CHAT_WINDOW_EVENT){return{action:r,eventId:t,payload:e}}async function Ve(e,t){const n=Fe(Be(e));return Me(n,t)}const ze=e=>Object.entries(e).map((([e,t])=>({ident:e,value:t})));class Ye{constructor(e,t,n){this.websocketClient=n,Ye.setId(e),Ye.setName(t)}static setId(t){a.set(e.CUSTOMER_ID,t)}static getId(){return a.get(e.CUSTOMER_ID,null)}static getName(){return a.get(e.CUSTOMER_NAME)}static setName(t){a.set(e.CUSTOMER_NAME,t)}static getIdOrCreateNewOne(){let e=this.getId();return e||(e=(0,l.v4)(),this.setId(e)),e}getId(){return Ye.getIdOrCreateNewOne()}getName(){return Ye.getName()}setName(e){Ye.setName(e)}async setCustomFields(e){if(xe(e))throw new f("Custom fields must be set");const t=function(e){return{eventType:r.YU.SEND_CONSUMER_CUSTOM_FIELDS,data:{customFields:ze(e)}}}(e);return Ve(t,this.websocketClient)}async setCustomField(e,t){if(xe(e)||xe(t))throw new f("Custom field name and value must be set");return this.setCustomFields({[e]:t})}}var We;!function(e){e.AU1="AU1",e.CA1="CA1",e.EU1="EU1",e.JP1="JP1",e.NA1="NA1",e.UK1="UK1",e.custom="custom"}(We||(We={}));var Qe=o(403);const $e=Object.assign(Object.assign(Object.assign({},Qe.m),r.Ne),{AGENT_TYPING_STARTED:"AgentTypingStarted",AGENT_TYPING_ENDED:"AgentTypingEnded",ASSIGNED_AGENT_CHANGED:"AssignedAgentChanged",CONTACT_CREATED:"ContactCreated",CONTACT_STATUS_CHANGED:"ContactStatusChanged",CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED:"ContactToRoutingQueueAssignmentChanged"});class Ke extends CustomEvent{}class Je{constructor(){this.middlewares=[]}register(e){this.middlewares.push(e)}process(e){if(void 0===e)return null;let t=e;for(const e of this.middlewares){if(null===t)return null;t=e(t)}return t}}const Ze=EventTarget;function Xe(e){return!He(null==e?void 0:e.user)}const qe={[$e.SENDER_TYPING_STARTED]:function(e){return Xe(e.data)?Object.assign(Object.assign({},e),{type:$e.AGENT_TYPING_STARTED}):e},[$e.SENDER_TYPING_ENDED]:function(e){return Xe(e.data)?Object.assign(Object.assign({},e),{type:$e.AGENT_TYPING_ENDED}):e},[$e.CASE_INBOX_ASSIGNEE_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:$e.ASSIGNED_AGENT_CHANGED})},[$e.CASE_CREATED]:function(e){return Object.assign(Object.assign({},e),{type:$e.CONTACT_CREATED})},[$e.CASE_STATUS_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:$e.CONTACT_STATUS_CHANGED})},[$e.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:$e.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED})}};function et(e){return e.type&&void 0!==qe[e.type]?qe[e.type](e):e}function tt(e){const t=!1===xe(null==e?void 0:e.id);return!1==(!1===xe(e.error))&&t}var nt=o(115);var rt=o(910),ot=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};const it={id:"",data:null,type:void 0,createdAt:new Date};var at=o(893),st=o(415);class ct extends Error{constructor(e,t=""){super(`[WebSocketClientError]: ${e}${t?` (${t})`:""}`),this.name="WebSocketClientError"}}const ut=t.xT;class lt{constructor(e,t,n,r,o){this.brandId=e,this.channelId=t,this.customerId=n,this.options=r,this.onError=o,this._connection=null,this.connect()}connect(){var e,t,n,r,o,i,a,s,c,u,l,d;const h=(null===(e=this.options)||void 0===e?void 0:e.port)?`:${null===(t=this.options)||void 0===t?void 0:t.port}`:"",E=(null===(n=this.options)||void 0===n?void 0:n.host)?`${null===(r=this.options)||void 0===r?void 0:r.host}${h}`:"",_=null!==(i=null===(o=this.options)||void 0===o?void 0:o.prefix)&&void 0!==i?i:"",f=null===(s=null===(a=this.options)||void 0===a?void 0:a.forceSecureProtocol)||void 0===s||s,v=function(e,t,n,r,o){const i={brandId:n,channelId:r,consumerId:o,v:"0"};return`${e}/${t}?${(0,at.P)(i)}`}(E,_,this.brandId,this.channelId,this.customerId);this._connection=(0,st.setupSocketConnection)(v,{startClosed:!0,forceSecureProtocol:f});const p=this._errorHandler.bind(this);null===(c=this._connection)||void 0===c||c.addEventListener(ut.CLOSE,p),null===(u=this._connection)||void 0===u||u.addEventListener(ut.ERROR,p),null===(d=null===(l=this._connection)||void 0===l?void 0:l.socket)||void 0===d||d.reconnect()}disconnect(){var e;null===(e=this._connection)||void 0===e||e.socket.close()}reconnect(){var e;null===(e=this._connection)||void 0===e||e.socket.reconnect()}send(e){var t;const n=JSON.stringify(e);null===(t=this._connection)||void 0===t||t.send(n)}on(e,t){var n;null===(n=this._connection)||void 0===n||n.addEventListener(e,t)}off(e,t){var n;null===(n=this._connection)||void 0===n||n.removeEventListener(e,t)}_errorHandler(e){const t=e.detail;let n;if(t instanceof ErrorEvent&&(n=new ct("Connection error",t.message)),t instanceof CloseEvent&&(n=new ct("Connection closed",t.reason)),void 0===n&&(n=new ct("Unknown error",t.type)),"function"!=typeof this.onError)throw n;this.onError(n)}}var dt=o(585),ht=o.n(dt),Et=o(58);const _t=()=>navigator.language,ft=()=>Intl.DateTimeFormat().resolvedOptions().timeZone;function vt(e){switch(e){case"mobile":return Et.Yi.MOBILE;case"tablet":return Et.Yi.TABLET;default:return Et.Yi.DESKTOP}}const pt=(e={})=>{var t,n,r,o;const i=new(ht())(navigator.userAgent),{country:a="",location:s=ft(),language:c=_t(),ip:u=null}=e;return{browser:null!==(t=i.getBrowser().name)&&void 0!==t?t:null,browserVersion:null!==(n=i.getBrowser().version)&&void 0!==n?n:null,country:a,ip:u,language:c,location:s,os:null!==(r=i.getOS().name)&&void 0!==r?r:null,osVersion:null!==(o=i.getOS().version)&&void 0!==o?o:null,deviceType:vt(i.getDevice().type),applicationType:Et.vQ.BROWSER}};function Tt(e){return!1===xe(null==e?void 0:e.allowedFileSize)}const yt=async(t,n,r)=>{const o=await(async e=>{const t=await function(e){return new Promise(((t,n)=>{const r=new FileReader;r.onloadend=()=>{t(r)},r.onerror=e=>{var t,r;return n(null===(r=null===(t=e.target)||void 0===t?void 0:t.error)||void 0===r?void 0:r.message)},r.readAsDataURL(e)}))}(e);if(null!==t.error)throw new f(`Cannot create payload for attachment upload because of error (${t.error.message})`);if("string"!=typeof t.result)throw new f(`Cannot create payload for attachment upload because of missing:\n      reader result (${t.result})`);return{url:t.result,name:e.name,mimeType:e.type}})(t),i=await async function(t,n,r){const o=a.get(e.ENDPOINT_CHAT),{url:i,name:s,mimeType:c}=r,u={content:i.split(";base64,")[1],fileName:s,mimeType:c},l=await fetch(`${o}/chat/1.0/brand/${t}/channel/${n}/attachment`,{method:"POST",body:JSON.stringify(u),headers:{"Content-Type":"application/json"}});if(!l.ok)throw new f(`Failed to upload Attachments. Status (${l.status})`);return l.json()}(n,r,o);if(!1===xe(null==(s=i)?void 0:s.fileUrl))return{url:i.fileUrl,friendlyName:o.name};var s;if(Tt(i))throw i;throw new f(`Unknown file upload response (${i})`)},Ct=function(e,t){return e===t||e!=e&&t!=t},mt=function(e,t){for(var n=e.length;n--;)if(Ct(e[n][0],t))return n;return-1};var gt=Array.prototype.splice;function Ot(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}Ot.prototype.clear=function(){this.__data__=[],this.size=0},Ot.prototype.delete=function(e){var t=this.__data__,n=mt(t,e);return!(n<0||(n==t.length-1?t.pop():gt.call(t,n,1),--this.size,0))},Ot.prototype.get=function(e){var t=this.__data__,n=mt(t,e);return n<0?void 0:t[n][1]},Ot.prototype.has=function(e){return mt(this.__data__,e)>-1},Ot.prototype.set=function(e,t){var n=this.__data__,r=mt(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this};const At=Ot,St=$(Object,"create");var bt=Object.prototype.hasOwnProperty;var Nt=Object.prototype.hasOwnProperty;function wt(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}wt.prototype.clear=function(){this.__data__=St?St(null):{},this.size=0},wt.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},wt.prototype.get=function(e){var t=this.__data__;if(St){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return bt.call(t,e)?t[e]:void 0},wt.prototype.has=function(e){var t=this.__data__;return St?void 0!==t[e]:Nt.call(t,e)},wt.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=St&&void 0===t?"__lodash_hash_undefined__":t,this};const It=wt,Dt=function(e,t){var n,r,o=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map};function Rt(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}Rt.prototype.clear=function(){this.size=0,this.__data__={hash:new It,map:new(J||At),string:new It}},Rt.prototype.delete=function(e){var t=Dt(this,e).delete(e);return this.size-=t?1:0,t},Rt.prototype.get=function(e){return Dt(this,e).get(e)},Rt.prototype.has=function(e){return Dt(this,e).has(e)},Rt.prototype.set=function(e,t){var n=Dt(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this};const Ut=Rt;function Pt(e){var t=this.__data__=new At(e);this.size=t.size}Pt.prototype.clear=function(){this.__data__=new At,this.size=0},Pt.prototype.delete=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n},Pt.prototype.get=function(e){return this.__data__.get(e)},Pt.prototype.has=function(e){return this.__data__.has(e)},Pt.prototype.set=function(e,t){var n=this.__data__;if(n instanceof At){var r=n.__data__;if(!J||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new Ut(r)}return n.set(e,t),this.size=n.size,this};const jt=Pt;function Mt(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new Ut;++t<n;)this.add(e[t])}Mt.prototype.add=Mt.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},Mt.prototype.has=function(e){return this.__data__.has(e)};const Gt=Mt,kt=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1},Ht=function(e,t){return e.has(t)},Lt=function(e,t,n,r,o,i){var a=1&n,s=e.length,c=t.length;if(s!=c&&!(a&&c>s))return!1;var u=i.get(e),l=i.get(t);if(u&&l)return u==t&&l==e;var d=-1,h=!0,E=2&n?new Gt:void 0;for(i.set(e,t),i.set(t,e);++d<s;){var _=e[d],f=t[d];if(r)var v=a?r(f,_,d,t,e,i):r(_,f,d,e,t,i);if(void 0!==v){if(v)continue;h=!1;break}if(E){if(!kt(t,(function(e,t){if(!Ht(E,t)&&(_===e||o(_,e,n,r,i)))return E.push(t)}))){h=!1;break}}else if(_!==f&&!o(_,f,n,r,i)){h=!1;break}}return i.delete(e),i.delete(t),h},xt=S.Uint8Array,Bt=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n},Ft=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n};var Vt=b?b.prototype:void 0,zt=Vt?Vt.valueOf:void 0;var Yt=Object.prototype.propertyIsEnumerable,Wt=Object.getOwnPropertySymbols;const Qt=Wt?function(e){return null==e?[]:(e=Object(e),function(e,t){for(var n=-1,r=null==e?0:e.length,o=0,i=[];++n<r;){var a=e[n];t(a,n,e)&&(i[o++]=a)}return i}(Wt(e),(function(t){return Yt.call(e,t)})))}:function(){return[]};var $t=/^(?:0|[1-9]\d*)$/;const Kt=function(e,t){var n=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&$t.test(e))&&e>-1&&e%1==0&&e<t};var Jt=Object.prototype.hasOwnProperty;const Zt=function(e,t){var n=Te(e),r=!n&&pe(e),o=!n&&!r&&Ae(e),i=!n&&!r&&!o&&Re(e),a=n||r||o||i,s=a?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],c=s.length;for(var u in e)!t&&!Jt.call(e,u)||a&&("length"==u||o&&("offset"==u||"parent"==u)||i&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||Kt(u,c))||s.push(u);return s},Xt=function(e){return Ce(e)?Zt(e):g(e)},qt=function(e){return function(e,t,n){var r=t(e);return Te(e)?r:function(e,t){for(var n=-1,r=t.length,o=e.length;++n<r;)e[o+n]=t[n];return e}(r,n(e))}(e,Xt,Qt)};var en=Object.prototype.hasOwnProperty;var tn="[object Arguments]",nn="[object Array]",rn="[object Object]",on=Object.prototype.hasOwnProperty;const an=function(e,t,n,r,o,i){var a=Te(e),s=Te(t),c=a?nn:de(e),u=s?nn:de(t),l=(c=c==tn?rn:c)==rn,d=(u=u==tn?rn:u)==rn,h=c==u;if(h&&Ae(e)){if(!Ae(t))return!1;a=!0,l=!1}if(h&&!l)return i||(i=new jt),a||Re(e)?Lt(e,t,n,r,o,i):function(e,t,n,r,o,i,a){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!i(new xt(e),new xt(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return Ct(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var s=Bt;case"[object Set]":var c=1&r;if(s||(s=Ft),e.size!=t.size&&!c)return!1;var u=a.get(e);if(u)return u==t;r|=2,a.set(e,t);var l=Lt(s(e),s(t),r,o,i,a);return a.delete(e),l;case"[object Symbol]":if(zt)return zt.call(e)==zt.call(t)}return!1}(e,t,c,n,r,o,i);if(!(1&n)){var E=l&&on.call(e,"__wrapped__"),_=d&&on.call(t,"__wrapped__");if(E||_){var f=E?e.value():e,v=_?t.value():t;return i||(i=new jt),o(f,v,n,r,i)}}return!!h&&(i||(i=new jt),function(e,t,n,r,o,i){var a=1&n,s=qt(e),c=s.length;if(c!=qt(t).length&&!a)return!1;for(var u=c;u--;){var l=s[u];if(!(a?l in t:en.call(t,l)))return!1}var d=i.get(e),h=i.get(t);if(d&&h)return d==t&&h==e;var E=!0;i.set(e,t),i.set(t,e);for(var _=a;++u<c;){var f=e[l=s[u]],v=t[l];if(r)var p=a?r(v,f,l,t,e,i):r(f,v,l,e,t,i);if(!(void 0===p?f===v||o(f,v,n,r,i):p)){E=!1;break}_||(_="constructor"==l)}if(E&&!_){var T=e.constructor,y=t.constructor;T==y||!("constructor"in e)||!("constructor"in t)||"function"==typeof T&&T instanceof T&&"function"==typeof y&&y instanceof y||(E=!1)}return i.delete(e),i.delete(t),E}(e,t,n,r,o,i))},sn=function e(t,n,r,o,i){return t===n||(null==t||null==n||!he(t)&&!he(n)?t!=t&&n!=n:an(t,n,r,o,e,i))},cn=function(e){return e==e&&!j(e)},un=function(e,t){return function(n){return null!=n&&n[e]===t&&(void 0!==t||e in Object(n))}},ln=function(e){var t=function(e){for(var t=Xt(e),n=t.length;n--;){var r=t[n],o=e[r];t[n]=[r,o,cn(o)]}return t}(e);return 1==t.length&&t[0][2]?un(t[0][0],t[0][1]):function(n){return n===e||function(e,t,n,r){var o=n.length,i=o,a=!r;if(null==e)return!i;for(e=Object(e);o--;){var s=n[o];if(a&&s[2]?s[1]!==e[s[0]]:!(s[0]in e))return!1}for(;++o<i;){var c=(s=n[o])[0],u=e[c],l=s[1];if(a&&s[2]){if(void 0===u&&!(c in e))return!1}else{var d=new jt;if(r)var h=r(u,l,c,e,t,d);if(!(void 0===h?sn(l,u,3,r,d):h))return!1}}return!0}(n,e,t)}},dn=function(e){return"symbol"==typeof e||he(e)&&"[object Symbol]"==P(e)};var hn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,En=/^\w*$/;const _n=function(e,t){if(Te(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!dn(e))||En.test(e)||!hn.test(e)||null!=t&&e in Object(t)};function fn(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var r=arguments,o=t?t.apply(this,r):r[0],i=n.cache;if(i.has(o))return i.get(o);var a=e.apply(this,r);return n.cache=i.set(o,a)||i,a};return n.cache=new(fn.Cache||Ut),n}fn.Cache=Ut;var vn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,pn=/\\(\\)?/g;const Tn=(yn=fn((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(vn,(function(e,n,r,o){t.push(r?o.replace(pn,"$1"):n||e)})),t}),(function(e){return 500===Cn.size&&Cn.clear(),e})),Cn=yn.cache,yn);var yn,Cn;var mn=b?b.prototype:void 0,gn=mn?mn.toString:void 0;const On=function e(t){if("string"==typeof t)return t;if(Te(t))return function(e,t){for(var n=-1,r=null==e?0:e.length,o=Array(r);++n<r;)o[n]=t(e[n],n,e);return o}(t,e)+"";if(dn(t))return gn?gn.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n},An=function(e,t){return Te(e)?e:_n(e,t)?[e]:Tn(function(e){return null==e?"":On(e)}(e))},Sn=function(e){if("string"==typeof e||dn(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t},bn=function(e,t){for(var n=0,r=(t=An(t,e)).length;null!=e&&n<r;)e=e[Sn(t[n++])];return n&&n==r?e:void 0},Nn=function(e,t){return null!=e&&t in Object(e)},wn=function(e,t){return null!=e&&function(e,t,n){for(var r=-1,o=(t=An(t,e)).length,i=!1;++r<o;){var a=Sn(t[r]);if(!(i=null!=e&&n(e,a)))break;e=e[a]}return i||++r!=o?i:!!(o=null==e?0:e.length)&&ye(o)&&Kt(a,o)&&(Te(e)||pe(e))}(e,t,Nn)},In=function(e,t){return _n(e)&&cn(t)?un(Sn(e),t):function(n){var r=function(e,t,n){var r=null==e?void 0:bn(e,t);return void 0===r?n:r}(n,e);return void 0===r&&r===t?wn(n,e):sn(t,r,3)}},Dn=function(e){return e},Rn=function(e){return _n(e)?(t=Sn(e),function(e){return null==e?void 0:e[t]}):function(e){return function(t){return bn(t,e)}}(e);var t},Un=function(e){return e!=e},Pn=function(e,t){return!(null==e||!e.length)&&function(e,t,n){return t==t?function(e,t,n){for(var r=n-1,o=e.length;++r<o;)if(e[r]===t)return r;return-1}(e,t,n):function(e,t,n,r){for(var o=e.length,i=n+(r?1:-1);r?i--:++i<o;)if(t(e[i],i,e))return i;return-1}(e,Un,n)}(e,t,0)>-1},jn=function(e,t,n){for(var r=-1,o=null==e?0:e.length;++r<o;)if(n(t,e[r]))return!0;return!1},Mn=X&&1/Ft(new X([,-0]))[1]==1/0?function(e){return new X(e)}:function(){},Gn=function(e,t){return e&&e.length?function(e,t,n){var r=-1,o=Pn,i=e.length,a=!0,s=[],c=s;if(n)a=!1,o=jn;else if(i>=200){var u=t?null:Mn(e);if(u)return Ft(u);a=!1,o=Ht,c=new Gt}else c=t?[]:s;e:for(;++r<i;){var l=e[r],d=t?t(l):l;if(l=n||0!==l?l:0,a&&d==d){for(var h=c.length;h--;)if(c[h]===d)continue e;t&&c.push(d),s.push(l)}else o(c,d,n)||(c!==s&&c.push(d),s.push(l))}return s}(e,"function"==typeof(n=t)?n:null==n?Dn:"object"==typeof n?Te(n)?In(n[0],n[1]):ln(n):Rn(n)):[];var n};function kn(e){var t;return e.type===r.Ne.MORE_MESSAGES_LOADED&&void 0!==(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.messages)}const Hn=e=>e.type===r.Ne.THREAD_METADATA_LOADED&&void 0!==e.data.lastMessage,Ln=e=>{const t=e.data,n=!1===xe(t),o=!1===xe(null==t?void 0:t.messages),i=e.type===r.Ne.THREAD_RECOVERED||e.type===r.Ne.LIVECHAT_RECOVERED,a=xe(e.error);return n&&o&&a&&i};function xn(e){return e.type===r.Ne.THREAD_ARCHIVED}function Bn(e){const t={eventType:r.YU.RECOVER_THREAD,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}function Fn(e){return{eventType:r.YU.SENDER_TYPING_ENDED,data:{thread:{idOnExternalPlatform:e}}}}class Vn{constructor(e,t,n,r=!1){this._exists=!1,this._typingTimeoutID=void 0,this._threadCustomFieldsQueue={},this._isAuthorizationEnabled=!1,this.idOnExternalPlatform=e,this._websocketClient=t,this._messageEmitter=n,this._isAuthorizationEnabled=r,this._registerEventHandlers()}async recover(){const e=await Ve(Bn(this.idOnExternalPlatform),this._websocketClient);if(Ln(e))return e.data;throw e}async sendMessage(e){const t=this._mergeCustomFieldsAndAccessTokenWithMessageData(e),n=await(async(e,t)=>{const n=(o=e,{eventType:r.YU.SEND_MESSAGE,data:o});var o;const i=await Ve(n,t);if(tt(i))return i;throw i})(t,this._websocketClient);return this._threadCustomFieldsQueue={},n}async sendTextMessage(e,t={}){const{messageId:n=(0,l.v4)(),browserFingerprint:r=pt(),threadCustomFields:o={}}=t,i=ze(o),a=((e,t,n,r=[],o=[],i=pt())=>({messageContent:{payload:{text:e},type:nt.C.TEXT},browserFingerprint:i,idOnExternalPlatform:t,thread:{idOnExternalPlatform:n},consumer:{customFields:o},consumerContact:{customFields:r},attachments:[]}))(e,n,this.idOnExternalPlatform,i,[],r);return this.sendMessage(a)}async sendOutboundMessage(e){return(async(e,t)=>{const n=(o=e,{eventType:r.YU.SEND_OUTBOUND,data:o});var o;const i=await Ve(n,t);if(tt(i))return i;throw i})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e),this._websocketClient)}async loadMoreMessages(){var t;const{scrollToken:n,oldestMessageDatetime:o}=null!==(t=JSON.parse(a.get(e.THREAD_DATA,"{}")))&&void 0!==t?t:{};if(Pe(n))return null;const i={scrollToken:n,oldestMessageDatetime:o,thread:{idOnExternalPlatform:this.idOnExternalPlatform}},s=await Ve((c=i,{eventType:r.YU.LOAD_MORE_MESSAGES,data:c}),this._websocketClient);var c;if(kn(s))return s;throw s}async lastMessageSeen(){var e;return Ve((e=this.idOnExternalPlatform,{eventType:r.YU.MESSAGE_SEEN,data:{thread:{idOnExternalPlatform:e}}}),this._websocketClient)}async sendAttachments(e,t={}){if(xe(e)||0===e.length)throw new f("FileList must be provided to sendAttachment method");const n=await(async(e,t,n={})=>{const{brandId:r,channelId:o}=Le();try{const i=await Promise.all(Array.from(e).map((async e=>yt(e,r,o)))),{messageId:a=(0,l.v4)(),browserFingerprint:s=pt(),threadCustomFields:c={}}=n;return{messageContent:{type:nt.C.TEXT,payload:{text:""}},attachments:i,browserFingerprint:s,thread:{idOnExternalPlatform:t},idOnExternalPlatform:a,consumer:{customFields:[]},consumerContact:{customFields:ze(c)}}}catch(e){if(Tt(e))throw e;if(e instanceof Error)throw new f(`Send attachment failed because of (${e.message})`);throw new f("Unknown error during file upload")}})(e,this.idOnExternalPlatform,t);return this.sendMessage(n)}keystroke(e=1e3){var t;this._typingTimeoutID||Ve((t=this.idOnExternalPlatform,{eventType:r.YU.SENDER_TYPING_STARTED,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient),clearTimeout(this._typingTimeoutID),this._typingTimeoutID=setTimeout((()=>{Ve(Fn(this.idOnExternalPlatform),this._websocketClient),this._typingTimeoutID=void 0}),e)}stopTyping(){clearTimeout(this._typingTimeoutID),this._typingTimeoutID=void 0,Ve(Fn(this.idOnExternalPlatform),this._websocketClient)}async getMetadata(){const e=await Ve((t=this.idOnExternalPlatform,{eventType:r.YU.LOAD_THREAD_METADATA,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(Hn(e))return e;throw e}onThreadEvent(e,t){const n=((e,t)=>n=>{(e=>{var t,n,r,o,i,a,s;const c=e;return null!==(a=null!==(o=null!==(n=null===(t=null==c?void 0:c.thread)||void 0===t?void 0:t.idOnExternalPlatform)&&void 0!==n?n:null===(r=null==c?void 0:c.case)||void 0===r?void 0:r.threadIdOnExternalPlatform)&&void 0!==o?o:null===(i=null==c?void 0:c.message)||void 0===i?void 0:i.threadIdOnExternalPlatform)&&void 0!==a?a:null===(s=null==c?void 0:c.messagePreview)||void 0===s?void 0:s.threadIdOnExternalPlatform})(n.detail.data)===e&&t(n)})(this.idOnExternalPlatform,t);return this._messageEmitter.addEventListener(e,n),()=>{this._messageEmitter.removeEventListener(e,n)}}async setCustomFields(e){if(this._threadCustomFieldsQueue=Object.assign(Object.assign({},this._threadCustomFieldsQueue),e),!1===this._exists)return;const t=function(e,t){return{eventType:r.YU.SET_CONSUMER_CONTACT_CUSTOM_FIELD,data:{customFields:ze(e),thread:{idOnExternalPlatform:t}}}}(this._threadCustomFieldsQueue,this.idOnExternalPlatform);await Ve(t,this._websocketClient),this._threadCustomFieldsQueue={}}setCustomField(e,t){return this.setCustomFields({[e]:t})}async archive(){const e=await Ve((t=this.idOnExternalPlatform,{eventType:r.YU.ARCHIVE_THREAD,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(xn(e))return!0;throw e}async setName(e){const t=(n=this.idOnExternalPlatform,o=e,{eventType:r.YU.UPDATE_THREAD,data:{thread:{idOnExternalPlatform:n,threadName:o}}});var n,o;const i=await Ve(t,this._websocketClient);if(function(e){return xe(e.error)}(i))return!0;throw i}async sendMessagePreview(e){const t=((e,t)=>({eventType:r.YU.SEND_MESSAGE_PREVIEW,data:{thread:{idOnExternalPlatform:e},messageContent:{payload:{text:t},type:nt.C.TEXT}}}))(this.idOnExternalPlatform,e);await Ve(t,this._websocketClient)}async sendTranscript(e,t){const n=((e,t)=>({eventType:r.YU.SEND_TRANSCRIPT,data:{consumerContact:{id:e},consumerRecipients:[{idOnExternalPlatform:t}]}}))(e,t);return Ve(n,this._websocketClient)}_mergeCustomFieldsAndAccessTokenWithMessageData(e){var t,n;const r=((e,t)=>{const n=ze(e);return Gn([...t,...n],"ident")})(this._threadCustomFieldsQueue,null!==(t=e.consumerContact.customFields)&&void 0!==t?t:[]),o=null!==(n=this._isAuthorizationEnabled&&u())&&void 0!==n&&n,i=!1!==o?{accessToken:{token:o.token}}:{};return Object.assign(Object.assign(Object.assign({},e),i),{consumerContact:{customFields:r}})}_registerEventHandlers(){this.onThreadEvent($e.CASE_CREATED,(()=>this._exists=!0)),this.onThreadEvent($e.CONTACT_CREATED,(()=>this._exists=!0)),this.onThreadEvent($e.THREAD_RECOVERED,(()=>{this._exists=!0}))}}var zn=o(256);function Yn(e){var t,n;return e.type===$e.CONTACT_STATUS_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Wn(e){var t,n;return e.type===$e.CONTACT_CREATED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Qn(e){var t,n;return e.type===$e.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function $n(e){const t={eventType:r.YU.RECOVER_LIVECHAT,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}class Kn extends Vn{constructor(e,t,n,r=!1){super(e,t,n,r),this._isInitialized=!1,this._canSendMessage=!0,this._registerLivechatEventHandlers()}async recover(){const e=await Ve($n(this.idOnExternalPlatform),this._websocketClient);if(Ln(e))return e.data;throw e}async sendMessage(e){if(!1===this._canSendMessage)throw new f("Cannot send more messages to closed Contact");return super.sendMessage(e)}async startChat(e="Begin conversation"){if(this._isInitialized)throw new f("Chat is already initialized");try{const t=await this.sendTextMessage(e);return this._isInitialized=!0,t}catch(e){if(e instanceof Error)throw new f(`Sending initial message failed because of (${e.message})`);return}}async endChat(){const t=a.get(e.THREAD_DATA,"{}"),n=JSON.parse(t),o=null==n?void 0:n.contactId;if(xe(o))throw new f("Cannot end Chat because of missing ContactId in the storage");await Ve(function(e,t){return{eventType:r.YU.END_CONTACT,data:{thread:{idOnExternalPlatform:e},contact:{id:t}}}}(this.idOnExternalPlatform,o),this._websocketClient)}_registerLivechatEventHandlers(){this.onThreadEvent($e.CONTACT_STATUS_CHANGED,(e=>{Yn(e.detail)&&e.detail.data.case.status===zn.y.CLOSED&&(this._canSendMessage=!1)})),this.onThreadEvent($e.LIVECHAT_RECOVERED,(e=>{var t,n,r;Ln(e.detail)&&(this._exists=!0,(null!==(n=null===(t=e.detail.data.consumerContact)||void 0===t?void 0:t.status)&&void 0!==n?n:null===(r=e.detail.data.contact)||void 0===r?void 0:r.status)===zn.y.CLOSED&&(this._canSendMessage=!1))}))}}const Jn=e=>"threads"in e;function Zn(t){const n=a.get(e.THREAD_DATA,"{}"),r=JSON.parse(n)||{};a.set(e.THREAD_DATA,JSON.stringify(Object.assign(Object.assign({},r),{contactId:t})))}function Xn(e){var t,n,r;return Wn(e)&&Zn(e.data.case.id),Ln(e)&&Zn(null!==(n=null===(t=e.data.consumerContact)||void 0===t?void 0:t.caseId)&&void 0!==n?n:null===(r=e.data.contact)||void 0===r?void 0:r.id),e}function qn(t){var n;const r=null===(s=t.messages,n=(c=null==s?0:s.length)?s[c-1]:void 0)||void 0===n?void 0:n.createdAt,o=a.get(e.THREAD_DATA,"{}"),i=JSON.parse(o)||{};var s,c;a.set(e.THREAD_DATA,JSON.stringify(Object.assign(Object.assign({},i),{scrollToken:t.scrollToken,oldestMessageDatetime:xe(r)?"":r})))}function er(e){if(Ln(e)){const{messages:t,messagesScrollToken:n}=e.data;qn({messages:t,scrollToken:n})}if(kn(e)){const{scrollToken:t,messages:n}=e.data;qn({scrollToken:t,messages:n})}return e}class tr{constructor(t){if(this.isLivechat=!1,this.channelId="",this.websocketClient=null,this.customer=null,this._incomingChatEventMiddleware=new Je,this.isAuthorizationEnabled=!1,this._threadCache=new Map,this._sendRefreshTokenEvent=async()=>{const e=u();if(s(e))return;const t=await Ve((n=e.token,{eventType:r.YU.REFRESH_TOKEN,data:{accessToken:{token:n}}}),this.websocketClient);var n;if(_(t))return c(t.data.accessToken),void h(t.data.accessToken,this._sendRefreshTokenEvent);throw t},void 0===t)throw new Error("No options was provided for initialization of ChatSdk");a.set(e.AUTHORIZATION_CODE,t.authorizationCode),a.set(e.BRAND_ID,`${t.brandId}`),a.set(e.CHANNEL_ID,t.channelId);const{brandId:n,channelId:o}=Le();this.onError=t.onError,this.onRawEvent=t.onRawEvent,this._incomingChatEventMiddleware.register(et),this._incomingChatEventMiddleware.register(er),this._incomingChatEventMiddleware.register(Xn),this._messageEmitter=new Ze;try{if(isNaN(n))throw new Error("Missing BrandID");if(void 0===o)throw new Error("Missing ChannelId");if(void 0===t.customerId)throw new Error("Missing CustomerId");this._initEnvironment(t),this._initWS(n,o,t.customerId),this.customer=new Ye(t.customerId,t.customerName,this.websocketClient),this.channelId=o}catch(e){this.onErrorHandler(e)}}onErrorHandler(e){if("function"!=typeof this.onError)throw new f(e);this.onError(new f(e))}async authorize(t,o){var i,s,u,d,_,f,v,p,T,y,C,m;const g=function(e,t=(0,l.v4)()){return Object.assign({eventType:r.YU.AUTHORIZE_CONSUMER,data:{authorization:{authorizationCode:e}}},function(e){return{visitor:{id:e}}}(t))}(null!=t?t:a.get(e.AUTHORIZATION_CODE,null),o),O=Fe(Be(g),(0,l.v4)(),n.p.REGISTER),A=await Me(O,this.websocketClient);if(E(A))return this.isLivechat=null!==(d=null===(u=null===(s=null===(i=A.data)||void 0===i?void 0:i.channel)||void 0===s?void 0:s.settings)||void 0===u?void 0:u.isLivechat)&&void 0!==d&&d,this.isAuthorizationEnabled=null!==(f=null===(_=A.data.channel)||void 0===_?void 0:_.settings.isAuthorizationEnabled)&&void 0!==f&&f,void 0!==(null===(v=A.data.accessToken)||void 0===v?void 0:v.token)&&(c(A.data.accessToken),void 0===(null===(T=null===(p=A.data)||void 0===p?void 0:p.consumerIdentity)||void 0===T?void 0:T.firstName)&&void 0===(null===(C=null===(y=A.data)||void 0===y?void 0:y.consumerIdentity)||void 0===C?void 0:C.lastName)||null===(m=this.customer)||void 0===m||m.setName(`${A.data.consumerIdentity.firstName} ${A.data.consumerIdentity.lastName}`),h(A.data.accessToken,this._sendRefreshTokenEvent)),A.data;throw A}async generateAuthorizationToken(e,t){const n=await Ve(function(e,t){return{eventType:r.YU.GENERATE_AUTHORIZATION_TOKEN,data:{thread:{idOnExternalPlatform:e},url:t}}}(e,t),this.websocketClient);if(!("authorizationToken"in n.data))throw new f("Invalid response from generate authorization token (generateAuthorizationToken)");const{authorizationToken:o}=n.data;return o}onChatEvent(e,t){return this._messageEmitter.addEventListener(e,t),()=>{this._messageEmitter.removeEventListener(e,t)}}getCustomer(){return this.customer}getThread(e){if(s(this.websocketClient))throw new f("Cannot get thread because websocket is disconnected");if(He(e))throw new f("Cannot get thread because id is undefined");const t=this._threadCache.get(e);if(!xe(t))return t;if(this.isLivechat){const t=new Kn(e,this.websocketClient,this._messageEmitter,this.isAuthorizationEnabled);return this._threadCache.set(e,t),t}const n=new Vn(e,this.websocketClient,this._messageEmitter,this.isAuthorizationEnabled);return this._threadCache.set(e,n),n}async getTheadList(){if(s(this.websocketClient))throw new f("Cannot get thread list because websocket is disconnected");const e={eventType:r.YU.FETCH_THREAD_LIST,data:{}},t=await Ve(e,this.websocketClient);if(!Jn(t.data))throw new f("Invalid response from fetch thread list (getTheadList)");return t.data.threads}getWebsocketClient(){return this.websocketClient}async sendOfflineMessage(e){return(async(e,t)=>{const n=(e=>{const[t,...n]=e.name.split(" ").reverse(),o=n.reverse().join(" "),i={idOnExternalPlatform:e.email,firstName:o,lastName:t},a={messageContent:{type:nt.C.TEXT,payload:{text:e.message}}};return{eventType:r.YU.SEND_OFFLINE_MESSAGE,consumerIdentity:i,data:a}})(e),o=await Ve(n,t);if(tt(o))return o;throw o})(e,this.websocketClient)}async recoverThreadData(e){const t=Bn(e),n=await Ve(t,this.websocketClient);if(!Ln(n))throw new f("Invalid response from recover livechat thread");return n}async recoverLivechatThreadData(e){const t=$n(e),n=await Ve(t,this.websocketClient);if(!Ln(n))throw new f("Invalid response from recover livechat thread");return n}_initEnvironment(t){var n,r;if(t.environment===We.custom){if(Pe(t.customEnvironment))throw new Error('customEnvironment must be provided when environment is set to "custom"');return a.set(e.ENDPOINT_GATEWAY,null===(n=t.customEnvironment)||void 0===n?void 0:n.gateway),void a.set(e.ENDPOINT_CHAT,null===(r=t.customEnvironment)||void 0===r?void 0:r.chat)}const{gateway:o,chat:i}=function(e){const t="{ENV}",n="https://channels-de-{ENV}.niceincontact.com",r="wss://chat-gateway-de-{ENV}.niceincontact.com";switch(e){case We.AU1:return{chat:n.replace(t,"au1"),name:"Australia",gateway:r.replace(t,"au1")};case We.CA1:return{chat:n.replace(t,"ca1"),name:"Canada",gateway:r.replace(t,"ca1")};case We.EU1:return{chat:n.replace(t,"eu1"),name:"Europe",gateway:r.replace(t,"eu1")};case We.JP1:return{chat:n.replace(t,"jp1"),name:"Japan",gateway:r.replace(t,"jp1")};case We.NA1:return{chat:n.replace(t,"na1"),name:"North America",gateway:r.replace(t,"na1")};case We.UK1:return{chat:n.replace(t,"uk1"),name:"United Kingdom",gateway:r.replace(t,"uk1")};case We.custom:return{chat:"",name:"Custom",gateway:""};default:throw new Error(`Unknown environment: ${e}`)}}(t.environment);a.set(e.ENDPOINT_GATEWAY,o),a.set(e.ENDPOINT_CHAT,i)}_initWS(n,r,o){const i=a.get(e.ENDPOINT_GATEWAY);!function(e){if(null==e)throw Error(`Expected non-nullish value, got ${e}`)}(i);const s=new URL(i),c=s.protocol,u={host:s.hostname,port:s.port,prefix:s.pathname.substring(1),forceSecureProtocol:"wss:"===c};this.websocketClient=new lt(n,r,o,u,this.onError),this.websocketClient.on(t.xT.MESSAGE,(e=>{try{"function"==typeof this.onRawEvent&&this.onRawEvent(e);const t=this._incomingChatEventMiddleware.process((e=>{const t=null==e?void 0:e.detail;if(!t)return;let n;try{n=JSON.parse(t.data)}catch(e){return}return function(e){if(!(e=>"eventId"in e)(e))return it;if((e=>"error"in e)(e))return{createdAt:(0,rt.Nf)(e.createdAt),data:null,error:e.error,id:e.eventId};const t=(e=>"eventType"in e)(e)?e.eventType:void 0;if((e=>"data"in e)(e))return{createdAt:(0,rt.Nf)(e.createdAt),context:e.context,data:e.data,id:e.eventId,type:t};if((e=>{const t=null==e?void 0:e.postback;return!1===Pe(t)})(e)){const{postback:{data:t,eventType:n},eventId:r}=e,o=ot(e,["postback","eventId"]);return{type:n,data:Object.assign(Object.assign({},o),t),createdAt:(0,rt.Nf)(e.createdAt),id:r}}const{eventId:n}=e,r=ot(e,["eventId"]);return Object.assign(Object.assign({data:void 0},r),{id:n,type:t,createdAt:(0,rt.Nf)(e.createdAt)})}(n)})(e));if(!He(t)){const{type:e}=t;(e=>{const{id:t}=e;if(je.has(t)){const n=je.get(t);"function"==typeof n&&n(e),je.delete(t)}})(t),this._messageEmitter.dispatchEvent(new Ke(null!=e?e:"",{detail:t}))}}catch(e){this.onErrorHandler(e)}}))}}function nr(e){var t,n;return e.type===$e.ASSIGNED_AGENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}var rr=o(510);const or=e=>{var t,n,r,o,i,a;return e.direction===rr.T.INBOUND?null!==(n=null===(t=e.authorEndUserIdentity)||void 0===t?void 0:t.fullName)&&void 0!==n?n:"":`${null!==(o=null===(r=e.authorUser)||void 0===r?void 0:r.firstName)&&void 0!==o?o:""} ${null!==(a=null===(i=e.authorUser)||void 0===i?void 0:i.surname)&&void 0!==a?a:""}`.trim()};function ir(e){const t=!1===xe(e.id),n=!1===xe(e.direction),r=!1===xe(e.messageContent);return t&&n&&r}function ar(e){return e.type===Qe.m.MESSAGE_CREATED}const sr=e=>{const t=e;return Number.isInteger(null==t?void 0:t.data.positionInQueue)&&!1===Pe(null==t?void 0:t.eventId)&&(null==t?void 0:t.eventType)===r.Ne.SET_POSITION_IN_QUEUE};function cr(e){return{eventType:r.YU.CREATE_GROUP_CHAT_INVITE,data:{contact:{id:e}}}}async function ur(e,t){const n=await Ve(e,t);if(function(e){return e.type===$e.GROUP_CHAT_INVITE_CREATED}(n))return n;throw n}function lr(e){return{eventType:r.YU.JOIN_GROUP_CHAT,data:{invitation:{code:e}}}}async function dr(e,t){const n=await Ve(e,t);if(function(e){return e.type===$e.GROUP_CHAT_JOINED}(n))return n;throw n}function hr(e){return{eventType:r.YU.LEAVE_GROUP_CHAT,data:{contact:{id:e}}}}async function Er(e,t){return Ve(e,t)}function _r(e,t,n){return{eventType:r.YU.SEND_EMAIL_INVITE_TO_GROUP_CHAT,data:{contact:{id:e},invitation:{code:t},recipients:[{idOnExternalPlatform:n}]}}}async function fr(e,t){const n=await Ve(e,t);if(function(e){return e.type===$e.GROUP_CHAT_INVITE_SENT}(n))return n;throw n}const vr=tr})(),i})()));