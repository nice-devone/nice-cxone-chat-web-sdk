/*! For license information please see index.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("uuid"),require("ua-parser-js"));else if("function"==typeof define&&define.amd)define(["uuid","ua-parser-js"],t);else{var n="object"==typeof exports?t(require("uuid"),require("ua-parser-js")):t(e.uuid,e["ua-parser-js"]);for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(self,((e,t)=>(()=>{"use strict";var n={910:(e,t,n)=>{t.Nf=void 0;n(151),n(749);t.Nf=function(e){var t=Date.parse(e);return isNaN(t)&&(t=function(e){var t,n=/^(\d{4}-\d\d-\d\d([tT][\d:.]*)?)([zZ]|([+-])(\d\d):?(\d\d))?$/.exec(e)||[];if(n[1]){if((t=n[1].split(/\D/).map((function(e){return parseInt(e,10)||0})))[1]-=1,!(t=new Date(Date.UTC.apply(Date,t))).getDate())return NaN;if(n[5]){var o=60*parseInt(n[5],10);n[6]&&(o+=parseInt(n[6],10)),"+"===n[4]&&(o*=-1),o&&t.setUTCMinutes(t.getUTCMinutes()+o)}return t.getTime()}return NaN}(e)),new Date(t)}},749:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimeInMinutes=t.getTimeInMilliseconds=t.getTimeInSeconds=t.padDateTimeUnit=void 0,t.padDateTimeUnit=function(e){var t=Math.abs(Math.floor("string"==typeof e?Number(e):e));return(t<10?"0":"")+t},t.getTimeInSeconds=function(e){var t=e.hours,n=void 0===t?0:t,o=e.minutes,r=void 0===o?0:o,s=e.seconds;return 60*n*60+60*r+(void 0===s?0:s)},t.getTimeInMilliseconds=function(e){var n=e.hours,o=void 0===n?0:n,r=e.minutes,s=void 0===r?0:r,i=e.seconds,a=void 0===i?0:i,c=e.milliseconds,u=void 0===c?0:c;return 1e3*(0,t.getTimeInSeconds)({hours:o,minutes:s,seconds:a})+u},t.getTimeInMinutes=function(e){var n=e.hours,o=void 0===n?0:n,r=e.minutes,s=void 0===r?0:r,i=e.seconds,a=void 0===i?0:i;return(0,t.getTimeInSeconds)({hours:o,minutes:s,seconds:a})/60}},151:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getTimezoneISOOffset=void 0;var o=n(749);t.getTimezoneISOOffset=function(e){void 0===e&&(e=new Date);var t=e.getTimezoneOffset();return"".concat(t>0?"-":"+").concat((0,o.padDateTimeUnit)(t/60),":").concat((0,o.padDateTimeUnit)(t%60))}},893:(e,t)=>{t.P=void 0,t.P=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},282:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LogLevels=void 0,(n=t.LogLevels||(t.LogLevels={})).ERROR="error",n.INFO="info",n.WARN="warn"},996:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventTargetPolyfill=void 0;var n=function(){function e(){this.listeners={}}return e.prototype.addEventListener=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){if(e in this.listeners)for(var n=this.listeners[e],o=0,r=n.length;o<r;o++)if(n[o]===t)return void n.splice(o,1)},e.prototype.dispatchEvent=function(e){if(!(e.type in this.listeners))return!0;for(var t=this.listeners[e.type].slice(),n=0,o=t.length;n<o;n++)t[n].call(this,e);return!e.defaultPrevented},e}();t.EventTargetPolyfill=n},455:(e,t,n)=>{t.xT=void 0;n(546),n(996),n(846);var o=n(982);Object.defineProperty(t,"xT",{enumerable:!0,get:function(){return o.WebSocketClientEvent}})},415:function(e,t,n){var o=this&&this.__assign||function(){return o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)},r=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.getPushUpdateWebSocket=t.setupSocketConnection=void 0;var s=n(846),i=n(982),a=null,c={forceSecureProtocol:!1,heartbeatAfterAuthorize:!1,maxRetries:20,maxReconnectionDelay:1e3};t.setupSocketConnection=function(e,t){if(void 0===t&&(t={}),"object"!=typeof t)throw new TypeError("Options parameter must be an object not a "+typeof t);var n=o(o({},c),t),u=n.forceSecureProtocol,l=n.heartbeatAfterAuthorize,d=r(n,["forceSecureProtocol","heartbeatAfterAuthorize"]),E=function(e,t){return t?"wss://"+e:("https:"===window.location.protocol?"wss:":"ws:")+"//"+e}(e,u);return a=new s.WebSocketClient(E,void 0,d),l?a.addEventListener(i.WebSocketClientEvent.MESSAGE,(function(e){"authorized"===JSON.parse(e.detail.data)&&(null==a||a.startHeartBeat())})):a.startHeartBeat(),a},t.getPushUpdateWebSocket=function(){return a}},546:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.HeartBeatState=void 0,(n=t.HeartBeatState||(t.HeartBeatState={})).DIED="died",n.DYING="dying",n.LIVING="living"},846:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=t.HEART_BEAT_CHECK_TIMEOUT=t.HEART_BEAT_INTERVAL=void 0;var i=n(282),a=s(n(864)),c=n(996),u=n(546),l=n(982);t.HEART_BEAT_INTERVAL=15e3,t.HEART_BEAT_CHECK_TIMEOUT=3*t.HEART_BEAT_INTERVAL;var d=function(e){function n(n,o,r){var s=e.call(this)||this;return s.heartBeatTimeout=null,s.heartBeatCheckTimeout=null,s.enableDebugMode=function(){s.debugMode||s.log(i.LogLevels.INFO,"websocket-push-updates--loggerEnabled"),s.debugMode=!0},s.disableDebugMode=function(){s.debugMode=!1},s.log=function(e,t,n){s.debugMode&&s.logger&&s.logger[e](t,n)},s.sendHeartBeat=function(){s.log(i.LogLevels.INFO,"websocket-push-updates--sendHeartBeat"),s.send(JSON.stringify({action:"heartbeat"}))},s.handleHeartBeatResponse=function(){s.heartBeatState===u.HeartBeatState.DYING&&(s.heartBeatState=u.HeartBeatState.LIVING,s.dispatchHeartBeatState()),s.setHeartBeatCheckTimeout()},s.setHeartBeatCheckTimeout=function(){null!==s.heartBeatCheckTimeout&&clearTimeout(s.heartBeatCheckTimeout),s.heartBeatCheckTimeout=setTimeout((function(){s.heartBeatState=u.HeartBeatState.DYING,s.dispatchHeartBeatState()}),t.HEART_BEAT_CHECK_TIMEOUT)},s.dispatchHeartBeatState=function(){s.log(i.LogLevels.INFO,"websocket-push-updates--dispatchHeartBeatState",[{hearbeatState:s.heartBeatState}]),null!==s.heartBeatState&&s.dispatchEvent(new CustomEvent(s.heartBeatState))},s.isHeartBeatActive=function(){return null!==s.heartBeatState},s.heartBeatState=null,s.debugMode=!1,s.socket=new a.default(n,o,r),s.socket.onopen=function(){s.dispatchEvent(new CustomEvent(l.WebSocketClientEvent.OPEN))},(null==r?void 0:r.logger)&&(s.logger=r.logger),s.socket.onclose=function(e){s.socket.retryCount===(null==r?void 0:r.maxRetries)?s.heartBeatState=u.HeartBeatState.DIED:s.heartBeatState=u.HeartBeatState.DYING,s.dispatchHeartBeatState(),s.dispatchEvent(new CustomEvent(l.WebSocketClientEvent.CLOSE,{detail:e}))},s.socket.onmessage=function(e){s.handleHeartBeatResponse(),"pong"!==JSON.parse(e.data)&&(s.log(i.LogLevels.INFO,"websocket-push-updates--onmessage",[e]),s.dispatchEvent(new CustomEvent(l.WebSocketClientEvent.MESSAGE,{detail:e})))},s.socket.onerror=function(e){s.log(i.LogLevels.ERROR,"websocket-push-updates--onError",[e]),s.dispatchEvent(new CustomEvent(l.WebSocketClientEvent.ERROR,{detail:e}))},s}return r(n,e),n.prototype.send=function(e){this.socket.send(e)},n.prototype.startHeartBeat=function(){var e=this;this.log(i.LogLevels.INFO,"websocket-push-updates--startHeartBeat",[{interval:t.HEART_BEAT_INTERVAL}]);var n=function(){e.log(i.LogLevels.INFO,"websocket-push-updates--heartBeatCallback"),e.sendHeartBeat(),e.heartBeatTimeout=setTimeout(n,t.HEART_BEAT_INTERVAL)};this.setHeartBeatCheckTimeout(),n(),this.heartBeatState=u.HeartBeatState.LIVING},n.prototype.stopHeartBeat=function(){this.log(i.LogLevels.INFO,"websocket-push-updates--stopHeartBeat"),null!==this.heartBeatTimeout&&clearTimeout(this.heartBeatTimeout),null!==this.heartBeatCheckTimeout&&clearTimeout(this.heartBeatCheckTimeout),this.heartBeatState=null},n}(c.EventTargetPolyfill);t.WebSocketClient=d},982:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClientEvent=void 0,(n=t.WebSocketClientEvent||(t.WebSocketClientEvent={})).CLOSE="close",n.ERROR="error",n.MESSAGE="message",n.OPEN="open"},864:(e,t,n)=>{n.r(t),n.d(t,{default:()=>E});var o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},o(e,t)};function r(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function s(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(o=s.next()).done;)i.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}function i(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(s(arguments[t]));return e}var a=function(e,t){this.target=t,this.type=e},c=function(e){function t(t,n){var o=e.call(this,"error",n)||this;return o.message=t.message,o.error=t,o}return r(t,e),t}(a),u=function(e){function t(t,n,o){void 0===t&&(t=1e3),void 0===n&&(n="");var r=e.call(this,"close",o)||this;return r.wasClean=!0,r.code=t,r.reason=n,r}return r(t,e),t}(a),l=function(){if("undefined"!=typeof WebSocket)return WebSocket},d={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const E=function(){function e(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){o._debug("open event");var t=o._options.minUptime,n=void 0===t?d.minUptime:t;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout((function(){return o._acceptOpen()}),n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach((function(e){var t;return null===(t=o._ws)||void 0===t?void 0:t.send(e)})),o._messageQueue=[],o.onopen&&o.onopen(e),o._listeners.open.forEach((function(t){return o._callEventListener(e,t)}))},this._handleMessage=function(e){o._debug("message event"),o.onmessage&&o.onmessage(e),o._listeners.message.forEach((function(t){return o._callEventListener(e,t)}))},this._handleError=function(e){o._debug("error event",e.message),o._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),o.onerror&&o.onerror(e),o._debug("exec error listeners"),o._listeners.error.forEach((function(t){return o._callEventListener(e,t)})),o._connect()},this._handleClose=function(e){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(e),o._listeners.close.forEach((function(t){return o._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?d.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,o=this._listeners[e.type];if(o)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(o),s=r.next();!s.done;s=r.next()){var i=s.value;this._callEventListener(e,i)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,i(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?d.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?d.minReconnectionDelay:o,s=e.maxReconnectionDelay,i=void 0===s?d.maxReconnectionDelay:s,a=0;return this._retryCount>0&&(a=r*Math.pow(n,this._retryCount-1))>i&&(a=i),this._debug("next delay",a),a},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,o=void 0===n?d.maxRetries:n,r=t.connectionTimeout,s=void 0===r?d.connectionTimeout:r,i=t.WebSocket,a=void 0===i?l():i;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(u=a)||!u||2!==u.CLOSING)throw Error("No valid WebSocket class provided");var u;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled?e._connectLock=!1:(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new a(t,e._protocols):new a(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),s))})).catch((function(t){e._connectLock=!1,e._handleError(new c(Error(t.message),e))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new c(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new u(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}()},441:(e,t)=>{var n;(n=t.p||(t.p={})).CHAT_WINDOW_EVENT="chatWindowEvent",n.REGISTER="register"},154:(e,t)=>{var n,o;(o=t.YU||(t.YU={})).SENDER_TYPING_STARTED="SenderTypingStarted",o.SENDER_TYPING_ENDED="SenderTypingEnded",o.LOAD_MORE_MESSAGES="LoadMoreMessages",o.RECOVER_LIVECHAT="RecoverLivechat",o.RECOVER_THREAD="RecoverThread",o.SEND_MESSAGE="SendMessage",o.SEND_OUTBOUND="SendOutbound",o.SEND_OFFLINE_MESSAGE="SendOfflineMessage",o.SEND_PAGE_VIEWS="SendPageViews",o.SEND_CONSUMER_CUSTOM_FIELDS="SetConsumerCustomFields",o.SET_CONSUMER_CONTACT_CUSTOM_FIELD="SetConsumerContactCustomFields",o.MESSAGE_SEEN="MessageSeenByConsumer",o.SEND_TRANSCRIPT="SendTranscript",o.FETCH_THREAD_LIST="FetchThreadList",o.END_CONTACT="EndContact",o.EXECUTE_TRIGGER="ExecuteTrigger",o.AUTHORIZE_CONSUMER="AuthorizeConsumer",o.AUTHORIZE_CUSTOMER="AuthorizeCustomer",o.RECONNECT_CONSUMER="ReconnectConsumer",o.UPDATE_THREAD="UpdateThread",o.ARCHIVE_THREAD="ArchiveThread",o.LOAD_THREAD_METADATA="LoadThreadMetadata",o.REFRESH_TOKEN="RefreshToken",o.STORE_VISITOR="StoreVisitor",o.STORE_VISITOR_EVENTS="StoreVisitorEvents",o.CREATE_GROUP_CHAT_INVITE="CreateInvitationToGroupChat",o.SEND_EMAIL_INVITE_TO_GROUP_CHAT="SendEmailInvitationToGroupChat",o.JOIN_GROUP_CHAT="JoinGroupChat",o.LEAVE_GROUP_CHAT="LeaveGroupChat",o.GENERATE_AUTHORIZATION_TOKEN="GenerateAuthorizationToken",o.ADD_VISITOR_TAGS="AddVisitorTags",o.REMOVE_VISITOR_TAGS="RemoveVisitorTags",o.SEND_MESSAGE_PREVIEW="SendMessagePreview",(n=t.Ne||(t.Ne={})).LIVECHAT_RECOVERED="LivechatRecovered",n.MORE_MESSAGES_LOADED="MoreMessagesLoaded",n.OFFLINE_MESSAGE_SENT="OfflineMessageSent",n.THREAD_LIST_FETCHED="ThreadListFetched",n.THREAD_RECOVERED="ThreadRecovered",n.TRANSCRIPT_SENT="TranscriptSent",n.CONSUMER_AUTHORIZED="ConsumerAuthorized",n.THREAD_METADATA_LOADED="ThreadMetadataLoaded",n.SET_POSITION_IN_QUEUE="SetPositionInQueue",n.GROUP_CHAT_INVITE_CREATED="InvitationToGroupChatCreated",n.GROUP_CHAT_INVITE_SENT="EmailInvitationToGroupChatSent",n.GROUP_CHAT_JOINED="GroupChatJoined",n.TOKEN_REFRESHED="TokenRefreshed",n.AUTHORIZATION_TOKEN_GENERATED="AuthorizationTokenGenerated",n.THREAD_ARCHIVED="ThreadArchived"},58:(e,t)=>{var n;(n=t.Yi||(t.Yi={})).DESKTOP="desktop",n.MOBILE="mobile",n.OTHER="other",n.TABLET="tablet",(t.vQ||(t.vQ={})).BROWSER="browser"},880:(e,t,n)=>{var o=n(256);t.P=o.CaseStatus},354:(e,t)=>{t.GO="X-Caller-Service-ID"},510:(e,t)=>{var n;(n=t.T||(t.T={})).INBOUND="inbound",n.OUTBOUND="outbound"},115:(e,t)=>{var n;(n=t.C||(t.C={})).TEXT="TEXT",n.FILE="FILE",n.FORM="FORM",n.PLUGIN="PLUGIN",n.POSTBACK="POSTBACK",n.QUICK_REPLIES="QUICK_REPLIES",n.RICH_LINK="RICH_LINK",n.LIST_PICKER="LIST_PICKER",n.ADAPTIVE_CARD="ADAPTIVE_CARD",n.TIME_PICKER="TIME_PICKER"},256:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.CaseStatus||(t.CaseStatus={})).NEW="new",n.OPEN="open",n.PENDING="pending",n.ESCALATED="escalated",n.RESOLVED="resolved",n.CLOSED="closed",n.TRASHED="trashed"},403:(e,t)=>{var n;(n=t.m||(t.m={})).AUTHORIZE_CONSUMER="AuthorizeConsumer",n.CASE_CREATED="CaseCreated",n.CASE_INBOX_ASSIGNEE_CHANGED="CaseInboxAssigneeChanged",n.CASE_STATUS_CHANGED="CaseStatusChanged",n.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",n.CONTACT_CREATED="CaseCreated",n.ASSIGNED_AGENT_CHANGED="CaseInboxAssigneeChanged",n.CONTACT_STATUS_CHANGED="CaseStatusChanged",n.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",n.CONTACT_PREFERRED_USER_CHANGED="ContactPreferredUserChanged",n.CONTACT_PROFICIENCY_CHANGED="ContactProficiencyChanged",n.CONTACT_PRIORITY_CHANGED="ContactPriorityChanged",n.CONTACT_SYNC="ContactSync",n.CHANNEL_CREATED="ChannelCreated",n.CHANNEL_DELETED="ChannelDeleted",n.CHANNEL_UPDATED="ChannelUpdated",n.MESSAGE_ADDED_INTO_CASE="MessageAddedIntoCase",n.MESSAGE_CREATED="MessageCreated",n.MESSAGE_DELIVERED_TO_END_USER="MessageDeliveredToEndUser",n.MESSAGE_DELIVERED_TO_USER="MessageDeliveredToUser",n.MESSAGE_NOTE_CREATED="MessageNoteCreated",n.MESSAGE_NOTE_UPDATED="MessageNoteUpdated",n.MESSAGE_NOTE_DELETED="MessageNoteDeleted",n.MESSAGE_READ_CHANGED="MessageReadChanged",n.MESSAGE_SEEN_BY_END_USER="MessageSeenByEndUser",n.MESSAGE_SEEN_BY_USER="MessageSeenByUser",n.MESSAGE_SENT="MessageSent",n.MESSAGE_UPDATED="MessageUpdated",n.PAGE_VIEW_CREATED="PageViewCreated",n.ROUTING_QUEUE_CREATED="RoutingQueueCreated",n.ROUTING_QUEUE_DELETED="RoutingQueueDeleted",n.ROUTING_QUEUE_UPDATED="RoutingQueueUpdated",n.SUBQUEUE_ASSIGNED_TO_ROUTING_QUEUE="SubqueueAssignedToRoutingQueue",n.SUBQUEUE_UNASSIGNED_TO_ROUTING_QUEUE="SubqueueUnassignedFromRoutingQueue",n.USER_ASSIGNED_TO_ROUTING_QUEUE="UserAssignedToRoutingQueue",n.USER_STATUS_CHANGED="UserStatusChanged",n.USER_UNASSIGNED_FROM_ROUTING_QUEUE="UserUnassignedFromRoutingQueue",n.AGENT_CONTACT_STARTED="AgentContactStarted",n.AGENT_CONTACT_ENDED="AgentContactEnded",n.SENDER_TYPING_STARTED="SenderTypingStarted",n.SENDER_TYPING_ENDED="SenderTypingEnded",n.FIRE_PROACTIVE="FireProactiveAction",n.CONTACT_INBOX_PRE_ASSIGNEE_CHANGED="ConsumerContactInboxPreAssigneeChanged",n.CONTACT_RECIPIENTS_CHANGED="ContactRecipientsChanged",n.MESSAGE_PREVIEW_CREATED="MessagePreviewCreated",n.EVENT_IN_S3="EventInS3"},585:e=>{e.exports=t},459:t=>{t.exports=e}},o={};function r(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return n[e].call(s.exports,s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{r.r(s),r.d(s,{AbortError:()=>Jt,AbortablePromise:()=>Xt,AuthorizationError:()=>d,ChatEvent:()=>Ze,ChatSdk:()=>Zt,ContactStatus:()=>Tt.P,Customer:()=>ke,EnvironmentName:()=>Je,LivechatThread:()=>Yt,MessageType:()=>dt.C,SendMessageFailedError:()=>lt,Thread:()=>Bt,ThreadRecoverFailedError:()=>xt,UploadAttachmentError:()=>St,WebSocketClientError:()=>_t,WebSocketClientEvent:()=>t.xT,createCreateInvitationToGroupChatPayloadData:()=>dn,createJoinGroupChatPayloadData:()=>_n,createLeaveGroupChatPayloadData:()=>Tn,createReconnectPayloadData:()=>We,createSendEmailInvitationToGroupChatPayloadData:()=>mn,default:()=>An,generateId:()=>E.v4,getAuthor:()=>on,isAgentTypingEndedEvent:()=>tn,isAgentTypingStartedEvent:()=>en,isAssignedAgentChangedEvent:()=>qt,isAuthSuccessEvent:()=>$e,isContactCreatedEvent:()=>It,isContactRecipientsChangedEvent:()=>Rt,isContactStatusChangedEvent:()=>bt,isContactToRoutingQueueAssignmentChangedEvent:()=>wt,isCustomerReconnectSuccessPayloadData:()=>gn,isLoadMetadataSuccessPayload:()=>Mt,isMessage:()=>rn,isMessageCreatedEvent:()=>sn,isMessageReadChangedEvent:()=>cn,isMessageSentEvent:()=>an,isMoreMessagesLoadedEvent:()=>Dt,isRecoverSuccessEvent:()=>Gt,isSetPositionInQueueEvent:()=>un,isThreadArchivedSuccessPayload:()=>jt,isThreadListFetchedPostbackData:()=>Wt,isTokenRefreshedSuccessResponse:()=>Ke,sendChatEvent:()=>Ye,sendCreateInvitationToGroupChatEvent:()=>En,sendEmailInvitationToGroupChatEvent:()=>Cn,sendJoinGroupChatEvent:()=>vn,sendLeaveGroupChatEvent:()=>fn,splitName:()=>Pe});var e,t=r(455),n=r(441),o=r(154);!function(e){e.ACCESS_TOKEN="ACCESS_TOKEN",e.ACCESS_TOKEN_EXPIRES_IN="ACCESS_TOKEN_EXPIRES_IN",e.APP_NAME="APP_NAME",e.APP_VERSION="APP_VERSION",e.AUTHORIZATION_CODE="AUTHORIZATION_CODE",e.BRAND_ID="BRAND_ID",e.CHANNEL_ID="CHANNEL_ID",e.CUSTOMER_ID="CUSTOMER_ID",e.CUSTOMER_IMAGE="CUSTOMER_IMAGE",e.CUSTOMER_NAME="CUSTOMER_NAME",e.ENDPOINT_CHAT="ENDPOINT_CHAT",e.ENDPOINT_GATEWAY="ENDPOINT_GATEWAY",e.THREAD_DATA="THREAD_DATA"}(e||(e={}));const i=new class{constructor(){this._vars={}}set(e,t){this._vars[e]=t}get(e,t){var n;return null!==(n=this._vars[e])&&void 0!==n?n:t}list(){return Object.keys(this._vars)}clear(){this._vars={}}},a=function(e){return null===e};function c(t){i.set(e.ACCESS_TOKEN,t.token),i.set(e.ACCESS_TOKEN_EXPIRES_IN,String(t.expiresIn))}function u(){const t=i.get(e.ACCESS_TOKEN,null),n=i.get(e.ACCESS_TOKEN_EXPIRES_IN,null);return a(t)||a(n)?null:{token:t,expiresIn:Number(n)}}class l extends Error{constructor(e,t){super(),this.name="ChatSDKError",this.message=`[ChatSDKError]: ${this._getErrorMessage(e)}`,this.data=t}_getErrorMessage(e){return e instanceof Error?e.message:"string"==typeof e?e:JSON.stringify(e)}}class d extends l{constructor(e,t){super(e,t),void 0!==t&&(this.message=`${e} because of (${t.errorMessage})`)}}var E=r(459);function h(e){return{visitor:{id:e}}}var _=Object.prototype;const v=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||_)},T=(f=Object.keys,p=Object,function(e){return f(p(e))});var f,p,m=Object.prototype.hasOwnProperty;const C="object"==typeof global&&global&&global.Object===Object&&global;var g="object"==typeof self&&self&&self.Object===Object&&self;const A=C||g||Function("return this")(),O=A.Symbol;var y=Object.prototype,S=y.hasOwnProperty,N=y.toString,b=O?O.toStringTag:void 0;var I=Object.prototype.toString;var w=O?O.toStringTag:void 0;const R=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":w&&w in Object(e)?function(e){var t=S.call(e,b),n=e[b];try{e[b]=void 0;var o=!0}catch(e){}var r=N.call(e);return o&&(t?e[b]=n:delete e[b]),r}(e):function(e){return I.call(e)}(e)},D=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},P=function(e){if(!D(e))return!1;var t=R(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},U=A["__core-js_shared__"];var M,G=(M=/[^.]+$/.exec(U&&U.keys&&U.keys.IE_PROTO||""))?"Symbol(src)_1."+M:"";var j=Function.prototype.toString;const k=function(e){if(null!=e){try{return j.call(e)}catch(e){}try{return e+""}catch(e){}}return""};var L=/^\[object .+?Constructor\]$/,H=Function.prototype,x=Object.prototype,F=H.toString,B=x.hasOwnProperty,V=RegExp("^"+F.call(B).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");const Y=function(e){return!(!D(e)||function(e){return!!G&&G in e}(e))&&(P(e)?V:L).test(k(e))},W=function(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Y(n)?n:void 0},Q=W(A,"DataView"),z=W(A,"Map"),$=W(A,"Promise"),K=W(A,"Set"),J=W(A,"WeakMap");var X="[object Map]",Z="[object Promise]",q="[object Set]",ee="[object WeakMap]",te="[object DataView]",ne=k(Q),oe=k(z),re=k($),se=k(K),ie=k(J),ae=R;(Q&&ae(new Q(new ArrayBuffer(1)))!=te||z&&ae(new z)!=X||$&&ae($.resolve())!=Z||K&&ae(new K)!=q||J&&ae(new J)!=ee)&&(ae=function(e){var t=R(e),n="[object Object]"==t?e.constructor:void 0,o=n?k(n):"";if(o)switch(o){case ne:return te;case oe:return X;case re:return Z;case se:return q;case ie:return ee}return t});const ce=ae,ue=function(e){return null!=e&&"object"==typeof e},le=function(e){return ue(e)&&"[object Arguments]"==R(e)};var de=Object.prototype,Ee=de.hasOwnProperty,he=de.propertyIsEnumerable;const _e=le(function(){return arguments}())?le:function(e){return ue(e)&&Ee.call(e,"callee")&&!he.call(e,"callee")},ve=Array.isArray,Te=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var fe="object"==typeof exports&&exports&&!exports.nodeType&&exports,pe=fe&&"object"==typeof module&&module&&!module.nodeType&&module,me=pe&&pe.exports===fe?A.Buffer:void 0;const Ce=(me?me.isBuffer:void 0)||function(){return!1};var ge={};ge["[object Float32Array]"]=ge["[object Float64Array]"]=ge["[object Int8Array]"]=ge["[object Int16Array]"]=ge["[object Int32Array]"]=ge["[object Uint8Array]"]=ge["[object Uint8ClampedArray]"]=ge["[object Uint16Array]"]=ge["[object Uint32Array]"]=!0,ge["[object Arguments]"]=ge["[object Array]"]=ge["[object ArrayBuffer]"]=ge["[object Boolean]"]=ge["[object DataView]"]=ge["[object Date]"]=ge["[object Error]"]=ge["[object Function]"]=ge["[object Map]"]=ge["[object Number]"]=ge["[object Object]"]=ge["[object RegExp]"]=ge["[object Set]"]=ge["[object String]"]=ge["[object WeakMap]"]=!1;var Ae="object"==typeof exports&&exports&&!exports.nodeType&&exports,Oe=Ae&&"object"==typeof module&&module&&!module.nodeType&&module,ye=Oe&&Oe.exports===Ae&&C.process,Se=function(){try{return Oe&&Oe.require&&Oe.require("util").types||ye&&ye.binding&&ye.binding("util")}catch(e){}}(),Ne=Se&&Se.isTypedArray;const be=Ne?function(e){return function(t){return e(t)}}(Ne):function(e){return ue(e)&&Te(e.length)&&!!ge[R(e)]};var Ie=Object.prototype.hasOwnProperty;const we=function(e){if(null==e)return!0;if(function(e){return null!=e&&Te(e.length)&&!P(e)}(e)&&(ve(e)||"string"==typeof e||"function"==typeof e.splice||Ce(e)||be(e)||_e(e)))return!e.length;var t=ce(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(v(e))return!function(e){if(!v(e))return T(e);var t=[];for(var n in Object(e))m.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e).length;for(var n in e)if(Ie.call(e,n))return!1;return!0},Re=new Map,De=async(e,t)=>{if(a(t))throw new l("WebSocketClient is not initialized");return we(e.eventId)&&(e.eventId=(0,E.v4)()),new Promise((n=>{Re.set(e.eventId,n),null==t||t.send(e)}))};function Pe(e){const[t,...n]=e.split(" ");return[t,n.join(" ")]}function Ue(e,t={}){for(const n of Object.keys(t))e.set(n,t[n])}function Me(e,t=[]){for(const{ident:n,value:o}of t)e.set(n,o)}function Ge(e){return Object.fromEntries(e)}function je(e){return Array.from(e).map((([e,t])=>({ident:e,value:t})))}class ke{constructor(e,t,n,o){this._customFields=new Map,this._exists=!1,this._websocketClient=o,ke.setId(e),ke.setName(t),n&&ke.setImage(n)}static setId(t){i.set(e.CUSTOMER_ID,t)}static getId(){return i.get(e.CUSTOMER_ID,null)}static getName(){return i.get(e.CUSTOMER_NAME)}static setName(t){i.set(e.CUSTOMER_NAME,t)}static getIdOrCreateNewOne(){let e=this.getId();return e||(e=(0,E.v4)(),this.setId(e)),e}static getImage(){return i.get(e.CUSTOMER_IMAGE)}static setImage(t){i.set(e.CUSTOMER_IMAGE,t)}getId(){return ke.getIdOrCreateNewOne()}getName(){return ke.getName()}setName(e){ke.setName(e)}setImage(e){ke.setImage(e)}setExists(e){this._exists=e}setCustomField(e,t){return this.setCustomFields({[e]:t})}setCustomFields(e){if(Ue(this._customFields,e),this._exists)return this.sendCustomFields()}getCustomFields(){return Ge(this._customFields)}setCustomFieldsFromArray(e){Me(this._customFields,e)}getCustomFieldsArray(){return je(this._customFields)}async sendCustomFields(){var e;return Ye((e=je(this._customFields),{eventType:o.YU.SEND_CONSUMER_CUSTOM_FIELDS,data:{customFields:e}}),this._websocketClient)}}function Le(e,t){const n=null!=e?e:ke.getName(),o=null!=t?t:ke.getImage();let r={};if("string"==typeof n&&n.length>0){const[e,t]=Pe(n);r={firstName:e,lastName:t}}return o&&(r.image=o),Object.assign({idOnExternalPlatform:ke.getIdOrCreateNewOne()},r)}const He=function(e){return null==e};function xe(){const t=parseInt(i.get(e.BRAND_ID)),n=i.get(e.CHANNEL_ID);if(He(t)||isNaN(t)||He(n))throw new l(`Cannot get BrandId and ChannelId from SDKVariableStorage \n      brandId (${t}) |\n      channelId (${n})`);return{brandId:t,channelId:n}}const Fe=function(e){return void 0===e};function Be(e){const{eventType:t,data:n,consumerIdentity:o=Le(),destination:r={},visitor:s={}}=e,{brandId:i,channelId:a}=xe();if(Fe(t))throw new l(`Cannot create an event payload because of missing eventType (${t})`);return{eventType:t,brand:{id:Number(i)},channel:{id:a},consumerIdentity:o,data:n,destination:r,visitor:s}}function Ve(e,t=(0,E.v4)(),o=n.p.CHAT_WINDOW_EVENT){return{action:o,eventId:t,payload:e}}async function Ye(e,t){const n=Ve(Be(e));return De(n,t)}function We(e,t){return Object.assign(Object.assign(Object.assign({},h(t)),Le()),{eventType:o.YU.RECONNECT_CONSUMER,data:{accessToken:{token:e.token}}})}let Qe=null;function ze(e,t){null!==Qe&&clearTimeout(Qe),Qe=setTimeout(t,1e3*function(e){const t=Math.round(.9*e);return t<20?20:t}(e.expiresIn))}const $e=e=>{var t;const n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.status;return(null==e?void 0:e.type)===o.Ne.CONSUMER_AUTHORIZED&&"success"===n};function Ke(e){var t,n;return(null==e?void 0:e.type)===o.Ne.TOKEN_REFRESHED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.accessToken)||void 0===n?void 0:n.token)}var Je;!function(e){e.AU1="AU1",e.CA1="CA1",e.EU1="EU1",e.JP1="JP1",e.NA1="NA1",e.UK1="UK1",e.custom="custom"}(Je||(Je={}));var Xe=r(403);const Ze=Object.assign(Object.assign(Object.assign({},Xe.m),o.Ne),{AGENT_TYPING_STARTED:"AgentTypingStarted",AGENT_TYPING_ENDED:"AgentTypingEnded",ASSIGNED_AGENT_CHANGED:"AssignedAgentChanged",CONTACT_CREATED:"ContactCreated",CONTACT_STATUS_CHANGED:"ContactStatusChanged",CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED:"ContactToRoutingQueueAssignmentChanged"});class qe extends CustomEvent{}class et{constructor(){this.middlewares=[]}register(e){this.middlewares.push(e)}process(e){if(He(e))return null;let t=e;for(const e of this.middlewares){if(null===t)return null;t=e(t)}return t}}const tt=EventTarget;function nt(e){return!He(null==e?void 0:e.user)}var ot=r(910),rt=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};const st={id:"",data:null,type:void 0,createdAt:new Date};function it(e){if(!(e=>"eventId"in e)(e))return st;if((e=>"error"in e)(e))return{createdAt:(0,ot.Nf)(e.createdAt),data:null,error:e.error,id:e.eventId};const t=(e=>"eventType"in e)(e)?e.eventType:void 0;if((e=>"data"in e)(e))return{createdAt:(0,ot.Nf)(e.createdAt),context:e.context,data:e.data,id:e.eventId,type:t};if((e=>{const t=null==e?void 0:e.postback;return!1===we(t)})(e)){const{postback:{data:t,eventType:n},eventId:o}=e,r=rt(e,["postback","eventId"]);return{type:n,data:Object.assign(Object.assign({},r),t),createdAt:(0,ot.Nf)(e.createdAt),id:o}}const{eventId:n}=e,o=rt(e,["eventId"]);return Object.assign(Object.assign({data:void 0},o),{id:n,type:t,createdAt:(0,ot.Nf)(e.createdAt)})}const at={[Ze.SENDER_TYPING_STARTED]:function(e){return nt(e.data)?Object.assign(Object.assign({},e),{type:Ze.AGENT_TYPING_STARTED}):e},[Ze.SENDER_TYPING_ENDED]:function(e){return nt(e.data)?Object.assign(Object.assign({},e),{type:Ze.AGENT_TYPING_ENDED}):e},[Ze.CASE_INBOX_ASSIGNEE_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:Ze.ASSIGNED_AGENT_CHANGED})},[Ze.CASE_CREATED]:function(e){return Object.assign(Object.assign({},e),{type:Ze.CONTACT_CREATED})},[Ze.CASE_STATUS_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:Ze.CONTACT_STATUS_CHANGED})},[Ze.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:Ze.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED})},[Ze.LIVECHAT_RECOVERED]:function(e){const t=e.data.contactHistory.map(it);return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})},[Ze.THREAD_RECOVERED]:function(e){const t=e.data.contactHistory.map(it);return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})}};function ct(e){return e.type&&void 0!==at[e.type]?at[e.type](e):e}function ut(e){const t=!1===Fe(null==e?void 0:e.id);return!1==(!1===Fe(e.error))&&t}class lt extends l{}var dt=r(115);var Et=r(893),ht=r(415);class _t extends Error{constructor(e,t=""){super(`[WebSocketClientError]: ${e}${t?` (${t})`:""}`),this.name="WebSocketClientError"}}class vt{constructor(e,t,n,o,r){this.brandId=e,this.channelId=t,this.customerId=n,this.options=o,this.onError=r,this._connection=null,this.connect()}connect(){var n,o,r,s,a,c,u,l,d,E,h,_;const v=(null===(n=this.options)||void 0===n?void 0:n.port)?`:${null===(o=this.options)||void 0===o?void 0:o.port}`:"",T=(null===(r=this.options)||void 0===r?void 0:r.host)?`${null===(s=this.options)||void 0===s?void 0:s.host}${v}`:"",f=null!==(c=null===(a=this.options)||void 0===a?void 0:a.prefix)&&void 0!==c?c:"",p=null===(l=null===(u=this.options)||void 0===u?void 0:u.forceSecureProtocol)||void 0===l||l,m=function(t,n,o,r,s){const a={brandId:o,channelId:r,consumerId:s,v:i.get(e.APP_VERSION)};return`${t}/${n}?${(0,Et.P)(a)}`}(T,f,this.brandId,this.channelId,this.customerId);this._connection=(0,ht.setupSocketConnection)(m,{startClosed:!0,forceSecureProtocol:p});const C=this._errorHandler.bind(this);null===(d=this._connection)||void 0===d||d.addEventListener(t.xT.CLOSE,C),null===(E=this._connection)||void 0===E||E.addEventListener(t.xT.ERROR,C),null===(_=null===(h=this._connection)||void 0===h?void 0:h.socket)||void 0===_||_.reconnect()}disconnect(){var e;null===(e=this._connection)||void 0===e||e.socket.close()}reconnect(){var e;null===(e=this._connection)||void 0===e||e.socket.reconnect()}send(e){var t;const n=JSON.stringify(e);null===(t=this._connection)||void 0===t||t.send(n)}on(e,t){var n;null===(n=this._connection)||void 0===n||n.addEventListener(e,t)}off(e,t){var n;null===(n=this._connection)||void 0===n||n.removeEventListener(e,t)}_errorHandler(e){const t=e.detail;let n;if(t instanceof ErrorEvent&&(n=new _t("Connection error",t.message)),t instanceof CloseEvent&&(n=new _t("Connection closed",t.reason)),void 0===n&&(n=new _t("Unknown error",t.type)),"function"!=typeof this.onError)throw n;this.onError(n)}}var Tt=r(880),ft=r(585),pt=r.n(ft),mt=r(58);const Ct=()=>navigator.language,gt=()=>Intl.DateTimeFormat().resolvedOptions().timeZone;function At(e){switch(e){case"mobile":return mt.Yi.MOBILE;case"tablet":return mt.Yi.TABLET;default:return mt.Yi.DESKTOP}}const Ot=(e={})=>{var t,n,o,r;const s=new(pt())(navigator.userAgent),{country:i="",location:a=gt(),language:c=Ct(),ip:u=null}=e;return{browser:null!==(t=s.getBrowser().name)&&void 0!==t?t:null,browserVersion:null!==(n=s.getBrowser().version)&&void 0!==n?n:null,country:i,ip:u,language:c,location:a,os:null!==(o=s.getOS().name)&&void 0!==o?o:null,osVersion:null!==(r=s.getOS().version)&&void 0!==r?r:null,deviceType:At(s.getDevice().type),applicationType:mt.vQ.BROWSER}};var yt=r(354);class St extends l{}const Nt=async(t,n,o)=>{const r=await(async e=>{const t=await function(e){return new Promise(((t,n)=>{const o=new FileReader;o.onloadend=()=>{t(o)},o.onerror=e=>{var t,o;return n(null===(o=null===(t=e.target)||void 0===t?void 0:t.error)||void 0===o?void 0:o.message)},o.readAsDataURL(e)}))}(e);if(null!==t.error)throw new l(`Cannot create payload for attachment upload because of error (${t.error.message})`);if("string"!=typeof t.result)throw new l(`Cannot create payload for attachment upload because of missing:\n      reader result (${t.result})`);return{url:t.result,name:e.name,mimeType:e.type}})(t),s=await async function(t,n,o){const r=i.get(e.ENDPOINT_CHAT),{url:s,name:a,mimeType:c}=o,u={content:s.split(";base64,")[1],fileName:a,mimeType:c},d=await fetch(`${r}/chat/1.0/brand/${t}/channel/${n}/attachment`,{method:"POST",body:JSON.stringify(u),headers:{"Content-Type":"application/json",[yt.GO]:i.get(e.APP_NAME)}});if(!d.ok)throw new l(`Failed to upload Attachments. Status (${d.status})`);return d.json()}(n,o,r);if(!1===Fe(null==(a=s)?void 0:a.fileUrl))return{url:s.fileUrl,friendlyName:r.name};var a;if(function(e){return!1===Fe(null==e?void 0:e.allowedFileSize)}(s))throw new St("Upload attachment failed",s);throw new l(`Unknown file upload response (${s})`)};function bt(e){var t,n;return e.type===Ze.CONTACT_STATUS_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function It(e){var t,n;return e.type===Ze.CONTACT_CREATED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function wt(e){var t,n;return e.type===Ze.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Rt(e){return e.type===Xe.m.CONTACT_RECIPIENTS_CHANGED}function Dt(e){var t;return e.type===o.Ne.MORE_MESSAGES_LOADED&&void 0!==(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.messages)}class Pt extends l{}class Ut extends l{}const Mt=e=>e.type===o.Ne.THREAD_METADATA_LOADED&&void 0!==e.data.lastMessage,Gt=e=>{const t=e.data,n=!1===Fe(t),r=!1===Fe(null==t?void 0:t.messages),s=e.type===o.Ne.THREAD_RECOVERED||e.type===o.Ne.LIVECHAT_RECOVERED,i=Fe(e.error);return n&&r&&i&&s};function jt(e){return e.type===o.Ne.THREAD_ARCHIVED}class kt extends l{}function Lt(e){const t={eventType:o.YU.RECOVER_THREAD,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}class Ht extends l{}class xt extends l{}function Ft(e){return{eventType:o.YU.SENDER_TYPING_ENDED,data:{thread:{idOnExternalPlatform:e}}}}class Bt{constructor(e,t,n,o,r={},s=!1){this._exists=!1,this._typingTimeoutID=void 0,this._isAuthorizationEnabled=!1,this._customFields=new Map,this.idOnExternalPlatform=e,this._websocketClient=t,this._messageEmitter=n,this._customer=o,this._isAuthorizationEnabled=s,Ue(this._customFields,r),this._registerEventHandlers()}async recover(){const e=await Ye(Lt(this.idOnExternalPlatform),this._websocketClient);if(Gt(e)){const t=e.data,{contact:n,consumerContact:o}=t,r=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(t,["contact","consumerContact"]);return Object.assign(Object.assign({},r),{contact:null!=n?n:o})}throw new xt("Thread recover fail",e)}async sendMessage(e){return(async(e,t)=>{const n=(r=e,{eventType:o.YU.SEND_MESSAGE,data:r});var r;const s=await Ye(n,t);if(ut(s))return s;throw new lt("Send message failed",s)})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!1),this._websocketClient)}async sendTextMessage(e,t={}){const{messageId:n=(0,E.v4)(),browserFingerprint:o=Ot()}=t,r=((e,t,n,o=Ot())=>({messageContent:{payload:{text:e},type:dt.C.TEXT},browserFingerprint:o,idOnExternalPlatform:t,thread:{idOnExternalPlatform:n},consumer:{customFields:[]},consumerContact:{customFields:[]},attachments:[]}))(e,n,this.idOnExternalPlatform,o);return this.sendMessage(r)}async sendOutboundMessage(e){return(async(e,t)=>{const n=(r=e,{eventType:o.YU.SEND_OUTBOUND,data:r});var r;const s=await Ye(n,t);if(ut(s))return s;throw new lt("Send Outbound message failed",s)})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!0),this._websocketClient)}async loadMoreMessages(){var t;const{scrollToken:n,oldestMessageDatetime:r}=null!==(t=JSON.parse(i.get(e.THREAD_DATA,"{}")))&&void 0!==t?t:{};if(we(n))return null;const s={scrollToken:n,oldestMessageDatetime:r,thread:{idOnExternalPlatform:this.idOnExternalPlatform}},a=await Ye((c=s,{eventType:o.YU.LOAD_MORE_MESSAGES,data:c}),this._websocketClient);var c;if(Dt(a))return a;throw new kt("Load more messages failed",a)}async lastMessageSeen(){var e;return Ye((e=this.idOnExternalPlatform,{eventType:o.YU.MESSAGE_SEEN,data:{thread:{idOnExternalPlatform:e}}}),this._websocketClient)}async sendAttachments(e,t={}){if(Fe(e)||0===e.length)throw new l("FileList must be provided to sendAttachment method");const n=await(async(e,t,n={})=>{const{brandId:o,channelId:r}=xe();try{const s=await Promise.all(Array.from(e).map((async e=>Nt(e,o,r)))),{messageId:i=(0,E.v4)(),browserFingerprint:a=Ot()}=n;return{messageContent:{type:dt.C.TEXT,payload:{text:""}},attachments:s,browserFingerprint:a,thread:{idOnExternalPlatform:t},idOnExternalPlatform:i,consumer:{customFields:[]},consumerContact:{customFields:[]}}}catch(e){if(e instanceof St)throw e;if(e instanceof Error)throw new l(`Send attachment failed because of (${e.message})`);throw new l("Unknown error during file upload")}})(e,this.idOnExternalPlatform,t);return this.sendMessage(n)}keystroke(e=1e3){var t;this._typingTimeoutID||Ye((t=this.idOnExternalPlatform,{eventType:o.YU.SENDER_TYPING_STARTED,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient),clearTimeout(this._typingTimeoutID),this._typingTimeoutID=setTimeout((()=>{Ye(Ft(this.idOnExternalPlatform),this._websocketClient),this._typingTimeoutID=void 0}),e)}stopTyping(){clearTimeout(this._typingTimeoutID),this._typingTimeoutID=void 0,Ye(Ft(this.idOnExternalPlatform),this._websocketClient)}async getMetadata(){const e=await Ye((t=this.idOnExternalPlatform,{eventType:o.YU.LOAD_THREAD_METADATA,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(Mt(e))return e;throw new Ut("Get metadata failed",e)}onThreadEvent(e,t){const n=((e,t)=>n=>{(e=>{var t,n,o,r,s,i,a;const c=e;return null!==(i=null!==(r=null!==(n=null===(t=null==c?void 0:c.thread)||void 0===t?void 0:t.idOnExternalPlatform)&&void 0!==n?n:null===(o=null==c?void 0:c.case)||void 0===o?void 0:o.threadIdOnExternalPlatform)&&void 0!==r?r:null===(s=null==c?void 0:c.message)||void 0===s?void 0:s.threadIdOnExternalPlatform)&&void 0!==i?i:null===(a=null==c?void 0:c.messagePreview)||void 0===a?void 0:a.threadIdOnExternalPlatform})(n.detail.data)===e&&t(n)})(this.idOnExternalPlatform,t);return this._messageEmitter.addEventListener(e,n),()=>{this._messageEmitter.removeEventListener(e,n)}}async sendCustomFields(){var e,t;return Ye((e=je(this._customFields),t=this.idOnExternalPlatform,{eventType:o.YU.SET_CONSUMER_CONTACT_CUSTOM_FIELD,data:{customFields:e,thread:{idOnExternalPlatform:t}}}),this._websocketClient)}async setCustomFields(e){Ue(this._customFields,e),!1!==this._exists&&await this.sendCustomFields()}setCustomField(e,t){return this.setCustomFields({[e]:t})}async archive(){const e=await Ye((t=this.idOnExternalPlatform,{eventType:o.YU.ARCHIVE_THREAD,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(jt(e))return!0;throw new Pt("Archive Thread failed",e)}async setName(e){const t=(n=this.idOnExternalPlatform,r=e,{eventType:o.YU.UPDATE_THREAD,data:{thread:{idOnExternalPlatform:n,threadName:r}}});var n,r;const s=await Ye(t,this._websocketClient);if(function(e){return Fe(e.error)}(s))return!0;throw new Ht("Set Thread name failed",s)}async sendMessagePreview(e){const t=((e,t)=>({eventType:o.YU.SEND_MESSAGE_PREVIEW,data:{thread:{idOnExternalPlatform:e},messageContent:{payload:{text:t},type:dt.C.TEXT}}}))(this.idOnExternalPlatform,e);await Ye(t,this._websocketClient)}async sendTranscript(e,t){const n=((e,t)=>({eventType:o.YU.SEND_TRANSCRIPT,data:{consumerContact:{id:e},consumerRecipients:[{idOnExternalPlatform:t}]}}))(e,t);return Ye(n,this._websocketClient)}_setThreadAndCustomerExists(){var e;this._exists=!0,null===(e=this._customer)||void 0===e||e.setExists(!0)}_clearCustomFieldsOnContactStatusChangedToClosed(e){const t=e.detail;bt(t)&&t.data.case.status===Tt.P.CLOSED&&this._customFields.clear()}_mergeCustomFieldsAndAccessTokenWithMessageData(e,t){var n,o,r,s,i,a;let c;const l=null!==(n=this._isAuthorizationEnabled&&u())&&void 0!==n&&n;!1!==l&&(c={token:l.token}),Me(this._customFields,e.consumerContact.customFields);const d={customFields:je(this._customFields)};let E;return t||(null===(o=this._customer)||void 0===o||o.setCustomFieldsFromArray(null!==(s=null===(r=e.consumer)||void 0===r?void 0:r.customFields)&&void 0!==s?s:[]),E={customFields:null!==(a=null===(i=this._customer)||void 0===i?void 0:i.getCustomFieldsArray())&&void 0!==a?a:[]}),Object.assign(Object.assign({},e),{accessToken:c,consumer:E,consumerContact:d})}_registerEventHandlers(){this.onThreadEvent(Ze.CASE_CREATED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(Ze.CONTACT_CREATED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(Ze.THREAD_RECOVERED,(()=>this._setThreadAndCustomerExists())),this.onThreadEvent(Ze.CONTACT_STATUS_CHANGED,(e=>this._clearCustomFieldsOnContactStatusChangedToClosed(e)))}}function Vt(e){const t={eventType:o.YU.RECOVER_LIVECHAT,data:{}};return void 0===e?t:Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}})}class Yt extends Bt{constructor(e,t,n,o,r={},s=!1){super(e,t,n,o,r,s),this._isInitialized=!1,this._canSendMessage=!0,this._registerLivechatEventHandlers()}async recover(){const e=await Ye(Vt(this.idOnExternalPlatform),this._websocketClient);if(Gt(e)){const t=e.data,{contact:n,consumerContact:o}=t,r=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n}(t,["contact","consumerContact"]);return Object.assign(Object.assign({},r),{contact:null!=n?n:o})}throw new xt("Thread recover fail",e)}async sendMessage(e){if(!1===this._canSendMessage)throw new l("Cannot send more messages to Contact");return super.sendMessage(e)}async startChat(e="Begin conversation"){if(this._isInitialized)throw new l("Chat is already initialized");try{const t=await this.sendTextMessage(e);return this._isInitialized=!0,t}catch(e){if(e instanceof Error)throw new l(`Sending initial message failed because of (${e.message})`);return}}async endChat(){const t=i.get(e.THREAD_DATA,"{}"),n=JSON.parse(t),r=null==n?void 0:n.contactId;if(Fe(r))throw new l("Cannot end Chat because of missing ContactId in the storage");await Ye(function(e,t){return{eventType:o.YU.END_CONTACT,data:{thread:{idOnExternalPlatform:e},contact:{id:t}}}}(this.idOnExternalPlatform,r),this._websocketClient)}_registerLivechatEventHandlers(){this.onThreadEvent(Ze.LIVECHAT_RECOVERED,(e=>{Gt(e.detail)&&this._setThreadAndCustomerExists()}))}}const Wt=e=>"threads"in e;function Qt(t){const n=i.get(e.THREAD_DATA,"{}"),o=JSON.parse(n)||{};i.set(e.THREAD_DATA,JSON.stringify(Object.assign(Object.assign({},o),{contactId:t})))}function zt(e){var t,n,o;return It(e)&&Qt(e.data.case.id),Gt(e)&&Qt(null!==(n=null===(t=e.data.consumerContact)||void 0===t?void 0:t.caseId)&&void 0!==n?n:null===(o=e.data.contact)||void 0===o?void 0:o.id),e}function $t(t){var n;const o=null===(a=t.messages,n=(c=null==a?0:a.length)?a[c-1]:void 0)||void 0===n?void 0:n.createdAt,r=i.get(e.THREAD_DATA,"{}"),s=JSON.parse(r)||{};var a,c;i.set(e.THREAD_DATA,JSON.stringify(Object.assign(Object.assign({},s),{scrollToken:t.scrollToken,oldestMessageDatetime:Fe(o)?"":o})))}function Kt(e){if(Gt(e)){const{messages:t,messagesScrollToken:n}=e.data;$t({messages:t,scrollToken:n})}if(Dt(e)){const{scrollToken:t,messages:n}=e.data;$t({scrollToken:t,messages:n})}return e}class Jt extends Error{constructor(e="Aborted"){super(e),this.name="AbortError"}}class Xt extends Promise{constructor(e){const t=new AbortController,n=t.signal;super(((t,o)=>{n.addEventListener("abort",(()=>{o(new Jt(this.abortReason))})),null==e||e(t,o,n)})),this.abort=e=>{this._abortReason=null!=e?e:"Aborted",t.abort()}}get abortReason(){return this._abortReason}}Xt.from=e=>e instanceof Xt?e:new Xt(((t,n)=>{e.then(t).catch(n)}));class Zt{constructor(t){var n,r;if(this.isLivechat=!1,this.channelId="",this.websocketClient=null,this.customer=null,this._incomingChatEventMiddleware=new et,this.isAuthorizationEnabled=!1,this._threadCache=new Map,this._contactCustomFieldsQueue=new Map,this._sendRefreshTokenEvent=async()=>{const e=u();if(a(e))return;const t=await Ye((n=e.token,{eventType:o.YU.REFRESH_TOKEN,data:{accessToken:{token:n}}}),this.websocketClient);var n;if(Ke(t))return c(t.data.accessToken),void ze(t.data.accessToken,this._sendRefreshTokenEvent);throw new d("An error occurred while refreshing the access token",t.error)},void 0===t)throw new l("No options was provided for initialization of ChatSdk");i.set(e.AUTHORIZATION_CODE,t.authorizationCode),i.set(e.BRAND_ID,`${t.brandId}`),i.set(e.CHANNEL_ID,t.channelId),i.set(e.APP_NAME,null!==(n=t.appName)&&void 0!==n?n:"chat-web-sdk"),i.set(e.APP_VERSION,`${null!==(r=t.appVersion)&&void 0!==r?r:0}`);const{brandId:s,channelId:E}=xe();this.onError=t.onError,this.onRawEvent=t.onRawEvent,this._incomingChatEventMiddleware.register(ct),this._incomingChatEventMiddleware.register(Kt),this._incomingChatEventMiddleware.register(zt),this._messageEmitter=new tt;try{if(isNaN(s))throw new Error("Missing BrandID");if(void 0===E)throw new Error("Missing ChannelId");if(void 0===t.customerId)throw new Error("Missing CustomerId");this._initEnvironment(t),this._initWS(s,E,t.customerId),this.customer=new ke(t.customerId,t.customerName,t.customerImage,this.websocketClient),this.channelId=E}catch(e){this.onErrorHandler(e)}}onErrorHandler(e){if("function"!=typeof this.onError)throw new l(e);this.onError(new l(e))}async authorize(t,r){var s,a,_,v,T,f,p;const m=u();if(null!==m)try{const e=await async function(e,t,n,o){const r=We(n,o),s=await Ye(r,e);if(void 0!==s.error)throw new d("Authorization reconnect failed",s.error);return ze(n,t),{reconnected:!0}}(this.websocketClient,this._sendRefreshTokenEvent,m,r);return e}catch(e){}const C=function(e,t=(0,E.v4)()){return Object.assign({eventType:o.YU.AUTHORIZE_CUSTOMER,data:{authorization:{authorizationCode:e}}},h(t))}(null!=t?t:i.get(e.AUTHORIZATION_CODE,null),r),g=Ve(Be(C),(0,E.v4)(),n.p.REGISTER),A=await De(g,this.websocketClient);if(!$e(A))throw null===(s=this.websocketClient)||void 0===s||s.disconnect(),new d("Authorization failed",A.error);const{consumerIdentity:O,customer:y,channel:S,contact:N}=A.data,b=null==O?void 0:O.idOnExternalPlatform;if(He(I=b)||""===I)throw null===(a=this.websocketClient)||void 0===a||a.disconnect(),new l("Invalid customer identity");var I;ke.setId(b),void 0===O.firstName&&void 0===O.lastName||ke.setName(`${O.firstName} ${O.lastName}`);const w=O.image;return void 0!==w&&ke.setImage(w),(null==y?void 0:y.customFields)&&(null===(_=this.customer)||void 0===_||_.setCustomFieldsFromArray(y.customFields)),(null==N?void 0:N.customFields)&&Me(this._contactCustomFieldsQueue,N.customFields),this.isLivechat=null!==(T=null===(v=null==S?void 0:S.settings)||void 0===v?void 0:v.isLivechat)&&void 0!==T&&T,this.isAuthorizationEnabled=null!==(f=null==S?void 0:S.settings.isAuthorizationEnabled)&&void 0!==f&&f,void 0!==(null===(p=A.data.accessToken)||void 0===p?void 0:p.token)&&(c(A.data.accessToken),ze(A.data.accessToken,this._sendRefreshTokenEvent)),A.data}async generateAuthorizationToken(e,t){const n=await Ye(function(e,t){return{eventType:o.YU.GENERATE_AUTHORIZATION_TOKEN,data:{thread:{idOnExternalPlatform:e},url:t}}}(e,t),this.websocketClient);if(!("authorizationToken"in n.data))throw new l("Invalid response from generate authorization token (generateAuthorizationToken)");const{authorizationToken:r}=n.data;return r}onChatEvent(e,t){return this._messageEmitter.addEventListener(e,t),()=>{this._messageEmitter.removeEventListener(e,t)}}getCustomer(){return this.customer}getThread(e){if(a(this.websocketClient))throw new l("Cannot get thread because websocket is disconnected");if(He(e))throw new l("Cannot get thread because id is undefined");const t=this._threadCache.get(e);if(!Fe(t))return t;if(this.isLivechat){const t=new Yt(e,this.websocketClient,this._messageEmitter,this.customer,this._getContactCustomFieldsFromQueue(),this.isAuthorizationEnabled);return this._threadCache.set(e,t),t}const n=new Bt(e,this.websocketClient,this._messageEmitter,this.customer,this._getContactCustomFieldsFromQueue(),this.isAuthorizationEnabled);return this._threadCache.set(e,n),n}async getThreadList(){if(a(this.websocketClient))throw new l("Cannot get thread list because websocket is disconnected");const e={eventType:o.YU.FETCH_THREAD_LIST,data:{}},t=await Ye(e,this.websocketClient);if(!Wt(t.data))throw new l("Invalid response from fetch thread list (getThreadList)");return t.data.threads}getWebsocketClient(){return this.websocketClient}async sendOfflineMessage(e){return(async(e,t)=>{const n=(e=>{const[t,...n]=e.name.split(" ").reverse(),r=n.reverse().join(" "),s={idOnExternalPlatform:e.email,firstName:r,lastName:t},i={messageContent:{type:dt.C.TEXT,payload:{text:e.message}}};return{eventType:o.YU.SEND_OFFLINE_MESSAGE,consumerIdentity:s,data:i}})(e),r=await Ye(n,t);if(ut(r))return r;throw new lt("Send offline message failed",r)})(e,this.websocketClient)}recoverThreadData(e){return new Xt((async(t,n)=>{const o=Lt(e),r=await Ye(o,this.websocketClient);Gt(r)?t(r):n(new l("Invalid response from recover livechat thread"))}))}recoverLivechatThreadData(e){return new Xt((async(t,n)=>{const o=Vt(e),r=await Ye(o,this.websocketClient);Gt(r)?t(r):n(new l("Invalid response from recover livechat thread"))}))}_getContactCustomFieldsFromQueue(){if(this._contactCustomFieldsQueue.size>0){const e=Ge(this._contactCustomFieldsQueue);return this._contactCustomFieldsQueue.clear(),e}return{}}_initEnvironment(t){var n,o;if(t.environment===Je.custom){if(we(t.customEnvironment))throw new l('customEnvironment must be provided when environment is set to "custom"');return i.set(e.ENDPOINT_GATEWAY,null===(n=t.customEnvironment)||void 0===n?void 0:n.gateway),void i.set(e.ENDPOINT_CHAT,null===(o=t.customEnvironment)||void 0===o?void 0:o.chat)}const{gateway:r,chat:s}=function(e){const t="{ENV}",n="https://channels-de-{ENV}.niceincontact.com",o="wss://chat-gateway-de-{ENV}.niceincontact.com";switch(e){case Je.AU1:return{chat:n.replace(t,"au1"),name:"Australia",gateway:o.replace(t,"au1")};case Je.CA1:return{chat:n.replace(t,"ca1"),name:"Canada",gateway:o.replace(t,"ca1")};case Je.EU1:return{chat:n.replace(t,"eu1"),name:"Europe",gateway:o.replace(t,"eu1")};case Je.JP1:return{chat:n.replace(t,"jp1"),name:"Japan",gateway:o.replace(t,"jp1")};case Je.NA1:return{chat:n.replace(t,"na1"),name:"North America",gateway:o.replace(t,"na1")};case Je.UK1:return{chat:n.replace(t,"uk1"),name:"United Kingdom",gateway:o.replace(t,"uk1")};case Je.custom:return{chat:"",name:"Custom",gateway:""};default:throw new l(`Unknown environment: ${e}`)}}(t.environment);i.set(e.ENDPOINT_GATEWAY,r),i.set(e.ENDPOINT_CHAT,s)}_initWS(n,o,r){const s=i.get(e.ENDPOINT_GATEWAY);!function(e){if(null==e)throw Error(`Expected non-nullish value, got ${e}`)}(s);const a=new URL(s),c=a.protocol,u={host:a.hostname,port:a.port,prefix:a.pathname.substring(1),forceSecureProtocol:"wss:"===c};this.websocketClient=new vt(n,o,r,u,this.onError),this.websocketClient.on(t.xT.MESSAGE,(async e=>{try{"function"==typeof this.onRawEvent&&this.onRawEvent(e);const t=await(async e=>{if(He(e))return null;if(e.type!==Xe.m.EVENT_IN_S3)return e;const t=e.data.s3Object.url,n=await fetch(t);if(n.ok)return it(await n.json());throw new l("Failed to fetch S3 event data")})((e=>{const t=null==e?void 0:e.detail;if(!t)return;let n;try{n=JSON.parse(t.data)}catch(e){return}return it(n)})(e)),n=this._incomingChatEventMiddleware.process(t);if(!He(n)){const{type:e}=n;(e=>{const{id:t}=e;if(Re.has(t)){const n=Re.get(t);"function"==typeof n&&n(e),Re.delete(t)}})(n),this._messageEmitter.dispatchEvent(new qe(null!=e?e:"",{detail:n}))}}catch(e){this.onErrorHandler(e)}}))}}function qt(e){var t,n;return e.type===Ze.ASSIGNED_AGENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function en(e){var t,n;return e.type===Ze.AGENT_TYPING_STARTED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}function tn(e){var t,n;return e.type===Ze.AGENT_TYPING_ENDED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}var nn=r(510);const on=e=>{var t,n,o,r,s,i;return e.direction===nn.T.INBOUND?null!==(n=null===(t=e.authorEndUserIdentity)||void 0===t?void 0:t.fullName)&&void 0!==n?n:"":`${null!==(r=null===(o=e.authorUser)||void 0===o?void 0:o.firstName)&&void 0!==r?r:""} ${null!==(i=null===(s=e.authorUser)||void 0===s?void 0:s.surname)&&void 0!==i?i:""}`.trim()};function rn(e){const t=!1===Fe(e.id),n=!1===Fe(e.direction),o=!1===Fe(e.messageContent);return t&&n&&o}function sn(e){return e.type===Xe.m.MESSAGE_CREATED}function an(e){return e.type===Xe.m.MESSAGE_SENT}function cn(e){return e.type===Xe.m.MESSAGE_READ_CHANGED}const un=e=>{const t=e;return Number.isInteger(null==t?void 0:t.data.positionInQueue)&&!1===we(null==t?void 0:t.id)&&(null==t?void 0:t.type)===o.Ne.SET_POSITION_IN_QUEUE};class ln extends l{}function dn(e){return{eventType:o.YU.CREATE_GROUP_CHAT_INVITE,data:{contact:{id:e}}}}async function En(e,t){const n=await Ye(e,t);if(function(e){return e.type===Ze.GROUP_CHAT_INVITE_CREATED}(n))return n;throw new ln("Create invitation failed",n)}class hn extends l{}function _n(e){return{eventType:o.YU.JOIN_GROUP_CHAT,data:{invitation:{code:e}}}}async function vn(e,t){const n=await Ye(e,t);if(function(e){return e.type===Ze.GROUP_CHAT_JOINED}(n))return n;throw new hn("Join Group chat failed",n)}function Tn(e){return{eventType:o.YU.LEAVE_GROUP_CHAT,data:{contact:{id:e}}}}async function fn(e,t){return Ye(e,t)}class pn extends l{}function mn(e,t,n){return{eventType:o.YU.SEND_EMAIL_INVITE_TO_GROUP_CHAT,data:{contact:{id:e},invitation:{code:t},recipients:[{idOnExternalPlatform:n}]}}}async function Cn(e,t){const n=await Ye(e,t);if(function(e){return e.type===Ze.GROUP_CHAT_INVITE_SENT}(n))return n;throw new pn("Send Email Invitation failed",n)}function gn(e){return"object"==typeof e&&null!==e&&"reconnected"in e&&!0===e.reconnected}const An=Zt})(),s})()));