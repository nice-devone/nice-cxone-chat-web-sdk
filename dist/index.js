/*! For license information please see index.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("ua-parser-js"));else if("function"==typeof define&&define.amd)define(["ua-parser-js"],t);else{var n="object"==typeof exports?t(require("ua-parser-js")):t(e["ua-parser-js"]);for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(self,(e=>(()=>{"use strict";var t={0:(e,t)=>{var n;t.m=void 0,function(e){e.AUTHORIZE_CONSUMER="AuthorizeConsumer",e.CASE_CREATED="CaseCreated",e.CASE_INBOX_ASSIGNEE_CHANGED="CaseInboxAssigneeChanged",e.CASE_STATUS_CHANGED="CaseStatusChanged",e.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",e.CONTACT_CREATED="CaseCreated",e.ASSIGNED_AGENT_CHANGED="CaseInboxAssigneeChanged",e.CONTACT_STATUS_CHANGED="CaseStatusChanged",e.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED="CaseToRoutingQueueAssignmentChanged",e.CONTACT_PREFERRED_USER_CHANGED="ContactPreferredUserChanged",e.CONTACT_PROFICIENCY_CHANGED="ContactProficiencyChanged",e.CONTACT_PRIORITY_CHANGED="ContactPriorityChanged",e.CONTACT_SYNC="ContactSync",e.CHANNEL_CREATED="ChannelCreated",e.CHANNEL_DELETED="ChannelDeleted",e.CHANNEL_UPDATED="ChannelUpdated",e.MESSAGE_ADDED_INTO_CASE="MessageAddedIntoCase",e.MESSAGE_CREATED="MessageCreated",e.MESSAGE_DELIVERED_TO_END_USER="MessageDeliveredToEndUser",e.MESSAGE_DELIVERED_TO_USER="MessageDeliveredToUser",e.MESSAGE_DELIVERY_STATUS_CHANGED="MessageDeliveryStatusChanged",e.MESSAGE_NOTE_CREATED="MessageNoteCreated",e.MESSAGE_NOTE_UPDATED="MessageNoteUpdated",e.MESSAGE_NOTE_DELETED="MessageNoteDeleted",e.MESSAGE_READ_CHANGED="MessageReadChanged",e.MESSAGE_SEEN_BY_END_USER="MessageSeenByEndUser",e.MESSAGE_SEEN_BY_USER="MessageSeenByUser",e.MESSAGE_SEEN_CHANGED="MessageSeenChanged",e.MESSAGE_SENT="MessageSent",e.MESSAGE_UPDATED="MessageUpdated",e.PAGE_VIEW_CREATED="PageViewCreated",e.ROUTING_QUEUE_CREATED="RoutingQueueCreated",e.ROUTING_QUEUE_DELETED="RoutingQueueDeleted",e.ROUTING_QUEUE_UPDATED="RoutingQueueUpdated",e.SUBQUEUE_ASSIGNED_TO_ROUTING_QUEUE="SubqueueAssignedToRoutingQueue",e.SUBQUEUE_UNASSIGNED_TO_ROUTING_QUEUE="SubqueueUnassignedFromRoutingQueue",e.USER_ASSIGNED_TO_ROUTING_QUEUE="UserAssignedToRoutingQueue",e.USER_STATUS_CHANGED="UserStatusChanged",e.USER_UNASSIGNED_FROM_ROUTING_QUEUE="UserUnassignedFromRoutingQueue",e.AGENT_CONTACT_STARTED="AgentContactStarted",e.AGENT_CONTACT_ENDED="AgentContactEnded",e.SENDER_TYPING_STARTED="SenderTypingStarted",e.SENDER_TYPING_ENDED="SenderTypingEnded",e.FIRE_PROACTIVE="FireProactiveAction",e.CONTACT_INBOX_PRE_ASSIGNEE_CHANGED="ConsumerContactInboxPreAssigneeChanged",e.CONTACT_RECIPIENTS_CHANGED="ContactRecipientsChanged",e.MESSAGE_PREVIEW_CREATED="MessagePreviewCreated",e.EVENT_IN_S3="EventInS3"}(n||(t.m=n={}))},10:(e,t)=>{t.C=void 0,t.C=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},168:(e,t,n)=>{t.P=void 0;var r=n(275);Object.defineProperty(t,"P",{enumerable:!0,get:function(){return r.CaseStatus}})},172:(e,t,n)=>{t.NP=t.nF=void 0;n(547),n(383),n(272);var r=n(402);Object.defineProperty(t,"nF",{enumerable:!0,get:function(){return r.WebSocketClientEvent}});var o=n(720);Object.defineProperty(t,"NP",{enumerable:!0,get:function(){return o.setupSocketConnection}})},198:t=>{t.exports=e},272:function(e,t,n){var r,o=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=t.HEART_BEAT_CHECK_TIMEOUT=t.HEART_BEAT_INTERVAL=void 0;var s=n(802),i=n(906),a=n(383),c=n(547),u=n(402);t.HEART_BEAT_INTERVAL=15e3,t.HEART_BEAT_CHECK_TIMEOUT=3*t.HEART_BEAT_INTERVAL;var l=function(e){function n(n,r,o){var a=e.call(this)||this;return a.heartBeatTimeout=null,a.heartBeatCheckTimeout=null,a.enableDebugMode=function(){a.debugMode||a.log(s.LogLevels.INFO,"websocket-push-updates--loggerEnabled"),a.debugMode=!0},a.disableDebugMode=function(){a.debugMode=!1},a.log=function(e,t,n){a.debugMode&&a.logger&&a.logger[e](t,n)},a.sendHeartBeat=function(){a.log(s.LogLevels.INFO,"websocket-push-updates--sendHeartBeat"),a.send(JSON.stringify({action:"heartbeat"}))},a.handleHeartBeatResponse=function(){a.heartBeatState===c.HeartBeatState.DYING&&(a.heartBeatState=c.HeartBeatState.LIVING,a.dispatchHeartBeatState()),a.setHeartBeatCheckTimeout()},a.setHeartBeatCheckTimeout=function(){null!==a.heartBeatCheckTimeout&&clearTimeout(a.heartBeatCheckTimeout),a.heartBeatCheckTimeout=setTimeout((function(){a.heartBeatState=c.HeartBeatState.DYING,a.dispatchHeartBeatState()}),t.HEART_BEAT_CHECK_TIMEOUT)},a.dispatchHeartBeatState=function(){a.log(s.LogLevels.INFO,"websocket-push-updates--dispatchHeartBeatState",[{heartbeatState:a.heartBeatState}]),null!==a.heartBeatState&&a.dispatchEvent(new CustomEvent(a.heartBeatState))},a.isHeartBeatActive=function(){return null!==a.heartBeatState},a.heartBeatState=null,a.debugMode=!1,a.socket=new i.ReconnectingWebSocket(n,r,o),a.socket.onopen=function(){a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.OPEN))},(null==o?void 0:o.logger)&&(a.logger=o.logger),a.socket.onclose=function(e){a.socket.retryCount===(null==o?void 0:o.maxRetries)?a.heartBeatState=c.HeartBeatState.DIED:a.heartBeatState=c.HeartBeatState.DYING,a.dispatchHeartBeatState(),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.CLOSE,{detail:e}))},a.socket.onmessage=function(e){a.handleHeartBeatResponse(),"pong"!==JSON.parse(e.data)&&(a.log(s.LogLevels.INFO,"websocket-push-updates--onmessage",[e]),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.MESSAGE,{detail:e})))},a.socket.onerror=function(e){a.log(s.LogLevels.ERROR,"websocket-push-updates--onError",[e]),a.dispatchEvent(new CustomEvent(u.WebSocketClientEvent.ERROR,{detail:e}))},a}return o(n,e),n.prototype.send=function(e){this.socket.send(e)},n.prototype.startHeartBeat=function(){var e=this;this.log(s.LogLevels.INFO,"websocket-push-updates--startHeartBeat",[{interval:t.HEART_BEAT_INTERVAL}]);var n=function(){e.log(s.LogLevels.INFO,"websocket-push-updates--heartBeatCallback"),e.sendHeartBeat(),e.heartBeatTimeout=setTimeout(n,t.HEART_BEAT_INTERVAL)};this.setHeartBeatCheckTimeout(),n(),this.heartBeatState=c.HeartBeatState.LIVING},n.prototype.stopHeartBeat=function(){this.log(s.LogLevels.INFO,"websocket-push-updates--stopHeartBeat"),null!==this.heartBeatTimeout&&clearTimeout(this.heartBeatTimeout),null!==this.heartBeatCheckTimeout&&clearTimeout(this.heartBeatCheckTimeout),this.heartBeatState=null},n}(a.EventTargetPolyfill);t.WebSocketClient=l},275:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.CaseStatus=void 0,function(e){e.NEW="new",e.OPEN="open",e.PENDING="pending",e.ESCALATED="escalated",e.RESOLVED="resolved",e.CLOSED="closed",e.TRASHED="trashed"}(n||(t.CaseStatus=n={}))},369:(e,t)=>{var n;t.F=void 0,function(e){e.ONLINE="online",e.OFFLINE="offline"}(n||(t.F=n={}))},383:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EventTargetPolyfill=void 0;var n=function(){function e(){this.listeners={}}return e.prototype.addEventListener=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.removeEventListener=function(e,t){if(e in this.listeners)for(var n=this.listeners[e],r=0,o=n.length;r<o;r++)if(n[r]===t)return void n.splice(r,1)},e.prototype.dispatchEvent=function(e){if(!(e.type in this.listeners))return!0;for(var t=this.listeners[e.type].slice(),n=0,r=t.length;n<r;n++)t[n].call(this,e);return!e.defaultPrevented},e}();t.EventTargetPolyfill=n},402:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClientEvent=void 0,(n=t.WebSocketClientEvent||(t.WebSocketClientEvent={})).CLOSE="close",n.ERROR="error",n.MESSAGE="message",n.OPEN="open",n.AUTHORIZATION_FAILED="authorizationFailed"},434:(e,t)=>{var n;t.G=void 0,function(e){e.TEXT="TEXT",e.FILE="FILE",e.FORM="FORM",e.PLUGIN="PLUGIN",e.POSTBACK="POSTBACK",e.QUICK_REPLIES="QUICK_REPLIES",e.RICH_LINK="RICH_LINK",e.LIST_PICKER="LIST_PICKER",e.ADAPTIVE_CARD="ADAPTIVE_CARD",e.TIME_PICKER="TIME_PICKER"}(n||(t.G=n={}))},442:(e,t)=>{var n,r;t.Xr=t.bq=void 0,function(e){e.DESKTOP="desktop",e.MOBILE="mobile",e.OTHER="other",e.TABLET="tablet"}(n||(t.bq=n={})),function(e){e.BROWSER="browser"}(r||(t.Xr=r={}))},482:(e,t)=>{var n,r;t.vc=t.ow=void 0,function(e){e.SENDER_TYPING_STARTED="SenderTypingStarted",e.SENDER_TYPING_ENDED="SenderTypingEnded",e.LOAD_MORE_MESSAGES="LoadMoreMessages",e.RECOVER_LIVECHAT="RecoverLivechat",e.RECOVER_THREAD="RecoverThread",e.SEND_MESSAGE="SendMessage",e.SEND_OUTBOUND="SendOutbound",e.SEND_OFFLINE_MESSAGE="SendOfflineMessage",e.SEND_PAGE_VIEWS="SendPageViews",e.SEND_CONSUMER_CUSTOM_FIELDS="SetConsumerCustomFields",e.SET_CONSUMER_CONTACT_CUSTOM_FIELD="SetConsumerContactCustomFields",e.MESSAGE_SEEN="MessageSeenByConsumer",e.SEND_TRANSCRIPT="SendTranscript",e.FETCH_THREAD_LIST="FetchThreadList",e.END_CONTACT="EndContact",e.EXECUTE_TRIGGER="ExecuteTrigger",e.AUTHORIZE_CONSUMER="AuthorizeConsumer",e.AUTHORIZE_CUSTOMER="AuthorizeCustomer",e.RECONNECT_CONSUMER="ReconnectConsumer",e.UPDATE_THREAD="UpdateThread",e.ARCHIVE_THREAD="ArchiveThread",e.LOAD_THREAD_METADATA="LoadThreadMetadata",e.REFRESH_TOKEN="RefreshToken",e.STORE_VISITOR="StoreVisitor",e.STORE_VISITOR_EVENTS="StoreVisitorEvents",e.CREATE_GROUP_CHAT_INVITE="CreateInvitationToGroupChat",e.SEND_EMAIL_INVITE_TO_GROUP_CHAT="SendEmailInvitationToGroupChat",e.JOIN_GROUP_CHAT="JoinGroupChat",e.LEAVE_GROUP_CHAT="LeaveGroupChat",e.GENERATE_AUTHORIZATION_TOKEN="GenerateAuthorizationToken",e.ADD_VISITOR_TAGS="AddVisitorTags",e.REMOVE_VISITOR_TAGS="RemoveVisitorTags",e.SEND_MESSAGE_PREVIEW="SendMessagePreview"}(n||(t.ow=n={})),function(e){e.LIVECHAT_RECOVERED="LivechatRecovered",e.MORE_MESSAGES_LOADED="MoreMessagesLoaded",e.OFFLINE_MESSAGE_SENT="OfflineMessageSent",e.THREAD_LIST_FETCHED="ThreadListFetched",e.THREAD_RECOVERED="ThreadRecovered",e.TRANSCRIPT_SENT="TranscriptSent",e.CONSUMER_AUTHORIZED="ConsumerAuthorized",e.THREAD_METADATA_LOADED="ThreadMetadataLoaded",e.SET_POSITION_IN_QUEUE="SetPositionInQueue",e.GROUP_CHAT_INVITE_CREATED="InvitationToGroupChatCreated",e.GROUP_CHAT_INVITE_SENT="EmailInvitationToGroupChatSent",e.GROUP_CHAT_JOINED="GroupChatJoined",e.TOKEN_REFRESHED="TokenRefreshed",e.AUTHORIZATION_TOKEN_GENERATED="AuthorizationTokenGenerated",e.THREAD_ARCHIVED="ThreadArchived"}(r||(t.vc=r={}))},521:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeEmptyValuesFromObject=void 0,t.removeEmptyValuesFromObject=function(e){return Object.entries(e).filter((function(e){return e[0],null!=e[1]})).reduce((function(e,t){var n=t[0],r=t[1];return e[n]=r,e}),{})}},547:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.HeartBeatState=void 0,(n=t.HeartBeatState||(t.HeartBeatState={})).DIED="died",n.DYING="dying",n.LIVING="living"},668:(e,t)=>{var n;t.V=void 0,function(e){e.CHAT_WINDOW_EVENT="chatWindowEvent",e.REGISTER="register"}(n||(t.V=n={}))},720:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__rest||function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};Object.defineProperty(t,"__esModule",{value:!0}),t.getPushUpdateWebSocket=t.setupSocketConnection=void 0;var s=n(892),i=n(734),a=n(521),c=n(272),u=null,l={forceSecureProtocol:!1,heartbeatAfterAuthorize:!1,maxRetries:20,maxReconnectionDelay:1e3};t.setupSocketConnection=function(e,t){if(void 0===t&&(t={}),"object"!=typeof t)throw new TypeError("Options parameter must be an object not a ".concat(typeof t));var n=r(r({},l),t),d=n.forceSecureProtocol,h=n.heartbeatAfterAuthorize,E=n.tenantId,f=n.userId,v=n.brandId,_=o(n,["forceSecureProtocol","heartbeatAfterAuthorize","tenantId","userId","brandId"]);return"string"==typeof e&&(e=function(e,t,n){void 0===n&&(n={});var r=(0,s.createQueryParametersAsString)((0,a.removeEmptyValuesFromObject)(n)),o=t||"https:"===window.location.protocol?"wss:":"ws:";return 0===r.length?"".concat(o,"//").concat(e):new URL("".concat(o,"//").concat(e)).search.length>0?"".concat(o,"//").concat(e,"&").concat(r):"".concat(o,"//").concat(e,"?").concat(r)}(e,d,{tenantId:E,userId:f,brandId:v})),u=new c.WebSocketClient(e,void 0,_),(0,i.initializeHeartbeat)(h,u,t),u},t.getPushUpdateWebSocket=function(){return u}},734:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.initializeHeartbeat=void 0;var r=n(402);t.initializeHeartbeat=function(e,t,n){if(e){var o=function(e){var s;try{var i=JSON.parse(e.detail.data);"authorized"===(null==i?void 0:i.authorizationStatus)&&(t.startHeartBeat(),t.removeEventListener(r.WebSocketClientEvent.MESSAGE,o))}catch(e){null===(s=null==n?void 0:n.logger)||void 0===s||s.warn("JSON cannot be parsed during the heartbeat initialization process.")}};t.addEventListener(r.WebSocketClientEvent.MESSAGE,o)}else t.startHeartBeat()}},796:(e,t)=>{t.Um=void 0,t.Um="X-Caller-Service-ID"},802:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LogLevels=void 0,(n=t.LogLevels||(t.LogLevels={})).ERROR="error",n.INFO="info",n.WARN="warn"},892:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createQueryParametersAsString=void 0,t.createQueryParametersAsString=function(e){return Object.keys(e).filter((function(t){return null!==e[t]})).map((function(t){return[t,e[t]].map(encodeURIComponent).join("=")})).join("&")}},906:function(e,t){var n=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},r=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}return i},o=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,o=0,s=t.length;o<s;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.ReconnectingWebSocket=void 0;var s={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},i=function(){function e(e,t,n){void 0===n&&(n={});var r=this;this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._listeners={error:[],message:[],open:[],close:[]},this._shouldReconnect=!0,this._connectLock=!1,this._closeCalled=!1,this._messageQueue=[],this._retryCount=-1,this._binaryType="blob",this._handleOpen=function(e){r._debug("open event");var t=r._options.minUptime,n=void 0===t?s.minUptime:t;clearTimeout(r._connectTimeout),r._uptimeTimeout=window.setTimeout((function(){return r._acceptOpen()}),n),r._ws.binaryType=r._binaryType,r._messageQueue.forEach((function(e){var t;return null===(t=r._ws)||void 0===t?void 0:t.send(e)})),r._messageQueue=[],r.onopen&&r.onopen(e),r._listeners.open.forEach((function(t){return r._callEventListener(e,t)}))},this._handleMessage=function(e){r._debug("message event"),r.onmessage&&r.onmessage(e),r._listeners.message.forEach((function(t){return r._callEventListener(e,t)}))},this._handleError=function(e){r._debug("error event",e),r._disconnect(),r.onerror&&r.onerror(e),r._debug("exec error listeners"),r._listeners.error.forEach((function(t){return r._callEventListener(e,t)})),r._connect()},this._handleClose=function(e){r._debug("close event"),r._clearTimeouts(),r._shouldReconnect&&r._connect(),r.onclose&&r.onclose(e),r._listeners.close.forEach((function(t){return r._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._maxRetries="number"==typeof n.maxRetries?n.maxRetries:s.maxRetries,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?WebSocket.CLOSED:WebSocket.CONNECTING},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!1,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==WebSocket.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==WebSocket.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===WebSocket.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?s.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,r,o=this._listeners[e.type];if(o)try{for(var s=n(o),i=s.next();!i.done;i=s.next()){var a=i.value;this._callEventListener(e,a)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype.setMaxRetires=function(e){this._maxRetries=e},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,o(["RWS>"],r(e),!1))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?s.reconnectionDelayGrowFactor:t,r=e.minReconnectionDelay,o=void 0===r?s.minReconnectionDelay:r,i=e.maxReconnectionDelay,a=void 0===i?s.maxReconnectionDelay:i,c=0;return this._retryCount>0&&(c=o*Math.pow(n,this._retryCount-1))>a&&(c=a),this._debug("next delay",c),c},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(void 0!==t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options.connectionTimeout,n=void 0===t?s.connectionTimeout:t;this._retryCount>=this._maxRetries?this._debug("max retries reached",this._retryCount,">=",this._maxRetries):(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled?e._connectLock=!1:(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new WebSocket(t,e._protocols):new WebSocket(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=window.setTimeout((function(){return e._handleTimeout()}),n))})).catch((function(t){e._connectLock=!1,e._handleError(new ErrorEvent(t.message,{error:t}))})))}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ErrorEvent("TIMEOUT"))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new CloseEvent("CLOSE",{code:e,reason:t}))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();t.ReconnectingWebSocket=i},953:(e,t)=>{var n;t.T=void 0,function(e){e.INBOUND="inbound",e.OUTBOUND="outbound"}(n||(t.T=n={}))}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var s=n[e]={exports:{}};return t[e].call(s.exports,s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};r.r(o),r.d(o,{AbortError:()=>Nt,AbortablePromise:()=>rr,AuthorizationError:()=>f,CHAT_SDK_VERSION:()=>v,CacheStorage:()=>ho,CacheStorageError:()=>io,ChannelAvailability:()=>Eo.F,ChatEvent:()=>nn,ChatSDKError:()=>E,ChatSdk:()=>Br,ContactStatus:()=>Wn.P,CreateInvitationFailedError:()=>Qr,Customer:()=>st,EnvironmentName:()=>Yt,IpAddressBlockedError:()=>en,JoinGroupChatFailedError:()=>Jr,LivechatThread:()=>vr,MessageType:()=>pn.G,SdkVersionNotSupported:()=>Dt,SecureSessions:()=>Lt,SendEmailInvitationFailedError:()=>ro,SendMessageFailedError:()=>_n,Thread:()=>Er,ThreadRecoverFailedError:()=>hr,UploadAttachmentError:()=>$n,WebSocketClientError:()=>kn,WebSocketClientEvent:()=>i.nF,createAttachmentPayload:()=>zn,createAttachmentUploadMessageData:()=>Yn,createCreateInvitationToGroupChatPayloadData:()=>Kr,createJoinGroupChatPayloadData:()=>Zr,createLeaveGroupChatPayloadData:()=>to,createReconnectPayloadData:()=>Et,createSendEmailInvitationToGroupChatPayloadData:()=>oo,createTemporaryAttachmentsUpload:()=>Kn,default:()=>po,generateId:()=>_,getAuthor:()=>mn,getBrowserFingerprint:()=>St,getBrowserLanguage:()=>At,getBrowserLocation:()=>wt,getChannelAvailability:()=>_o,getChannelInfo:()=>vo,getCustomFieldsArray:()=>qe,getCustomFieldsFromArray:()=>Je,getDeviceType:()=>Ct,getValidLanguage:()=>Ot,isAgentTypingEndedEvent:()=>$r,isAgentTypingStartedEvent:()=>Wr,isAssignedAgentChangedEvent:()=>Vr,isAttachmentUpload:()=>Qn,isAuthSuccessEvent:()=>pt,isChatSDKError:()=>qr,isContactCreatedEvent:()=>Jn,isContactRecipientsChangedEvent:()=>Xn,isContactStatusChangedEvent:()=>qn,isContactToRoutingQueueAssignmentChangedEvent:()=>Zn,isCustomerReconnectSuccessPayloadData:()=>fo,isJoinGroupChatFailedError:()=>eo,isLoadMetadataSuccessPayload:()=>ir,isMessage:()=>gn,isMessageCreatedEvent:()=>yn,isMessageReadChangedEvent:()=>wn,isMessageSentEvent:()=>An,isMoreMessagesLoadedEvent:()=>tr,isRecoverSuccessEvent:()=>ar,isSetPositionInQueueEvent:()=>zr,isThreadArchivedSuccessPayload:()=>cr,isThreadListFetchedPostbackData:()=>_r,isTokenRefreshedSuccessResponse:()=>Tt,isWindowClosing:()=>jt,registerWindowUnload:()=>xt,sendChatEvent:()=>ht,sendCreateInvitationToGroupChatEvent:()=>Yr,sendEmailInvitationToGroupChatEvent:()=>so,sendJoinGroupChatEvent:()=>Xr,sendLeaveGroupChatEvent:()=>no,splitName:()=>Be});var s=r(10),i=r(172),a=r(668),c=r(482);const u=function(e){return null===e},l={};function d(e){l.ACCESS_TOKEN=e.token,l.ACCESS_TOKEN_EXPIRES_IN=e.expiresIn}function h(){var e,t;const n=null!==(e=l.ACCESS_TOKEN)&&void 0!==e?e:null,r=null!==(t=l.ACCESS_TOKEN_EXPIRES_IN)&&void 0!==t?t:null;return u(n)||u(r)?null:{token:n,expiresIn:Number(r)}}class E extends Error{constructor(e,t){if(super(),this.name="ChatSDKError",e instanceof E)return this.message=e.message,this.stack=e.stack,this.cause=e.cause,this.data=e.data,void(this.additionalInfo=t);this.data=t,"string"==typeof e&&(this.message=`[${this.name}]: ${e}`),e instanceof Error&&(this.message=`[${this.name}]: ${e.message}`,this.cause=e,this.stack=e.stack,this.additionalInfo=t),(null==t?void 0:t.error)instanceof Error&&(this.cause=t.error,this.message=`${this.message} (caused by: ${t.error.message})`)}}class f extends E{constructor(e,t){super(e,t),void 0!==t&&(this.message=`${e} because of (${t.errorMessage})`)}}const v=null!=="3.1.0"?"3.1.0":"0";function _(){return crypto.randomUUID?crypto.randomUUID():function(){const e=new Uint8Array(16);return crypto.getRandomValues(e).reduce(((e,t,n)=>([4,6,8,10].includes(n)&&(e+="-"),e+(6===n?15&t|64:8===n?63&t|128:t).toString(16).padStart(2,"0"))),"")}()}function p(e){return{visitor:{id:e}}}var T=Object.prototype;const m=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||T)},g=(y=Object.keys,A=Object,function(e){return y(A(e))});var y,A,w=Object.prototype.hasOwnProperty;const C="object"==typeof global&&global&&global.Object===Object&&global;var S="object"==typeof self&&self&&self.Object===Object&&self;const O=C||S||Function("return this")(),b=O.Symbol;var I=Object.prototype,N=I.hasOwnProperty,R=I.toString,D=b?b.toStringTag:void 0;var P=Object.prototype.toString;var k=b?b.toStringTag:void 0;const M=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":k&&k in Object(e)?function(e){var t=N.call(e,D),n=e[D];try{e[D]=void 0;var r=!0}catch(e){}var o=R.call(e);return r&&(t?e[D]=n:delete e[D]),o}(e):function(e){return P.call(e)}(e)},U=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},j=function(e){if(!U(e))return!1;var t=M(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},G=O["__core-js_shared__"];var x,L=(x=/[^.]+$/.exec(G&&G.keys&&G.keys.IE_PROTO||""))?"Symbol(src)_1."+x:"";var H=Function.prototype.toString;const F=function(e){if(null!=e){try{return H.call(e)}catch(e){}try{return e+""}catch(e){}}return""};var B=/^\[object .+?Constructor\]$/,V=Function.prototype,W=Object.prototype,$=V.toString,z=W.hasOwnProperty,Q=RegExp("^"+$.call(z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");const K=function(e){return!(!U(e)||function(e){return!!L&&L in e}(e))&&(j(e)?Q:B).test(F(e))},Y=function(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return K(n)?n:void 0},q=Y(O,"DataView"),J=Y(O,"Map"),Z=Y(O,"Promise"),X=Y(O,"Set"),ee=Y(O,"WeakMap");var te="[object Map]",ne="[object Promise]",re="[object Set]",oe="[object WeakMap]",se="[object DataView]",ie=F(q),ae=F(J),ce=F(Z),ue=F(X),le=F(ee),de=M;(q&&de(new q(new ArrayBuffer(1)))!=se||J&&de(new J)!=te||Z&&de(Z.resolve())!=ne||X&&de(new X)!=re||ee&&de(new ee)!=oe)&&(de=function(e){var t=M(e),n="[object Object]"==t?e.constructor:void 0,r=n?F(n):"";if(r)switch(r){case ie:return se;case ae:return te;case ce:return ne;case ue:return re;case le:return oe}return t});const he=de,Ee=function(e){return null!=e&&"object"==typeof e},fe=function(e){return Ee(e)&&"[object Arguments]"==M(e)};var ve=Object.prototype,_e=ve.hasOwnProperty,pe=ve.propertyIsEnumerable;const Te=fe(function(){return arguments}())?fe:function(e){return Ee(e)&&_e.call(e,"callee")&&!pe.call(e,"callee")},me=Array.isArray,ge=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var ye="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ae=ye&&"object"==typeof module&&module&&!module.nodeType&&module,we=Ae&&Ae.exports===ye?O.Buffer:void 0;const Ce=(we?we.isBuffer:void 0)||function(){return!1};var Se={};Se["[object Float32Array]"]=Se["[object Float64Array]"]=Se["[object Int8Array]"]=Se["[object Int16Array]"]=Se["[object Int32Array]"]=Se["[object Uint8Array]"]=Se["[object Uint8ClampedArray]"]=Se["[object Uint16Array]"]=Se["[object Uint32Array]"]=!0,Se["[object Arguments]"]=Se["[object Array]"]=Se["[object ArrayBuffer]"]=Se["[object Boolean]"]=Se["[object DataView]"]=Se["[object Date]"]=Se["[object Error]"]=Se["[object Function]"]=Se["[object Map]"]=Se["[object Number]"]=Se["[object Object]"]=Se["[object RegExp]"]=Se["[object Set]"]=Se["[object String]"]=Se["[object WeakMap]"]=!1;var Oe="object"==typeof exports&&exports&&!exports.nodeType&&exports,be=Oe&&"object"==typeof module&&module&&!module.nodeType&&module,Ie=be&&be.exports===Oe&&C.process,Ne=function(){try{return be&&be.require&&be.require("util").types||Ie&&Ie.binding&&Ie.binding("util")}catch(e){}}(),Re=Ne&&Ne.isTypedArray;const De=Re?function(e){return function(t){return e(t)}}(Re):function(e){return Ee(e)&&ge(e.length)&&!!Se[M(e)]};var Pe=Object.prototype.hasOwnProperty;const ke=function(e){if(null==e)return!0;if(function(e){return null!=e&&ge(e.length)&&!j(e)}(e)&&(me(e)||"string"==typeof e||"function"==typeof e.splice||Ce(e)||De(e)||Te(e)))return!e.length;var t=he(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(m(e))return!function(e){if(!m(e))return g(e);var t=[];for(var n in Object(e))w.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e).length;for(var n in e)if(Pe.call(e,n))return!1;return!0},Me=new Map,Ue=async(e,t)=>{if(u(t))throw new E("WebSocketClient is not initialized");return ke(e.eventId)&&(e.eventId=_()),new Promise((n=>{Me.set(e.eventId,n),null==t||t.send(e)}))},je=100,Ge=5;let xe=0,Le=null;class He extends Error{constructor(){super(...arguments),this.name="MaximumRequestCountReached",this.message="Maximum request count reached"}}function Fe(){xe=0}function Be(e){const[t,...n]=e.split(" ");return[t,n.join(" ")]}const Ve="Cannot refresh ThirdParty token",We="Failed to fetch transaction token",$e="Your IP address is blocked.",ze=function(e){return void 0===e};function Qe(e,t={}){for(const n of Object.keys(t))Ze(n,t[n]),e.set(n,t[n])}function Ke(e,t=[]){for(const{ident:n,value:r}of t)Ze(n,r),e.set(n,r)}function Ye(e){return Object.fromEntries(e)}function qe(e){return Array.from(e).map((([e,t])=>({ident:e,value:t})))}function Je(e){return Object.fromEntries(e.map((e=>[e.ident,e.value])))}function Ze(e,t){if(ze(e)||ze(t))throw new E("Custom field name and value must be set");if(!function(e){return null===e||"string"==typeof e&&e.length<=1024}(t))throw new E((e=>`Value of custom field "${e}" exceeds maximum length of 1024 characters`)(e))}var Xe,et,tt,nt=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},rt=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};function ot(e,t){const{idOnExternalPlatform:n,firstName:r="",lastName:o="",image:s,customFields:i}=t;e.setId(n),(r||o)&&e.setName(`${null!=r?r:""} ${null!=o?o:""}`.trim()),s&&e.setImage(s),me(i)&&e.setCustomFieldsFromArray(i)}class st{constructor(e,t,n,r){Xe.set(this,void 0),et.set(this,new Map),tt.set(this,!1),this.id=null,this.name=null,this.image=null,nt(this,Xe,null!=r?r:null,"f"),e&&this.setId(e),t&&this.setName(t),n&&this.setImage(n)}getIdOrCreateNewOne(){let e=this.getId();return e||(e=_(),this.id=e),e}destroy(){this.id=null,this.name=null,this.image=null,nt(this,et,new Map,"f")}getId(){var e;return null!==(e=this.id)&&void 0!==e?e:null}setId(e){this.id=e.toString()}getName(){return this.name}setName(e){this.name=e}getImage(){var e;return null!==(e=this.image)&&void 0!==e?e:null}setImage(e){this.image=e}setExists(e){nt(this,tt,e,"f")}setWebsocketClient(e){nt(this,Xe,e,"f")}setCustomField(e,t){return this.setCustomFields({[e]:t})}setCustomFields(e){if(Qe(rt(this,et,"f"),e),rt(this,tt,"f"))return this.sendCustomFields()}getCustomFields(){return Ye(rt(this,et,"f"))}setCustomFieldsFromArray(e){Ke(rt(this,et,"f"),e)}getCustomFieldsArray(){return qe(rt(this,et,"f"))}async sendCustomFields(){var e;return ht((e=qe(rt(this,et,"f")),{eventType:c.ow.SEND_CONSUMER_CUSTOM_FIELDS,data:{customFields:e}}),rt(this,Xe,"f"))}}Xe=new WeakMap,et=new WeakMap,tt=new WeakMap;class it{static getInstance(){return it.instance||(it.instance=new st),it.instance}}function at(e,t){const n=it.getInstance(),r=null!=e?e:n.getName(),o=null!=t?t:n.getImage();let s={};if("string"==typeof r&&r.length>0){const[e,t]=Be(r);s={firstName:e,lastName:t}}return o&&(s.image=o),Object.assign({idOnExternalPlatform:n.getIdOrCreateNewOne()},s)}const ct=function(e){return null==e};function ut(){const e=l.BRAND_ID,t=l.CHANNEL_ID;if(ct(e)||isNaN(e)||ct(t))throw new E(`Cannot get BrandId and ChannelId from SDKVariableStorage\n      brandId (${e}) |\n      channelId (${t})`);return{brandId:e,channelId:t}}function lt(e){const t=l.DESTINATION,n=l.VISIT_ID,r=l.VISITOR_ID,{eventType:o,data:s,consumerIdentity:i=at(),destination:a=(t?{id:t}:{}),visitor:c=(r?{id:r}:{}),visit:u=(n?{id:n}:{})}=e,{brandId:d,channelId:h}=ut();if(ze(o))throw new E(`Cannot create an event payload because of missing eventType (${o})`);return{eventType:o,brand:{id:Number(d)},channel:{id:h},consumerIdentity:i,data:s,destination:a,visitor:c,visit:u}}function dt(e,t=_(),n=a.V.CHAT_WINDOW_EVENT){return{action:n,eventId:t,payload:e}}async function ht(e,t){!function(){if(xe+=1,null===Le&&(Le=setInterval(Fe,1e3*Ge)),xe>je)throw new E(new He)}();const n=dt(lt(e));return Ue(n,t)}function Et(e,t){return Object.assign(Object.assign(Object.assign({},p(t)),at()),{eventType:c.ow.RECONNECT_CONSUMER,data:{accessToken:{token:e.token}}})}let ft=null;function vt(e,t){null!==ft&&clearTimeout(ft),ft=setTimeout(t,1e3*function(e){const t=Math.round(.9*e);return t<20?20:t}(e.expiresIn))}async function _t(e,t,n){const r=await ht(function(e,t){return{eventType:c.ow.GENERATE_AUTHORIZATION_TOKEN,data:{thread:{idOnExternalPlatform:e},url:t}}}(e,t),n);if(o=null==r?void 0:r.data,!U(o)||!("authorizationToken"in o))throw new E("Invalid response from generate authorization token (generateAuthorizationToken)",{result:r});var o;const{authorizationToken:s}=r.data;return s}const pt=e=>{var t;const n=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.status;return(null==e?void 0:e.type)===c.vc.CONSUMER_AUTHORIZED&&"success"===n};function Tt(e){var t,n;return(null==e?void 0:e.type)===c.vc.TOKEN_REFRESHED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.accessToken)||void 0===n?void 0:n.token)}var mt=r(198),gt=r.n(mt),yt=r(442);const At=()=>navigator.language,wt=()=>Intl.DateTimeFormat().resolvedOptions().timeZone;function Ct(e){switch(e){case"mobile":return yt.bq.MOBILE;case"tablet":return yt.bq.TABLET;default:return yt.bq.DESKTOP}}const St=(e={})=>{var t,n,r,o;const s=new(gt())(navigator.userAgent),{country:i="",location:a=wt(),language:c=At(),ip:u=null}=e;return{browser:null!==(t=s.getBrowser().name)&&void 0!==t?t:null,browserVersion:null!==(n=s.getBrowser().version)&&void 0!==n?n:null,country:i,ip:u,language:c,location:a,os:null!==(r=s.getOS().name)&&void 0!==r?r:null,osVersion:null!==(o=s.getOS().version)&&void 0!==o?o:null,deviceType:Ct(s.getDevice().type),applicationType:yt.Xr.BROWSER}},Ot=e=>{const t=e.replace(/_/g,"-").split(/[^a-z0-9-]/i)[0];try{return"function"==typeof Intl.getCanonicalLocales?Intl.getCanonicalLocales(t)[0]:new Intl.Locale(t).baseName}catch(e){return"en-US"}};var bt=r(796);const It=(e,t)=>{var n,r;const o=null!=e?e:{};return Object.assign(Object.assign({},o),{Accept:"application/json","Content-Type":"application/json",[bt.Um]:null!==(n=null!=t?t:l.APP_NAME)&&void 0!==n?n:"","X-Trace-ID":null!==(r=o["x-trace-id"])&&void 0!==r?r:_(),"x-sdk-platform":"web","x-sdk-version":v})};class Nt extends E{constructor(e="Aborted"){super(e),this.name="AbortError"}}const Rt="SdkVersionNotSupported";class Dt extends Error{constructor(){super(...arguments),this.name=Rt,this.message="Please update to the latest ChatSDK version"}}function Pt(e){var t;return(null===(t=null==e?void 0:e.error)||void 0===t?void 0:t.errorCode)===Rt}function kt(e){if(Pt(e))throw new Dt;return e}function Mt(){const e=null===navigator||void 0===navigator?void 0:navigator.connection;if(e)return{type:(null==e?void 0:e.type)||"unknown",effectiveType:(null==e?void 0:e.effectiveType)||"unknown",downlink:(null==e?void 0:e.downlink)||0,rtt:(null==e?void 0:e.rtt)||0,online:navigator.onLine}}let Ut=!1;function jt(){return Ut}function Gt(){Ut=!0,window.removeEventListener("beforeunload",Gt)}const xt=()=>{Ut||window.addEventListener("beforeunload",Gt)};var Lt,Ht=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};async function Ft(e,t,n){return(await async function(e,t,n){const r=t||{},{signal:o,headers:s}=r,i=Ht(r,["signal","headers"]),a=new AbortController,c=()=>{a.abort(new Nt("Fetch aborted by signal"))};o&&o.addEventListener("abort",c,{once:!0});const u=Object.assign({headers:Object.assign({},It(s,n)),signal:a.signal},i);if(jt())throw new Nt("Fetch aborted because the window is closing");const l=()=>{a.abort(new Nt("Fetch aborted because the window is closing"))};null===window||void 0===window||window.addEventListener("beforeunload",(()=>l));const d=Date.now();try{const t=await fetch(e,u);if(t.ok)return t;const n=await async function(e){let t,n;try{n=await e.text(),t=JSON.parse(n)}catch(e){t=n}return t||(t=e.statusText),t}(t);if(Pt(n))throw new Dt;throw new E(`Request failed with status ${t.status}`,{requestDuration:Date.now()-d,requestUrl:e,requestOptions:u,responseStatus:t.status,responseStatusText:t.statusText,networkInfo:Mt(),errorResponseData:n})}catch(t){if(a.signal.aborted||jt())throw new Nt("Fetch aborted");if(t instanceof E)throw t;throw new E(t,{requestDuration:Date.now()-d,requestUrl:e,requestOptions:u,networkInfo:Mt()})}finally{null===window||void 0===window||window.removeEventListener("beforeunload",l),null==o||o.removeEventListener("abort",c)}}(e,t,n)).json()}async function Bt(e,t,n){return Ft(e,Object.assign({method:"GET"},t),n)}async function Vt(e,t,n,r){return Ft(e,Object.assign({method:"POST",body:JSON.stringify(null!=t?t:{})},n),r)}async function Wt(e,t,n,r={},o){const s=`${n}/chat/1.0/brand/${e}/channel/${t}/availability`,i={headers:Object.assign({},It(r,o))};try{return Bt(s,i,o)}catch(e){throw new E("Failed to fetch channel availability.",{error:e})}}async function $t(e,t,n=At(),r,o={},s){const i=`${r}/chat/1.0/brand/${e}/channel/${t}?locale=${`${n}`.split("-").join("_")}`,a={headers:Object.assign({},It(o,s))};try{return Bt(i,a,s)}catch(e){throw new E("Failed to fetch channel info.",{error:e})}}!function(e){e.ANONYMOUS="anonymous",e.SECURED_COOKIES="securedCookies",e.THIRD_PARTY="thirdParty"}(Lt||(Lt={}));const zt=()=>{var e;return null!==(e=l.SECURED_SESSION)&&void 0!==e?e:null},Qt=()=>l.SECURED_SESSION===Lt.ANONYMOUS,Kt=()=>null!==zt();var Yt;!function(e){e.AE1="AE1",e.AU1="AU1",e.AU2="AU2",e.CA1="CA1",e.EU1="EU1",e.EU2="EU2",e.JO1="JO1",e.JP1="JP1",e.KR1="KR1",e.NA1="NA1",e.NA2="NA2",e.UK1="UK1",e.UK2="UK2",e.ZA1="ZA1",e.custom="custom"}(Yt||(Yt={}));const qt={[Yt.AE1]:"nicecxone.com",[Yt.AU1]:"niceincontact.com",[Yt.AU2]:"nicecxone-sov1.au",[Yt.CA1]:"niceincontact.com",[Yt.EU1]:"niceincontact.com",[Yt.EU2]:"nicecxone-sov1.eu",[Yt.JO1]:"nicecxone.com",[Yt.JP1]:"niceincontact.com",[Yt.KR1]:"nicecxone.com",[Yt.NA1]:"niceincontact.com",[Yt.NA2]:"nicecxone-gov.com",[Yt.UK1]:"niceincontact.com",[Yt.UK2]:"nicecxone-sov1.uk",[Yt.ZA1]:"nicecxone.com",[Yt.custom]:""};function Jt(e){if(!(e in Yt))throw new E(`Unknown environment: ${e}`);if(e===Yt.custom)throw new E("The custom environment cannot be constructed using the built-in configuration");const t=qt[e];return{chat:`https://channels-de-${e}.${t}`.toLowerCase(),name:e,gateway:`wss://chat-gateway-de-${e}.${t}`.toLowerCase(),authorize:`https://digital-oauth-de-${e}.${t}`.toLowerCase()}}const Zt=e=>{Xt(e.gateway,"gateway"),Xt(e.chat,"chat"),Xt(e.authorize,"authorize"),l.ENDPOINT_GATEWAY=e.gateway,l.ENDPOINT_CHAT=e.chat,l.ENDPOINT_AUTHORIZE=e.authorize},Xt=(e,t)=>{if(!(e=>{try{new URL(e)}catch(e){return!1}return!0})(e))throw new Error(`Invalid ${t} endpoint: ${e}. Must be a valid URL.`)};class en extends Error{constructor(){super(...arguments),this.name="ipAddressBlocked"}}var tn=r(0);const nn=Object.assign(Object.assign(Object.assign({},tn.m),c.vc),{AGENT_TYPING_STARTED:"AgentTypingStarted",AGENT_TYPING_ENDED:"AgentTypingEnded",ASSIGNED_AGENT_CHANGED:"AssignedAgentChanged",CONTACT_CREATED:"ContactCreated",CONTACT_STATUS_CHANGED:"ContactStatusChanged",CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED:"ContactToRoutingQueueAssignmentChanged"});class rn extends CustomEvent{}class on{constructor(){this.middlewares=[]}register(e){this.middlewares.push(e)}process(e){if(ct(e))return null;let t=e;for(const e of this.middlewares){if(null===t)return null;t=e(t)}return t}}const sn=EventTarget;function an(e){return"outbound"===(null==e?void 0:e.direction)}var cn=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n};const un={id:"",data:null,type:void 0,createdAt:(new Date).toISOString()};function ln(e){if(!(e=>"eventId"in e)(e))return un;if((e=>"error"in e)(e))return{createdAt:e.createdAt,data:null,error:e.error,id:e.eventId};const t=(e=>"eventType"in e)(e)?e.eventType:void 0;if((e=>"data"in e)(e))return{createdAt:e.createdAt,context:e.context,data:e.data,id:e.eventId,type:t};if((e=>{const t=null==e?void 0:e.postback;return!1===ke(t)})(e)){const{postback:{data:t,eventType:n},eventId:r}=e,o=cn(e,["postback","eventId"]);return{type:n,data:Object.assign(Object.assign({},o),t),createdAt:e.createdAt,id:r}}const{eventId:n}=e,r=cn(e,["eventId"]);return Object.assign(Object.assign({data:void 0},r),{id:n,type:t,createdAt:e.createdAt})}const dn={[nn.SENDER_TYPING_STARTED]:function(e){return an(e.data)?Object.assign(Object.assign({},e),{type:nn.AGENT_TYPING_STARTED}):e},[nn.SENDER_TYPING_ENDED]:function(e){return an(e.data)?Object.assign(Object.assign({},e),{type:nn.AGENT_TYPING_ENDED}):e},[nn.CASE_INBOX_ASSIGNEE_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:nn.ASSIGNED_AGENT_CHANGED})},[nn.CASE_CREATED]:function(e){return Object.assign(Object.assign({},e),{type:nn.CONTACT_CREATED})},[nn.CASE_STATUS_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:nn.CONTACT_STATUS_CHANGED})},[nn.CASE_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED]:function(e){return Object.assign(Object.assign({},e),{type:nn.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED})},[nn.LIVECHAT_RECOVERED]:function(e){const t=e.data.contactHistory.map(ln).map(hn).filter((e=>Boolean(e)));return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})},[nn.THREAD_RECOVERED]:function(e){const t=e.data.contactHistory.map(ln).map(hn).filter((e=>Boolean(e)));return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{contactHistory:t})})}};function hn(e){return e.type&&void 0!==dn[e.type]?dn[e.type](e):e}function En(e){if("function"!=typeof e)throw Error(`Expected a callable function, got ${e}`)}const fn=e=>{var t,n;const r=e.onError,o=((e,t)=>e?Object.entries(e).reduce(((e,n)=>((e,[t,n],r)=>{if("string"!=typeof t&&"number"!=typeof t||"string"!=typeof n&&"number"!=typeof n)return null==r||r(new E(`Invalid HTTP header: key "${t}" and value "${n}" must be strings or numbers.`)),e;const o=String(t);if(""===o.trim())return null==r||r(new E(`Invalid HTTP header: key "${o}" must not be an empty string.`)),e;const s=new Headers;try{s.append(o,String(n))}catch(t){return null==r||r(new E(`Invalid HTTP header: key "${o}" and value "${n}" cannot be added to Headers.`)),e}return e[o]=String(n),e})(e,n,t)),{}):{})(null===(t=e.networkRequestMetadata)||void 0===t?void 0:t.httpHeaders,r),s=((e,t)=>e?Object.entries(e).reduce(((e,n)=>((e,[t,n],r)=>{if("string"!=typeof t&&"number"!=typeof t||"string"!=typeof n&&"number"!=typeof n)return null==r||r(new E(`Invalid WebSocket query parameter: key "${t}" and value "${n}" must be strings or numbers.`)),e;const o=String(t);if(""===o.trim())return null==r||r(new E(`Invalid WebSocket query parameter: key "${o}" must not be an empty string.`)),e;const s=new URLSearchParams;try{s.append(o,String(n)),s.toString()}catch(t){return null==r||r(new E(`Invalid WebSocket query parameter: key "${o}" and value "${n}" must not be empty strings.`)),e}return e[o]=String(n),e})(e,n,t)),{}):{})(null===(n=e.networkRequestMetadata)||void 0===n?void 0:n.websocketQuery,r);return{httpHeaders:o,websocketQuery:s}};function vn(e){const t=!1===ze(null==e?void 0:e.id);return!1==(!1===ze(e.error))&&t}class _n extends E{constructor(e,t){super(e),this.data=t}}var pn=r(434);var Tn=r(953);const mn=e=>{var t,n,r,o,s,i;return e.direction===Tn.T.INBOUND?null!==(n=null===(t=e.authorEndUserIdentity)||void 0===t?void 0:t.fullName)&&void 0!==n?n:"":`${null!==(o=null===(r=e.authorUser)||void 0===r?void 0:r.firstName)&&void 0!==o?o:""} ${null!==(i=null===(s=e.authorUser)||void 0===s?void 0:s.surname)&&void 0!==i?i:""}`.trim()};function gn(e){const t=!1===ze(e.id),n=!1===ze(e.direction),r=!1===ze(e.messageContent);return t&&n&&r}function yn(e){return e.type===tn.m.MESSAGE_CREATED}function An(e){return e.type===tn.m.MESSAGE_SENT}function wn(e){return e.type===tn.m.MESSAGE_READ_CHANGED}function Cn(e,t){return`/chat/1.0/brand/${e}/messages/${t}`}function Sn(e){return e.type===tn.m.EVENT_IN_S3}const On="TTR";function bn(e){var t,n;if(!l.ENDPOINT_AUTHORIZE)throw new E("Authorize hostname is not set");const r=new URL(l.ENDPOINT_AUTHORIZE);return r.pathname="/oauth/token",r.searchParams.append("brandId",String(l.BRAND_ID)),r.searchParams.append("channelId",null!==(t=l.CHANNEL_ID)&&void 0!==t?t:""),r.searchParams.append("visitorId",null!==(n=l.VISITOR_ID)&&void 0!==n?n:""),e&&r.searchParams.append("storageFallback","1"),r.toString()}const In="cx_digital_wi";function Nn(){return l.IDENTITY_TOKEN?l.IDENTITY_TOKEN:l.STORAGE?l.STORAGE.getItem(In):null}function Rn(){var e;return null!==(e=l.THIRD_PARTY_TOKEN)&&void 0!==e?e:null}async function Dn(){var e;const t=Rn();if(u(t))throw new E(Ve);const n=bn(!1);try{const{thirdParty:r}=await Vt(n,{thirdParty:{grant_type:"refresh_token",refresh_token:t.refresh_token}},{credentials:"include",headers:Object.assign({},null===(e=l.REQUEST_METADATA)||void 0===e?void 0:e.httpHeaders)});if(!r)throw new E(Ve);return Pn(r)}catch(e){if(e instanceof E)throw e;throw new E(Ve,{error:e})}}function Pn(e){!function(e){l.THIRD_PARTY_TOKEN=e}(e),vt({expiresIn:e.expires_in},Dn)}class kn extends Error{constructor(e,t=""){super(`[WebSocketClientError]: ${e}${t?` (${t})`:""}`),this.name="WebSocketClientError"}}const Mn=EventTarget;var Un,jn,Gn,xn,Ln,Hn,Fn=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},Bn=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Vn{constructor(e,t){this.onError=e,this.socketURLGetter=t,Un.add(this),jn.set(this,null),Gn.set(this,void 0),xn.set(this,!1),Hn.set(this,(e=>{Bn(this,Gn,"f").dispatchEvent(e)})),Fn(this,Gn,new Mn,"f")}async connect(){var e,t;Bn(this,Un,"m",Ln).call(this),null===(t=null===(e=Bn(this,jn,"f"))||void 0===e?void 0:e.socket)||void 0===t||t.reconnect()}disconnect(){var e;null===(e=Bn(this,jn,"f"))||void 0===e||e.socket.close()}reconnect(){var e;Bn(this,Un,"m",Ln).call(this),null===(e=Bn(this,jn,"f"))||void 0===e||e.socket.reconnect()}send(e){var t;const n=JSON.stringify(e);null===(t=Bn(this,jn,"f"))||void 0===t||t.send(n)}on(e,t){Bn(this,Gn,"f").addEventListener(e,t)}off(e,t){Bn(this,Gn,"f").removeEventListener(e,t)}_errorHandler(e){const t=e.detail;let n;if(t instanceof ErrorEvent&&(n=new kn("Connection error",t.message)),t instanceof CloseEvent&&(n=new kn("Connection closed",t.reason)),void 0===n&&(n=new kn("Unknown error",t.type)),"function"!=typeof this.onError)throw n;this.onError(n)}}jn=new WeakMap,Gn=new WeakMap,xn=new WeakMap,Hn=new WeakMap,Un=new WeakSet,Ln=function(){var e,t,n,r,o,s;const a=!Kt(),c=(null!==(e=l.ENDPOINT_GATEWAY)&&void 0!==e?e:"").startsWith("wss");Fn(this,jn,(0,i.NP)(this.socketURLGetter,{forceSecureProtocol:c,startClosed:!0,heartbeatAfterAuthorize:a,maxRetries:0}),"f");const u=this._errorHandler.bind(this);null===(t=Bn(this,jn,"f"))||void 0===t||t.addEventListener(i.nF.CLOSE,u),null===(n=Bn(this,jn,"f"))||void 0===n||n.addEventListener(i.nF.ERROR,u),null===(r=Bn(this,jn,"f"))||void 0===r||r.addEventListener(i.nF.OPEN,(e=>{var t;null===(t=Bn(this,jn,"f"))||void 0===t||t.socket.setMaxRetires(20),Fn(this,xn,!0,"f"),Bn(this,Hn,"f").call(this,e)})),null===(o=Bn(this,jn,"f"))||void 0===o||o.addEventListener(i.nF.CLOSE,(e=>{Bn(this,xn,"f")||Bn(this,Gn,"f").dispatchEvent(new CustomEvent(i.nF.AUTHORIZATION_FAILED)),Bn(this,Hn,"f").call(this,e)})),null===(s=Bn(this,jn,"f"))||void 0===s||s.addEventListener(i.nF.MESSAGE,Bn(this,Hn,"f"))};var Wn=r(168);class $n extends E{constructor(e,t){super(e),this.data=t}}const zn=async(e,t,n,r)=>{const o=await(async e=>{const t=await function(e){return new Promise(((t,n)=>{const r=new FileReader;r.onloadend=()=>{t(r)},r.onerror=e=>{var t,r;return n(null===(r=null===(t=e.target)||void 0===t?void 0:t.error)||void 0===r?void 0:r.message)},r.readAsDataURL(e)}))}(e);if(null!==t.error)throw new E(`Cannot create payload for attachment upload because of error (${t.error.message})`);if("string"!=typeof t.result)throw new E(`Cannot create payload for attachment upload because of missing:\n      reader result (${t.result})`);return{url:t.result,name:e.name,mimeType:e.type}})(e),s=await async function(e,t,n,r){var o;const{url:s,name:i,mimeType:a}=n,c={content:s.split(";base64,")[1],fileName:i,mimeType:a},u=Object.assign({},null===(o=l.REQUEST_METADATA)||void 0===o?void 0:o.httpHeaders);return Vt(`${l.ENDPOINT_CHAT}/chat/1.0/brand/${e}/channel/${t}/attachment`,c,{headers:Object.assign({},It(u,l.APP_NAME)),signal:r})}(t,n,o,r);if(!1===ze(null==(i=s)?void 0:i.fileUrl))return{url:s.fileUrl,friendlyName:o.name};var i;if(function(e){return!1===ze(null==e?void 0:e.allowedFileSize)}(s))throw new $n("Upload attachment failed",{response:s});throw new E(`Unknown file upload response (${s})`)},Qn=e=>Array.from(e).every((e=>"url"in e&&"friendlyName"in e)),Kn=async(e,t,n,r)=>Promise.all(Array.from(e).map((e=>zn(e,t,n,r)))),Yn=async(e,t,n={})=>{const{brandId:r,channelId:o}=ut();try{const s=Qn(e)?e:await Kn(e,r,o),{messageId:i=_(),browserFingerprint:a=St()}=n;return{messageContent:{type:pn.G.TEXT,payload:{text:""}},attachments:s,browserFingerprint:a,thread:{idOnExternalPlatform:t},idOnExternalPlatform:i,consumer:{customFields:[]},consumerContact:{customFields:[]}}}catch(e){if(e instanceof $n)throw e;if(e instanceof Error)throw new E(`Send attachment failed because of (${e.message})`);throw new E("Unknown error during file upload")}};function qn(e){var t,n;return e.type===nn.CONTACT_STATUS_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Jn(e){var t,n;return e.type===nn.CONTACT_CREATED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Zn(e){var t,n;return e.type===nn.CONTACT_TO_ROUTING_QUEUE_ASSIGNMENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Xn(e){return e.type===tn.m.CONTACT_RECIPIENTS_CHANGED}const er=(e,t,n,r=St())=>({messageContent:e,browserFingerprint:r,idOnExternalPlatform:t,thread:{idOnExternalPlatform:n},consumer:{customFields:[]},consumerContact:{customFields:[]},attachments:[]});function tr(e){var t;return e.type===c.vc.MORE_MESSAGES_LOADED&&void 0!==(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.messages)}const nr=e=>({eventType:c.ow.LOAD_MORE_MESSAGES,data:e});class rr extends Promise{constructor(e){const t=new AbortController,n=t.signal;super(((t,r)=>{n.addEventListener("abort",(()=>{r(new Nt(this.abortReason))})),null==e||e(t,r,n)})),this.abort=e=>{this._abortReason=null!=e?e:"Aborted",t.abort()}}get abortReason(){return this._abortReason}}rr.from=e=>e instanceof rr?e:new rr(((t,n)=>{e.then(t).catch(n)}));class or extends E{constructor(e,t){super(e),this.data=t}}class sr extends E{constructor(e,t){super(e),this.data=t}}const ir=e=>e.type===c.vc.THREAD_METADATA_LOADED&&void 0!==e.data.lastMessage,ar=e=>{const t=e.data;return!1!=(!1===ct(t))&&(!1!=(!1===ct(null==t?void 0:t.messages))&&(!1!=(e.type===c.vc.THREAD_RECOVERED||e.type===c.vc.LIVECHAT_RECOVERED)&&(!1!==ct(e.error)&&!1!=(!1===ct(null==t?void 0:t.thread)))))};function cr(e){return e.type===c.vc.THREAD_ARCHIVED}class ur extends E{constructor(e,t){super(e),this.data=t}}function lr(e){const t={eventType:c.ow.RECOVER_THREAD,data:{}};return e?Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}}):t}class dr extends E{constructor(e,t){super(e),this.data=t}}class hr extends E{constructor(e,t){super(e),this.data=t}}class Er{constructor(e,t,n,r,o={},s=!1){this._existsOnPlatform=!1,this._typingTimeoutID=void 0,this._isAuthorizationEnabled=!1,this._customFields=new Map,this._typingPreviewText="",this.idOnExternalPlatform=e,this._websocketClient=t,this._messageEmitter=n,this._customer=r,this._isAuthorizationEnabled=s,this._existsOnPlatform=!1,Qe(this._customFields,o),this._registerEventHandlers()}recover(){return new rr((async(e,t)=>{const n=await ht(lr(this.idOnExternalPlatform),this._websocketClient);ar(n)?e(n.data):t(new hr("Thread not found",{response:n}))}))}async sendMessage(e){!function(e){if(e.messageContent.type===pn.G.TEXT&&!(e.attachments.length>0)&&!1!==ke(e.messageContent.payload.text))throw new _n("Message content cannot be empty for text message")}(e);return(async(e,t)=>{const n=(r=e,{eventType:c.ow.SEND_MESSAGE,data:r});var r;const o=await ht(n,t);if(vn(o))return o;throw new _n("Send message failed",{response:o})})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!1),this._websocketClient)}async sendTextMessage(e,t={}){const{messageId:n=_(),browserFingerprint:r=St()}=t,o=function(e){return{payload:{text:e},type:pn.G.TEXT}}(e),s=er(o,n,this.idOnExternalPlatform,r);return this.sendMessage(s)}async sendPostbackMessage(e,t,n={}){const{messageId:r=_(),browserFingerprint:o=St()}=n,s=function(e,t){return{payload:{text:t,postback:e},postback:e,type:pn.G.TEXT}}(e,t),i=er(s,r,this.idOnExternalPlatform,o);return this.sendMessage(i)}async sendOutboundMessage(e){return(async(e,t)=>{const n=(r=e,{eventType:c.ow.SEND_OUTBOUND,data:r});var r;const o=await ht(n,t);if(vn(o))return o;throw new _n("Send Outbound message failed",o)})(this._mergeCustomFieldsAndAccessTokenWithMessageData(e,!0),this._websocketClient)}async loadMoreMessages(){var e;const{scrollToken:t,oldestMessageDatetime:n}=null!==(e=l.THREAD_DATA)&&void 0!==e?e:{};if(ke(t))return null;const r={scrollToken:String(t),oldestMessageDatetime:n,thread:{idOnExternalPlatform:this.idOnExternalPlatform}},o=await ht(nr(r),this._websocketClient);if(tr(o))return o;throw new ur("Load more messages failed",{response:o})}async lastMessageSeen(){var e;return ht((e=this.idOnExternalPlatform,{eventType:c.ow.MESSAGE_SEEN,data:{thread:{idOnExternalPlatform:e}}}),this._websocketClient)}async sendAttachments(e,t={}){if(ze(e)||0===e.length)throw new E("FileList must be provided to sendAttachment method");const n=await Yn(e,this.idOnExternalPlatform,t);return this.sendMessage(n)}keystroke(e=1e3,t){var n;this._existsOnPlatform&&(this._typingTimeoutID||ht((n=this.idOnExternalPlatform,{eventType:c.ow.SENDER_TYPING_STARTED,data:{thread:{idOnExternalPlatform:n}}}),this._websocketClient),clearTimeout(this._typingTimeoutID),this._typingTimeoutID=setTimeout((()=>{this._stopTypingCallback(t)}),e))}stopTyping(){this._stopTypingCallback()}_stopTypingCallback(e){var t;this._typingTimeoutID&&(clearTimeout(this._typingTimeoutID),this._typingTimeoutID=void 0,ht((t=this.idOnExternalPlatform,{eventType:c.ow.SENDER_TYPING_ENDED,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient),"function"==typeof e&&e())}keystrokeForPreview(e,t=1250){this._typingPreviewText=e,this._typingForPreviewTimeoutID||(this._typingForPreviewTimeoutID=setTimeout((()=>{this.stopTypingForPreview()}),t))}stopTypingForPreview(e=!0){clearTimeout(this._typingForPreviewTimeoutID),this._typingForPreviewTimeoutID=void 0;const t=this._typingPreviewText;this._typingPreviewText="",!1!==e&&this.sendMessagePreview(t)}async getMetadata(){const e=await ht((t=this.idOnExternalPlatform,{eventType:c.ow.LOAD_THREAD_METADATA,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(ir(e))return e;throw new sr("Get metadata failed",{response:e})}onThreadEvent(e,t){const n=((e,t)=>n=>{const r=(e=>{var t,n,r,o,s,i,a;const c=e;return null!==(i=null!==(o=null!==(n=null===(t=null==c?void 0:c.thread)||void 0===t?void 0:t.idOnExternalPlatform)&&void 0!==n?n:null===(r=null==c?void 0:c.case)||void 0===r?void 0:r.threadIdOnExternalPlatform)&&void 0!==o?o:null===(s=null==c?void 0:c.message)||void 0===s?void 0:s.threadIdOnExternalPlatform)&&void 0!==i?i:null===(a=null==c?void 0:c.messagePreview)||void 0===a?void 0:a.threadIdOnExternalPlatform})(n.detail.data);r===e&&t(n)})(this.idOnExternalPlatform,t);return this._messageEmitter.addEventListener(e,n),()=>{this._messageEmitter.removeEventListener(e,n)}}async sendCustomFields(e){var t,n;return ht((t=qe(this._customFields).filter((t=>!e||e.includes(t.ident))),n=this.idOnExternalPlatform,{eventType:c.ow.SET_CONSUMER_CONTACT_CUSTOM_FIELD,data:{customFields:t,thread:{idOnExternalPlatform:n}}}),this._websocketClient)}async setCustomFields(e){Qe(this._customFields,e),this._existsOnPlatform&&await this.sendCustomFields(Object.keys(e))}removeCustomField(e){!function(e,t){e.delete(t)}(this._customFields,e)}setCustomField(e,t){return this.setCustomFields({[e]:t})}async archive(){const e=await ht((t=this.idOnExternalPlatform,{eventType:c.ow.ARCHIVE_THREAD,data:{thread:{idOnExternalPlatform:t}}}),this._websocketClient);var t;if(cr(e))return!0;throw new or("Archive Thread failed",{response:e})}async setName(e){const t=(n=this.idOnExternalPlatform,r=e,{eventType:c.ow.UPDATE_THREAD,data:{thread:{idOnExternalPlatform:n,threadName:r}}});var n,r;const o=await ht(t,this._websocketClient);if(function(e){return ze(e.error)}(o))return!0;throw new dr("Set Thread name failed",{response:o})}async sendMessagePreview(e){const t=((e,t)=>({eventType:c.ow.SEND_MESSAGE_PREVIEW,data:{thread:{idOnExternalPlatform:e},messageContent:{payload:{text:t},type:pn.G.TEXT}}}))(this.idOnExternalPlatform,e);this._existsOnPlatform&&await ht(t,this._websocketClient)}async sendTranscript(e,t){const n=((e,t)=>({eventType:c.ow.SEND_TRANSCRIPT,data:{consumerContact:{id:e},consumerRecipients:[{idOnExternalPlatform:t}]}}))(e,t);return ht(n,this._websocketClient)}_setExistsOnPlatform(e){this._existsOnPlatform=e}_setExistsOnPlatformBasedOnContactStatus(e){const t=e.detail;ar(t)&&this._setExistsOnPlatform(t.data.contact.status!==Wn.P.CLOSED)}_setCustomerExists(){var e;null===(e=this._customer)||void 0===e||e.setExists(!0)}_clearCustomFieldsOnContactStatusChangedToClosed(e){const t=e.detail;qn(t)&&t.data.case.status===Wn.P.CLOSED&&(this._customFields.clear(),this._setExistsOnPlatform(!1))}_mergeCustomFieldsWithMessageData(e,t){var n,r,o,s,i;if(this._existsOnPlatform)return Object.assign(Object.assign({},e),{consumer:{customFields:[]},consumerContact:{customFields:[]}});Ke(this._customFields,e.consumerContact.customFields);const a={customFields:qe(this._customFields)};let c;return t||(null===(n=this._customer)||void 0===n||n.setCustomFieldsFromArray(null!==(o=null===(r=e.consumer)||void 0===r?void 0:r.customFields)&&void 0!==o?o:[]),c={customFields:null!==(i=null===(s=this._customer)||void 0===s?void 0:s.getCustomFieldsArray())&&void 0!==i?i:[]}),Object.assign(Object.assign({},e),{consumer:c,consumerContact:a})}_mergeAccessTokenWithMessageData(e){var t;let n;const r=Rn(),o=h();return this._isAuthorizationEnabled&&(r||o)&&(n={token:null!==(t=null==r?void 0:r.access_token)&&void 0!==t?t:null==o?void 0:o.token}),Object.assign(Object.assign({},e),{accessToken:n})}_mergeCustomFieldsAndAccessTokenWithMessageData(e,t){const n=this._mergeCustomFieldsWithMessageData(e,t);return this._mergeAccessTokenWithMessageData(n)}_registerEventHandlers(){this.onThreadEvent(nn.CASE_CREATED,(()=>{this._setCustomerExists(),this._setExistsOnPlatform(!0)})),this.onThreadEvent(nn.CONTACT_CREATED,(()=>{this._setCustomerExists(),this._setExistsOnPlatform(!0)})),this.onThreadEvent(nn.THREAD_RECOVERED,(e=>{this._setExistsOnPlatformBasedOnContactStatus(e),this._setCustomerExists()})),this.onThreadEvent(nn.CONTACT_STATUS_CHANGED,(e=>this._clearCustomFieldsOnContactStatusChangedToClosed(e)))}}function fr(e){const t={eventType:c.ow.RECOVER_LIVECHAT,data:{}};return e?Object.assign(Object.assign({},t),{data:{thread:{idOnExternalPlatform:e}}}):t}class vr extends Er{constructor(e,t,n,r,o={},s=!1){super(e,t,n,r,o,s),this._isInitialized=!1,this._canSendMessage=!0,this._registerLivechatEventHandlers()}recover(){return new rr((async(e,t)=>{const n=await ht(fr(this.idOnExternalPlatform),this._websocketClient);ar(n)?e(n.data):t(new hr("Thread not found",{response:n}))}))}async sendMessage(e){if(!1===this._canSendMessage)throw new E("Cannot send more messages to Contact");return super.sendMessage(e)}async startChat(e="Begin conversation"){if(this._isInitialized)throw new E("Chat is already initialized");try{const t=await this.sendTextMessage(e);return this._isInitialized=!0,t}catch(e){if(e instanceof Error)throw new E(`Sending initial message failed because of (${e.message})`);return}}async endChat(){var e;const t=null!==(e=l.THREAD_DATA)&&void 0!==e?e:{},n=null==t?void 0:t.contactId;if(ze(n))throw new E("Cannot end Chat because of missing ContactId in the storage");await ht(function(e,t){return{eventType:c.ow.END_CONTACT,data:{thread:{idOnExternalPlatform:e},contact:{id:t}}}}(this.idOnExternalPlatform,n),this._websocketClient)}async loadMoreMessages(){var e;const{scrollToken:t,oldestMessageDatetime:n,contactId:r}=null!==(e=l.THREAD_DATA)&&void 0!==e?e:{};if(ke(t)||ke(r))return null;const o={scrollToken:String(t),oldestMessageDatetime:n,thread:{idOnExternalPlatform:this.idOnExternalPlatform},contact:{id:r}},s=await ht(nr(o),this._websocketClient);if(tr(s))return s;throw new ur("Load more messages failed",{response:s})}_registerLivechatEventHandlers(){this.onThreadEvent(nn.LIVECHAT_RECOVERED,(e=>{ar(e.detail)&&(this._setCustomerExists(),this._setExistsOnPlatform(!0))}))}}const _r=e=>!u(e)&&"threads"in e;function pr(e){var t;const n=null!==(t=l.THREAD_DATA)&&void 0!==t?t:{};l.THREAD_DATA=Object.assign(Object.assign({},n),{contactId:e})}function Tr(e){return Jn(e)&&pr(e.data.case.id),ar(e)&&pr(e.data.contact.id),e}function mr(e){var t,n;const r=null===(s=e.messages,t=(i=null==s?0:s.length)?s[i-1]:void 0)||void 0===t?void 0:t.createdAt,o=null!==(n=l.THREAD_DATA)&&void 0!==n?n:{};var s,i;l.THREAD_DATA=Object.assign(Object.assign({},o),{scrollToken:e.scrollToken,oldestMessageDatetime:ze(r)?"":r})}function gr(e){if(ar(e)){const{messages:t,messagesScrollToken:n}=e.data;mr({messages:t,scrollToken:n})}if(tr(e)){const{scrollToken:t,messages:n}=e.data;mr({scrollToken:t,messages:n})}return e}var yr,Ar,wr,Cr,Sr,Or,br,Ir,Nr,Rr,Dr,Pr,kr,Mr,Ur,jr,Gr,xr,Lr,Hr=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},Fr=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Br{constructor(e){if(yr.add(this),this.channelId="",Ar.set(this,void 0),wr.set(this,void 0),Cr.set(this,void 0),Sr.set(this,void 0),Or.set(this,void 0),br.set(this,void 0),Ir.set(this,null),Nr.set(this,new Map),Rr.set(this,new Map),Dr.set(this,new on),Pr.set(this,void 0),kr.set(this,function(){let e,t;return{promise:new Promise(((n,r)=>{e=n,t=r})),resolve:e,reject:t}}()),Gr.set(this,(async()=>{const e=h();if(u(e))return;const t=await ht((n=e.token,{eventType:c.ow.REFRESH_TOKEN,data:{accessToken:{token:n}}}),Fr(this,Ir,"f"));var n;if(Tt(t))return d(t.data.accessToken),void vt(t.data.accessToken,Fr(this,Gr,"f"));throw new f("An error occurred while refreshing the access token",t.error)})),void 0===e)throw new E("No options was provided for initialization of ChatSdk");Hr(this,wr,e.customerImage,"f"),Hr(this,Cr,e.customerName,"f"),Hr(this,Sr,e.customerId,"f"),function(e){var t,n,r;l.AUTHORIZATION_CODE=e.authorizationCode,l.BRAND_ID=e.brandId,l.CHANNEL_ID=e.channelId,l.APP_NAME=null!==(t=e.appName)&&void 0!==t?t:"chat-web-sdk",l.APP_VERSION=`${null!==(n=e.appVersion)&&void 0!==n?n:0}`,l.DESTINATION=e.destinationId,l.VISIT_ID=e.visitId,l.VISITOR_ID=e.visitorId,l.LANGUAGE=null!==(r=e.language)&&void 0!==r?r:At(),l.SECURED_SESSION=(e=>{if(ct(e))return null;if(!1===Object.values(Lt).includes(e))throw new E(`Expected a SecureSessions value, got ${e}`);return e})(e.securedSession),l.IDENTITY_TOKEN=e.identityToken,l.REQUEST_METADATA=fn(e),e.storage&&(En(e.storage.getItem),En(e.storage.setItem),En(e.storage.removeItem),l.STORAGE=e.storage),e.cacheStorage&&(En(e.cacheStorage.getItem),En(e.cacheStorage.setItem),En(e.cacheStorage.removeItem),l.CACHE_STORAGE=e.cacheStorage)}(e),Hr(this,Ar,it.getInstance(),"f"),void 0!==e.customerId&&function(e){if(Kt()&&!1===Qt()&&void 0!==e)throw new E("The CustomerId cannot be set when secured sessions are enabled");if(Kt()&&Qt()&&ke(e))throw new E('The CustomerId cannot be empty string when "anonymous" secured sessions are enabled');"string"==typeof e&&it.getInstance().setId(e)}(e.customerId);const{brandId:t,channelId:n}=ut();this.onAuthorization=e.onAuthorization,this.onError=e.onError,this.onRawEvent=e.onRawEvent,Fr(this,Dr,"f").register(hn),Fr(this,Dr,"f").register(kt),Fr(this,Dr,"f").register(gr),Fr(this,Dr,"f").register(Tr),Hr(this,Pr,new sn,"f");try{if(isNaN(t))throw new Error("Missing BrandID");if(void 0===n)throw new Error("Missing ChannelId");if(void 0===e.customerId&&!Kt())throw new Error("Missing CustomerId");this.channelId=n,this.isLivechat=e.isLivechat,Hr(this,br,zt()===Lt.THIRD_PARTY||e.isAuthorizationEnabled,"f"),Hr(this,Or,e.isThirdPartyCookiesSupported,"f"),Fr(this,yr,"m",xr).call(this,e)}catch(e){Fr(this,yr,"m",Mr).call(this,e)}}async connect(e){return e&&(l.AUTHORIZATION_CODE=e),null===Fr(this,Ir,"f")&&(await Fr(this,yr,"m",jr).call(this),Kt()&&await this.ready(),void 0!==Fr(this,Sr,"f")&&Fr(this,Ar,"f").setId(Fr(this,Sr,"f")),void 0!==Fr(this,Cr,"f")&&Fr(this,Ar,"f").setName(Fr(this,Cr,"f")),void 0!==Fr(this,wr,"f")&&Fr(this,Ar,"f").setImage(Fr(this,wr,"f")),null!==Fr(this,Ir,"f")&&Fr(this,Ar,"f").setWebsocketClient(Fr(this,Ir,"f")),Fr(this,kr,"f").resolve(),!0)}async ready(){return Fr(this,kr,"f").promise}async getChannelInfo(){var e,t;return $t(l.BRAND_ID,l.CHANNEL_ID,null!==(e=l.LANGUAGE)&&void 0!==e?e:At(),l.ENDPOINT_CHAT,(null===(t=l.REQUEST_METADATA)||void 0===t?void 0:t.httpHeaders)||{})}async getChannelAvailability(){var e;return Wt(l.BRAND_ID,l.CHANNEL_ID,l.ENDPOINT_CHAT,(null===(e=l.REQUEST_METADATA)||void 0===e?void 0:e.httpHeaders)||{},l.APP_NAME)}async authorize(e,t,n){var r,o,s,i;await this.ready();const u=h();if(null!==u)try{const e=await async function(e,t,n,r){const o=Et(n,r),s=await ht(o,e);if(void 0!==s.error)throw new f("Authorization reconnect failed",s.error);return vt(n,t),{reconnected:!0}}(Fr(this,Ir,"f"),Fr(this,Gr,"f"),u,t);return e}catch(e){}const T=async function(e,t){var n;if(!ze(e)&&!ze(t))return{isAuthorizationEnabled:e,isLivechat:t};const r=await $t(l.BRAND_ID,l.CHANNEL_ID,l.LANGUAGE,l.ENDPOINT_CHAT,null===(n=l.REQUEST_METADATA)||void 0===n?void 0:n.httpHeaders,l.APP_NAME);return{isAuthorizationEnabled:r.isAuthorizationEnabled,isLivechat:r.isLiveChat}}(Fr(this,br,"f"),this.isLivechat),m=function(e,t=_(),n){return Object.assign({eventType:c.ow.AUTHORIZE_CUSTOMER,data:{authorization:{authorizationCode:e},browserFingerprint:n,disableChannelInfo:!0,sdkVersion:v,sdkPlatform:"web"}},p(t))}(null!==(r=null!=e?e:l.AUTHORIZATION_CODE)&&void 0!==r?r:null,t,n),g=dt(lt(m),_(),a.V.REGISTER),y=Ue(g,Fr(this,Ir,"f")),[A,w]=await Promise.all([y,T]);if(!pt(A))throw null===(o=Fr(this,Ir,"f"))||void 0===o||o.disconnect(),new f("Authorization failed",A.error);const{consumerIdentity:C,customer:S,contact:O}=A.data,b=null==C?void 0:C.idOnExternalPlatform;if(ct(I=b)||""===I)throw null===(s=Fr(this,Ir,"f"))||void 0===s||s.disconnect(),new E("Invalid customer identity");var I;return ot(Fr(this,Ar,"f"),C),(null==S?void 0:S.customFields)&&Fr(this,Ar,"f").setCustomFieldsFromArray(S.customFields),(null==O?void 0:O.customFields)&&Ke(Fr(this,Nr,"f"),O.customFields),Hr(this,br,w.isAuthorizationEnabled,"f"),this.isLivechat=w.isLivechat,void 0!==(null===(i=A.data.accessToken)||void 0===i?void 0:i.token)&&(d(A.data.accessToken),vt(A.data.accessToken,Fr(this,Gr,"f"))),A.data}async generateAuthorizationToken(e,t){if(null===Fr(this,Ir,"f"))throw new E("Websocket client is not initialized");return _t(e,t,Fr(this,Ir,"f"))}onChatEvent(e,t){return Fr(this,Pr,"f").addEventListener(e,t),()=>{Fr(this,Pr,"f").removeEventListener(e,t)}}getCustomer(){return Fr(this,Ar,"f")}getThread(e){if(""===e)throw new E("Cannot get thread because id is empty");if(u(Fr(this,Ir,"f")))throw new E("Cannot get thread because websocket is disconnected");if(ct(e))throw new E("Cannot get thread because id is undefined");const t=Fr(this,Rr,"f").get(e);if(!ze(t))return t;if(!0===this.isLivechat){const t=new vr(e,Fr(this,Ir,"f"),Fr(this,Pr,"f"),Fr(this,Ar,"f"),this._getContactCustomFieldsFromQueue(),Fr(this,br,"f"));return Fr(this,Rr,"f").set(e,t),t}const n=new Er(e,Fr(this,Ir,"f"),Fr(this,Pr,"f"),Fr(this,Ar,"f"),this._getContactCustomFieldsFromQueue(),Fr(this,br,"f"));return Fr(this,Rr,"f").set(e,n),n}async getThreadList(){if(u(Fr(this,Ir,"f")))throw new E("Cannot get thread list because websocket is disconnected");const e={eventType:c.ow.FETCH_THREAD_LIST,data:{}},t=await ht(e,Fr(this,Ir,"f"));if(!_r(t.data))throw new E("Invalid response from fetch thread list (getThreadList)");return t.data.threads}getWebsocketClient(){return Fr(this,Ir,"f")}async sendOfflineMessage(e){return(async(e,t)=>{const n=(e=>{const[t,...n]=e.name.split(" ").reverse(),r=n.reverse().join(" "),o={idOnExternalPlatform:e.email,firstName:r,lastName:t},s={messageContent:{type:pn.G.TEXT,payload:{text:e.message}},authorCustomerIdentity:o};return{eventType:c.ow.SEND_OFFLINE_MESSAGE,data:s}})(e),r=await ht(n,t);if(vn(r))return r;throw new _n("Send offline message failed",r)})(e,Fr(this,Ir,"f"))}recoverThreadData(e=void 0){return new rr((async(t,n)=>{const r=lr(e),o=await ht(r,Fr(this,Ir,"f"));ar(o)?(this.getThread(o.data.thread.idOnExternalPlatform),Fr(this,Pr,"f").dispatchEvent(new rn(nn.THREAD_RECOVERED,{detail:o})),t(o)):n(new hr("Thread not found",{response:o}))}))}recoverLivechatThreadData(e=void 0){return new rr((async(t,n)=>{const r=fr(e),o=await ht(r,Fr(this,Ir,"f"));ar(o)?(this.getThread(o.data.thread.idOnExternalPlatform),Fr(this,Pr,"f").dispatchEvent(new rn(nn.LIVECHAT_RECOVERED,{detail:o})),t(o)):n(new hr("Thread not found",{response:o}))}))}async resetSession(e=_(),t="",n="",r="",o=_()){var s;null===(s=Fr(this,Ir,"f"))||void 0===s||s.disconnect(),Hr(this,Ir,null,"f"),Fr(this,Rr,"f").clear(),Fr(this,Nr,"f").clear(),l.ACCESS_TOKEN=void 0,l.ACCESS_TOKEN_EXPIRES_IN=void 0,l.THIRD_PARTY_TOKEN=void 0,l.CACHE_STORAGE&&l.CACHE_STORAGE.removeItem(On),Fr(this,Ar,"f").destroy(),l.VISIT_ID=o,l.VISITOR_ID=r;try{await Fr(this,yr,"m",jr).call(this),Hr(this,Ar,new st(e,t,n,Fr(this,Ir,"f")),"f")}catch(e){Fr(this,yr,"m",Mr).call(this,e)}}_getContactCustomFieldsFromQueue(){if(Fr(this,Nr,"f").size>0){const e=Ye(Fr(this,Nr,"f"));return Fr(this,Nr,"f").clear(),e}return{}}}function Vr(e){var t,n;return e.type===nn.ASSIGNED_AGENT_CHANGED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.case)||void 0===n?void 0:n.id)}function Wr(e){var t,n;return e.type===nn.AGENT_TYPING_STARTED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}function $r(e){var t,n;return e.type===nn.AGENT_TYPING_ENDED&&void 0!==(null===(n=null===(t=e.data)||void 0===t?void 0:t.thread)||void 0===n?void 0:n.idOnExternalPlatform)}Ar=new WeakMap,wr=new WeakMap,Cr=new WeakMap,Sr=new WeakMap,Or=new WeakMap,br=new WeakMap,Ir=new WeakMap,Nr=new WeakMap,Rr=new WeakMap,Dr=new WeakMap,Pr=new WeakMap,kr=new WeakMap,Gr=new WeakMap,yr=new WeakSet,Mr=function(e){const t=e instanceof E?e:new E(e);if("function"!=typeof this.onError)throw t;this.onError(t)},Ur=async function(){var e,t,n;const{brandId:r,channelId:o}=ut(),i=l.ENDPOINT_GATEWAY,a=l.APP_VERSION;let c;!function(e){if(null==e)throw Error(`Expected non-nullish value, got ${e}`)}(i);const u=null!==(e=l.VISITOR_ID)&&void 0!==e?e:"";if(Kt()){const e=Qt()?Fr(this,Ar,"f").getId():null,t=Fr(this,br,"f")?l.AUTHORIZATION_CODE:void 0,n=zt()!==Lt.THIRD_PARTY,r=zt()===Lt.SECURED_COOKIES&&!Fr(this,Or,"f");try{const o=await(async(e,t,n=!1,r=!1)=>{var o,s;if(r){const e=l.CACHE_STORAGE?l.CACHE_STORAGE.getItem(On):null;if(e)return Object.assign(Object.assign({},e),{identityToken:null!==(o=Nn())&&void 0!==o?o:e.identityToken,cached:!0})}const i=n&&zt()===Lt.SECURED_COOKIES,a=Nn(),c=i&&a,u=bn(i),d=await Vt(u,function(e,t){const n={};return e&&(n.thirdParty={authorization_code:e,grant_type:"authorization_code"}),ct(t)||(n.customerIdentity={idOnExternalPlatform:t}),n}(e,t),{credentials:"include",headers:Object.assign(Object.assign({},null===(s=l.REQUEST_METADATA)||void 0===s?void 0:s.httpHeaders),c&&{Authorization:`Bearer ${a}`})});if(!d.accessToken)throw new E(We,{data:d});var h,f;return h=d,f=d.expiresIn,l.CACHE_STORAGE&&l.CACHE_STORAGE.setItem(On,h,1e3*f),d})(t,e,r,n);c=o.accessToken;const{customerIdentity:s,thirdParty:i,contact:a,identityToken:u}=o;s&&ot(Fr(this,Ar,"f"),s),i&&Pn(i),(null==a?void 0:a.customFields)&&Ke(Fr(this,Nr,"f"),a.customFields),u&&(d=u,l.IDENTITY_TOKEN=d,l.STORAGE&&l.STORAGE.setItem(In,d)),this.onAuthorization&&this.onAuthorization("success",o)}catch(e){if(function(e){var t,n;return e instanceof E&&"ip_blocked"===(null===(n=null===(t=e.data)||void 0===t?void 0:t.responseBody)||void 0===n?void 0:n.errorCode)}(e))throw"function"==typeof this.onError&&this.onError(new en($e)),new en($e);{const t=new E(We,{error:e});throw this.onAuthorization&&this.onAuthorization("error",{}),Fr(this,yr,"m",Mr).call(this,t),t}}}var d;Fr(this,kr,"f").resolve();const h=null!==(n=null===(t=l.REQUEST_METADATA)||void 0===t?void 0:t.websocketQuery)&&void 0!==n?n:{},f=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},h),{v:a,sdkPlatform:"web",sdkVersion:v,brandId:r,channelId:o}),Kt()?{}:{customerId:Fr(this,Ar,"f").getId()}),{visitorId:u}),Kt()?{transactionToken:c}:{}),_=(0,s.C)(f);try{const e=new URL(i);return e.search=_,e.toString()}catch(e){return Fr(this,yr,"m",Mr).call(this,new E(`Invalid URL: ${i}. Make sure it is a valid URL.`,{error:e})),""}},jr=async function(){try{Hr(this,Ir,Fr(this,yr,"m",Lr).call(this),"f"),await Fr(this,Ir,"f").connect()}catch(e){Fr(this,yr,"m",Mr).call(this,e)}},xr=function(e){if(e.environment===Yt.custom){if(ke(e.customEnvironment)||ct(e.customEnvironment))throw new E('customEnvironment must be provided when environment is set to "custom"');return void Zt(e.customEnvironment)}const t=Jt(e.environment);Zt(t)},Lr=function(){const e=new Vn(this.onError,Fr(this,yr,"m",Ur).bind(this));return e.on(i.nF.MESSAGE,(async e=>{try{"function"==typeof this.onRawEvent&&this.onRawEvent(e);const t=await(async(e,t)=>{if(ct(e))return null;if(!Sn(e)&&!yn(e))return e;if(yn(e))return async function(e,t){if(!1===e.data.message.hasAdditionalMessageContent||null===t)return e;try{const{brand:n,message:r,thread:o}=e.data,s=Cn(n.id,r.id),i=await _t(o.idOnExternalPlatform,s,t),a=await async function(e,t,n){var r;const o=`${l.ENDPOINT_CHAT}${Cn(t,e.id)}`,s=(null===(r=l.REQUEST_METADATA)||void 0===r?void 0:r.httpHeaders)||{},i={headers:Object.assign(Object.assign({},It(s)),{Authorization:`Bearer ${n.token}`})};try{return Bt(o,i)}catch(e){throw new E("Failed to fetch message content.",{error:e})}}(r,n.id,i);return Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{message:a})})}catch(e){throw new E("Failed to fetch additional message content",{error:e})}}(e,t);if(Sn(e))return ln(await Bt(e.data.s3Object.url));throw new E("Failed to fetch additional data for event")})((e=>{const t=null==e?void 0:e.detail;if(!t)return;let n;try{n=JSON.parse(t.data)}catch(e){return}return ln(n)})(e),Fr(this,Ir,"f")),n=Fr(this,Dr,"f").process(t);if(!ct(n)){const{type:e}=n;(e=>{const{id:t}=e;if(Me.has(t)){const n=Me.get(t);"function"==typeof n&&n(e),Me.delete(t)}})(n),Fr(this,Pr,"f").dispatchEvent(new rn(null!=e?e:"",{detail:n}))}}catch(e){Fr(this,yr,"m",Mr).call(this,e)}})),e};const zr=e=>{const t=e;return Number.isInteger(null==t?void 0:t.data.positionInQueue)&&!1===ke(null==t?void 0:t.id)&&(null==t?void 0:t.type)===c.vc.SET_POSITION_IN_QUEUE};class Qr extends E{constructor(e,t){super(e),this.data=t}}function Kr(e){return{eventType:c.ow.CREATE_GROUP_CHAT_INVITE,data:{contact:{id:e}}}}async function Yr(e,t){const n=await ht(e,t);if(function(e){return e.type===nn.GROUP_CHAT_INVITE_CREATED}(n))return n;throw new Qr("Create invitation failed",n)}function qr(e){return e instanceof E&&void 0!==(null==e?void 0:e.data)}class Jr extends E{constructor(e,t){super(e),this.data=t}}function Zr(e){return{eventType:c.ow.JOIN_GROUP_CHAT,data:{invitation:{code:e}}}}async function Xr(e,t){const n=await ht(e,t);if(function(e){return e.type===nn.GROUP_CHAT_JOINED}(n))return n;throw new Jr("Join Group chat failed",{response:n})}function eo(e){return e instanceof Jr&&qr(e)}function to(e){return{eventType:c.ow.LEAVE_GROUP_CHAT,data:{contact:{id:e}}}}async function no(e,t){return ht(e,t)}class ro extends E{constructor(e,t){super(e),this.data=t}}function oo(e,t,n){return{eventType:c.ow.SEND_EMAIL_INVITE_TO_GROUP_CHAT,data:{contact:{id:e},invitation:{code:t},recipients:[{idOnExternalPlatform:n}]}}}async function so(e,t){const n=await ht(e,t);if(function(e){return e.type===nn.GROUP_CHAT_INVITE_SENT}(n))return n;throw new ro("Send Email Invitation failed",{response:n})}class io extends Error{constructor(e){super(e),this.name="CacheStorageError"}}var ao,co,uo=function(e,t,n,r,o){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?o.call(e,n):o?o.value=n:t.set(e,n),n},lo=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class ho{constructor(e,t){if(ao.set(this,void 0),co.set(this,void 0),!(e&&e.getItem&&e.setItem&&e.removeItem))throw new io("CacheStorage: Storage is required");uo(this,ao,e,"f"),uo(this,co,null!=t?t:"","f")}getItem(e){const t=lo(this,ao,"f").getItem(lo(this,co,"f")+e);if(!t)return null;const{data:n,expiresAt:r=0}=JSON.parse(t);return r<(new Date).getTime()||ze(n)?(lo(this,ao,"f").removeItem(e),null):n}removeItem(e){lo(this,ao,"f").removeItem(lo(this,co,"f")+e)}setItem(e,t,n){const r={data:t,expiresAt:(new Date).getTime()+n};lo(this,ao,"f").setItem(lo(this,co,"f")+e,JSON.stringify(r))}}ao=new WeakMap,co=new WeakMap;var Eo=r(369);function fo(e){return"object"==typeof e&&null!==e&&"reconnected"in e&&!0===e.reconnected}async function vo(e,t,n=At(),r){const{httpHeaders:o,environment:s,customEnvironment:i,appName:a,appVersion:c}=r,u=Object.assign(Object.assign({},null!=o?o:{}),c?{"x-app-version":String(c)}:{});return $t(e,t,n,s===Yt.custom?i.chat:Jt(s).chat,u,a)}async function _o(e,t,n){const{httpHeaders:r,appName:o,appVersion:s,customEnvironment:i,environment:a}=n,c=Object.assign(Object.assign({},null!=r?r:{}),s?{"x-app-version":String(s)}:{});return Wt(e,t,a===Yt.custom?i.chat:Jt(a).chat,c,o)}const po=Br;return o})()));